1
00:00:00,520 --> 00:00:02,700

hey the TAS are going to be giving a

2
00:00:02,700 --> 00:00:02,710
hey the TAS are going to be giving a
 

3
00:00:02,710 --> 00:00:06,210
hey the TAS are going to be giving a
lecture on concurrency and go basically

4
00:00:06,210 --> 00:00:06,220
lecture on concurrency and go basically
 

5
00:00:06,220 --> 00:00:07,850
lecture on concurrency and go basically
this lecture is going to be full of

6
00:00:07,850 --> 00:00:07,860
this lecture is going to be full of
 

7
00:00:07,860 --> 00:00:10,500
this lecture is going to be full of
design patterns and practical tips to

8
00:00:10,500 --> 00:00:10,510
design patterns and practical tips to
 

9
00:00:10,510 --> 00:00:13,619
design patterns and practical tips to
help you with the labs we're going to be

10
00:00:13,619 --> 00:00:13,629
help you with the labs we're going to be
 

11
00:00:13,629 --> 00:00:15,480
help you with the labs we're going to be
covering briefly the code memory model

12
00:00:15,480 --> 00:00:15,490
covering briefly the code memory model
 

13
00:00:15,490 --> 00:00:17,160
covering briefly the code memory model
the reading which we went over and then

14
00:00:17,160 --> 00:00:17,170
the reading which we went over and then
 

15
00:00:17,170 --> 00:00:18,810
the reading which we went over and then
spend most of the lecture talking about

16
00:00:18,810 --> 00:00:18,820
spend most of the lecture talking about
 

17
00:00:18,820 --> 00:00:20,190
spend most of the lecture talking about
concurrency primitives and go

18
00:00:20,190 --> 00:00:20,200
concurrency primitives and go
 

19
00:00:20,200 --> 00:00:22,650
concurrency primitives and go
concurrency patterns and go how you do

20
00:00:22,650 --> 00:00:22,660
concurrency patterns and go how you do
 

21
00:00:22,660 --> 00:00:24,180
concurrency patterns and go how you do
things that you will need to do in the

22
00:00:24,180 --> 00:00:24,190
things that you will need to do in the
 

23
00:00:24,190 --> 00:00:26,220
things that you will need to do in the
labs and then finally we'll talk through

24
00:00:26,220 --> 00:00:26,230
labs and then finally we'll talk through
 

25
00:00:26,230 --> 00:00:27,960
labs and then finally we'll talk through
some debugging tips and techniques and

26
00:00:27,960 --> 00:00:27,970
some debugging tips and techniques and
 

27
00:00:27,970 --> 00:00:29,400
some debugging tips and techniques and
show you some interesting tools that you

28
00:00:29,400 --> 00:00:29,410
show you some interesting tools that you
 

29
00:00:29,410 --> 00:00:30,990
show you some interesting tools that you
might want to use when debugging the

30
00:00:30,990 --> 00:00:31,000
might want to use when debugging the
 

31
00:00:31,000 --> 00:00:34,560
might want to use when debugging the
labs so very briefly on the go memory

32
00:00:34,560 --> 00:00:34,570
labs so very briefly on the go memory
 

33
00:00:34,570 --> 00:00:36,630
labs so very briefly on the go memory
model on the reading so why did we

34
00:00:36,630 --> 00:00:36,640
model on the reading so why did we
 

35
00:00:36,640 --> 00:00:38,819
model on the reading so why did we
assign this reading well the goal was to

36
00:00:38,819 --> 00:00:38,829
assign this reading well the goal was to
 

37
00:00:38,829 --> 00:00:40,860
assign this reading well the goal was to
give you some concrete examples of

38
00:00:40,860 --> 00:00:40,870
give you some concrete examples of
 

39
00:00:40,870 --> 00:00:43,139
give you some concrete examples of
correct ways to write threaded code and

40
00:00:43,139 --> 00:00:43,149
correct ways to write threaded code and
 

41
00:00:43,149 --> 00:00:45,330
correct ways to write threaded code and
go so the document like in the second

42
00:00:45,330 --> 00:00:45,340
go so the document like in the second
 

43
00:00:45,340 --> 00:00:46,350
go so the document like in the second
half of the document has some examples

44
00:00:46,350 --> 00:00:46,360
half of the document has some examples
 

45
00:00:46,360 --> 00:00:48,450
half of the document has some examples
of crack code and an incorrect code and

46
00:00:48,450 --> 00:00:48,460
of crack code and an incorrect code and
 

47
00:00:48,460 --> 00:00:51,120
of crack code and an incorrect code and
how it can go wrong so one thing you

48
00:00:51,120 --> 00:00:51,130
how it can go wrong so one thing you
 

49
00:00:51,130 --> 00:00:52,799
how it can go wrong so one thing you
might have noticed in the document is

50
00:00:52,799 --> 00:00:52,809
might have noticed in the document is
 

51
00:00:52,809 --> 00:00:54,780
might have noticed in the document is
early on it says if you need to read and

52
00:00:54,780 --> 00:00:54,790
early on it says if you need to read and
 

53
00:00:54,790 --> 00:00:56,280
early on it says if you need to read and
understand this you're being too clever

54
00:00:56,280 --> 00:00:56,290
understand this you're being too clever
 

55
00:00:56,290 --> 00:00:58,580
understand this you're being too clever
and we think that that's good advice so

56
00:00:58,580 --> 00:00:58,590
and we think that that's good advice so
 

57
00:00:58,590 --> 00:01:01,410
and we think that that's good advice so
focus on how to write correct code don't

58
00:01:01,410 --> 00:01:01,420
focus on how to write correct code don't
 

59
00:01:01,420 --> 00:01:03,299
focus on how to write correct code don't
focus way too much on the happens before

60
00:01:03,299 --> 00:01:03,309
focus way too much on the happens before
 

61
00:01:03,309 --> 00:01:04,949
focus way too much on the happens before
relation and being able to reason about

62
00:01:04,949 --> 00:01:04,959
relation and being able to reason about
 

63
00:01:04,959 --> 00:01:06,809
relation and being able to reason about
exactly why incorrect code is incorrect

64
00:01:06,809 --> 00:01:06,819
exactly why incorrect code is incorrect
 

65
00:01:06,819 --> 00:01:08,309
exactly why incorrect code is incorrect
like we don't really care we just want

66
00:01:08,309 --> 00:01:08,319
like we don't really care we just want
 

67
00:01:08,319 --> 00:01:09,359
like we don't really care we just want
to be able to write correct code and

68
00:01:09,359 --> 00:01:09,369
to be able to write correct code and
 

69
00:01:09,369 --> 00:01:10,429
to be able to write correct code and
call it a day

70
00:01:10,429 --> 00:01:10,439
call it a day
 

71
00:01:10,439 --> 00:01:13,949
call it a day
one question that came up in the lecture

72
00:01:13,949 --> 00:01:13,959
one question that came up in the lecture
 

73
00:01:13,959 --> 00:01:16,529
one question that came up in the lecture
questions was like talking about

74
00:01:16,529 --> 00:01:16,539
questions was like talking about
 

75
00:01:16,539 --> 00:01:18,449
questions was like talking about
goroutines in relation to performance

76
00:01:18,449 --> 00:01:18,459
goroutines in relation to performance
 

77
00:01:18,459 --> 00:01:20,789
goroutines in relation to performance
and so we just wanted to say that

78
00:01:20,789 --> 00:01:20,799
and so we just wanted to say that
 

79
00:01:20,799 --> 00:01:22,469
and so we just wanted to say that
goroutines and like in general

80
00:01:22,469 --> 00:01:22,479
goroutines and like in general
 

81
00:01:22,479 --> 00:01:24,899
goroutines and like in general
concurrency can be used for a couple

82
00:01:24,899 --> 00:01:24,909
concurrency can be used for a couple
 

83
00:01:24,909 --> 00:01:26,789
concurrency can be used for a couple
different reasons and the reason we use

84
00:01:26,789 --> 00:01:26,799
different reasons and the reason we use
 

85
00:01:26,799 --> 00:01:28,980
different reasons and the reason we use
concurrency in the labs is not

86
00:01:28,980 --> 00:01:28,990
concurrency in the labs is not
 

87
00:01:28,990 --> 00:01:30,899
concurrency in the labs is not
necessarily for performance like we're

88
00:01:30,899 --> 00:01:30,909
necessarily for performance like we're
 

89
00:01:30,909 --> 00:01:33,300
necessarily for performance like we're
not going for parallelism using multiple

90
00:01:33,300 --> 00:01:33,310
not going for parallelism using multiple
 

91
00:01:33,310 --> 00:01:34,830
not going for parallelism using multiple
cores on a single machine in order to be

92
00:01:34,830 --> 00:01:34,840
cores on a single machine in order to be
 

93
00:01:34,840 --> 00:01:36,300
cores on a single machine in order to be
able to do more work on the CPU

94
00:01:36,300 --> 00:01:36,310
able to do more work on the CPU
 

95
00:01:36,310 --> 00:01:38,099
able to do more work on the CPU
concurrency gets us something else

96
00:01:38,099 --> 00:01:38,109
concurrency gets us something else
 

97
00:01:38,109 --> 00:01:40,410
concurrency gets us something else
besides performance through parallelism

98
00:01:40,410 --> 00:01:40,420
besides performance through parallelism
 

99
00:01:40,420 --> 00:01:42,629
besides performance through parallelism
it can get us better expert Civet ii

100
00:01:42,629 --> 00:01:42,639
it can get us better expert Civet ii
 

101
00:01:42,639 --> 00:01:43,889
it can get us better expert Civet ii
like we want to write down some ideas

102
00:01:43,889 --> 00:01:43,899
like we want to write down some ideas
 

103
00:01:43,899 --> 00:01:46,409
like we want to write down some ideas
and it happens to be that writing down

104
00:01:46,409 --> 00:01:46,419
and it happens to be that writing down
 

105
00:01:46,419 --> 00:01:48,659
and it happens to be that writing down
code that uses threads is a clean way of

106
00:01:48,659 --> 00:01:48,669
code that uses threads is a clean way of
 

107
00:01:48,669 --> 00:01:51,389
code that uses threads is a clean way of
expressing those ideas and so the

108
00:01:51,389 --> 00:01:51,399
expressing those ideas and so the
 

109
00:01:51,399 --> 00:01:52,949
expressing those ideas and so the
takeaway from that is when you use

110
00:01:52,949 --> 00:01:52,959
takeaway from that is when you use
 

111
00:01:52,959 --> 00:01:55,919
takeaway from that is when you use
threads in lab 2 and Beyond don't try to

112
00:01:55,919 --> 00:01:55,929
threads in lab 2 and Beyond don't try to
 

113
00:01:55,929 --> 00:01:57,330
threads in lab 2 and Beyond don't try to
do fancy things you might do if you're

114
00:01:57,330 --> 00:01:57,340
do fancy things you might do if you're
 

115
00:01:57,340 --> 00:01:59,159
do fancy things you might do if you're
going for performance especially CPU

116
00:01:59,159 --> 00:01:59,169
going for performance especially CPU
 

117
00:01:59,169 --> 00:02:00,809
going for performance especially CPU
performance like we don't care to do

118
00:02:00,809 --> 00:02:00,819
performance like we don't care to do
 

119
00:02:00,819 --> 00:02:02,429
performance like we don't care to do
things like using fine-grained locking

120
00:02:02,429 --> 00:02:02,439
things like using fine-grained locking
 

121
00:02:02,439 --> 00:02:06,089
things like using fine-grained locking
or other techniques use basically write

122
00:02:06,089 --> 00:02:06,099
or other techniques use basically write
 

123
00:02:06,099 --> 00:02:08,339
or other techniques use basically write
code that's easy to reason about use big

124
00:02:08,339 --> 00:02:08,349
code that's easy to reason about use big
 

125
00:02:08,349 --> 00:02:10,350
code that's easy to reason about use big
locks to protect large critical sections

126
00:02:10,350 --> 00:02:10,360
locks to protect large critical sections
 

127
00:02:10,360 --> 00:02:12,330
locks to protect large critical sections
and just like don't worry about

128
00:02:12,330 --> 00:02:12,340
and just like don't worry about
 

129
00:02:12,340 --> 00:02:13,890
and just like don't worry about
performance in the sense of CPU

130
00:02:13,890 --> 00:02:13,900
performance in the sense of CPU
 

131
00:02:13,900 --> 00:02:16,530
performance in the sense of CPU
performance

132
00:02:16,530 --> 00:02:16,540

 

133
00:02:16,540 --> 00:02:18,789

so with that that's all we're going to

134
00:02:18,789 --> 00:02:18,799
so with that that's all we're going to
 

135
00:02:18,799 --> 00:02:20,350
so with that that's all we're going to
say about the memory model and spend

136
00:02:20,350 --> 00:02:20,360
say about the memory model and spend
 

137
00:02:20,360 --> 00:02:22,020
say about the memory model and spend
most of this lecture just talking about

138
00:02:22,020 --> 00:02:22,030
most of this lecture just talking about
 

139
00:02:22,030 --> 00:02:25,570
most of this lecture just talking about
go code and go concurrency patterns and

140
00:02:25,570 --> 00:02:25,580
go code and go concurrency patterns and
 

141
00:02:25,580 --> 00:02:27,250
go code and go concurrency patterns and
as we go through these examples feel

142
00:02:27,250 --> 00:02:27,260
as we go through these examples feel
 

143
00:02:27,260 --> 00:02:28,630
as we go through these examples feel
free to ask any questions about what's

144
00:02:28,630 --> 00:02:28,640
free to ask any questions about what's
 

145
00:02:28,640 --> 00:02:29,800
free to ask any questions about what's
on the screen or anything else you might

146
00:02:29,800 --> 00:02:29,810
on the screen or anything else you might
 

147
00:02:29,810 --> 00:02:32,740
on the screen or anything else you might
think about so I'm going to start off

148
00:02:32,740 --> 00:02:32,750
think about so I'm going to start off
 

149
00:02:32,750 --> 00:02:34,960
think about so I'm going to start off
talking about concurrency primitives and

150
00:02:34,960 --> 00:02:34,970
talking about concurrency primitives and
 

151
00:02:34,970 --> 00:02:37,869
talking about concurrency primitives and
go so the first thing is closures this

152
00:02:37,869 --> 00:02:37,879
go so the first thing is closures this
 

153
00:02:37,879 --> 00:02:38,800
go so the first thing is closures this
is something that will almost certainly

154
00:02:38,800 --> 00:02:38,810
is something that will almost certainly
 

155
00:02:38,810 --> 00:02:41,860
is something that will almost certainly
be helpful in the labs and this is

156
00:02:41,860 --> 00:02:41,870
be helpful in the labs and this is
 

157
00:02:41,870 --> 00:02:44,350
be helpful in the labs and this is
related to go routines so here's this

158
00:02:44,350 --> 00:02:44,360
related to go routines so here's this
 

159
00:02:44,360 --> 00:02:46,420
related to go routines so here's this
example program on the screen and what

160
00:02:46,420 --> 00:02:46,430
example program on the screen and what
 

161
00:02:46,430 --> 00:02:48,460
example program on the screen and what
it does is the main function declares a

162
00:02:48,460 --> 00:02:48,470
it does is the main function declares a
 

163
00:02:48,470 --> 00:02:50,229
it does is the main function declares a
bunch of variables and then spawns this

164
00:02:50,229 --> 00:02:50,239
bunch of variables and then spawns this
 

165
00:02:50,239 --> 00:02:51,550
bunch of variables and then spawns this
go routine in here with this go

166
00:02:51,550 --> 00:02:51,560
go routine in here with this go
 

167
00:02:51,560 --> 00:02:53,380
go routine in here with this go
statement and we noticed that the score

168
00:02:53,380 --> 00:02:53,390
statement and we noticed that the score
 

169
00:02:53,390 --> 00:02:55,300
statement and we noticed that the score
routine is not taking it as an argument

170
00:02:55,300 --> 00:02:55,310
routine is not taking it as an argument
 

171
00:02:55,310 --> 00:02:57,640
routine is not taking it as an argument
a function call to some function defined

172
00:02:57,640 --> 00:02:57,650
a function call to some function defined
 

173
00:02:57,650 --> 00:02:59,170
a function call to some function defined
elsewhere but this anonymous function

174
00:02:59,170 --> 00:02:59,180
elsewhere but this anonymous function
 

175
00:02:59,180 --> 00:03:01,390
elsewhere but this anonymous function
just defined in line here so this is a

176
00:03:01,390 --> 00:03:01,400
just defined in line here so this is a
 

177
00:03:01,400 --> 00:03:02,770
just defined in line here so this is a
handy pattern this is something called a

178
00:03:02,770 --> 00:03:02,780
handy pattern this is something called a
 

179
00:03:02,780 --> 00:03:04,750
handy pattern this is something called a
closure and one neat thing about this is

180
00:03:04,750 --> 00:03:04,760
closure and one neat thing about this is
 

181
00:03:04,760 --> 00:03:06,819
closure and one neat thing about this is
that this function that's defined here

182
00:03:06,819 --> 00:03:06,829
that this function that's defined here
 

183
00:03:06,829 --> 00:03:08,470
that this function that's defined here
can refer to variables from the

184
00:03:08,470 --> 00:03:08,480
can refer to variables from the
 

185
00:03:08,480 --> 00:03:10,599
can refer to variables from the
enclosing scope so for example this

186
00:03:10,599 --> 00:03:10,609
enclosing scope so for example this
 

187
00:03:10,609 --> 00:03:12,699
enclosing scope so for example this
function can mutate this variable a

188
00:03:12,699 --> 00:03:12,709
function can mutate this variable a
 

189
00:03:12,709 --> 00:03:15,640
function can mutate this variable a
that's defined up here or refer to this

190
00:03:15,640 --> 00:03:15,650
that's defined up here or refer to this
 

191
00:03:15,650 --> 00:03:19,539
that's defined up here or refer to this
weight group that's defined up here so

192
00:03:19,539 --> 00:03:19,549
weight group that's defined up here so
 

193
00:03:19,549 --> 00:03:23,470
weight group that's defined up here so
if we go run this example it does what

194
00:03:23,470 --> 00:03:23,480
if we go run this example it does what
 

195
00:03:23,480 --> 00:03:24,129
if we go run this example it does what
you think it does

196
00:03:24,129 --> 00:03:24,139
you think it does
 

197
00:03:24,139 --> 00:03:27,970
you think it does
the weight group dot done here let's the

198
00:03:27,970 --> 00:03:27,980
the weight group dot done here let's the
 

199
00:03:27,980 --> 00:03:29,409
the weight group dot done here let's the
main thread continue past this point it

200
00:03:29,409 --> 00:03:29,419
main thread continue past this point it
 

201
00:03:29,419 --> 00:03:30,670
main thread continue past this point it
prints out this variable which has been

202
00:03:30,670 --> 00:03:30,680
prints out this variable which has been
 

203
00:03:30,680 --> 00:03:32,319
prints out this variable which has been
mutated by this concurrently running

204
00:03:32,319 --> 00:03:32,329
mutated by this concurrently running
 

205
00:03:32,329 --> 00:03:34,390
mutated by this concurrently running
thread that finished before this weight

206
00:03:34,390 --> 00:03:34,400
thread that finished before this weight
 

207
00:03:34,400 --> 00:03:38,680
thread that finished before this weight
happened so this is a useful pattern to

208
00:03:38,680 --> 00:03:38,690
happened so this is a useful pattern to
 

209
00:03:38,690 --> 00:03:41,740
happened so this is a useful pattern to
be able to use one like the reason we're

210
00:03:41,740 --> 00:03:41,750
be able to use one like the reason we're
 

211
00:03:41,750 --> 00:03:46,539
be able to use one like the reason we're
pointing this out is because you might

212
00:03:46,539 --> 00:03:46,549
pointing this out is because you might
 

213
00:03:46,549 --> 00:03:47,710
pointing this out is because you might
have code that looks like this in your

214
00:03:47,710 --> 00:03:47,720
have code that looks like this in your
 

215
00:03:47,720 --> 00:03:50,080
have code that looks like this in your
labs very similar to the previous

216
00:03:50,080 --> 00:03:50,090
labs very similar to the previous
 

217
00:03:50,090 --> 00:03:52,180
labs very similar to the previous
example except this is code that is

218
00:03:52,180 --> 00:03:52,190
example except this is code that is
 

219
00:03:52,190 --> 00:03:53,620
example except this is code that is
spawning a bunch of threads in a loop

220
00:03:53,620 --> 00:03:53,630
spawning a bunch of threads in a loop
 

221
00:03:53,630 --> 00:03:55,960
spawning a bunch of threads in a loop
this is useful for example when you want

222
00:03:55,960 --> 00:03:55,970
this is useful for example when you want
 

223
00:03:55,970 --> 00:03:58,270
this is useful for example when you want
to send our pcs in parallel right so

224
00:03:58,270 --> 00:03:58,280
to send our pcs in parallel right so
 

225
00:03:58,280 --> 00:04:00,909
to send our pcs in parallel right so
like in lab two if you have a candidate

226
00:04:00,909 --> 00:04:00,919
like in lab two if you have a candidate
 

227
00:04:00,919 --> 00:04:02,530
like in lab two if you have a candidate
asking for votes you want to ask for

228
00:04:02,530 --> 00:04:02,540
asking for votes you want to ask for
 

229
00:04:02,540 --> 00:04:04,240
asking for votes you want to ask for
votes from all the followers in parallel

230
00:04:04,240 --> 00:04:04,250
votes from all the followers in parallel
 

231
00:04:04,250 --> 00:04:06,159
votes from all the followers in parallel
not one after the other because the RPC

232
00:04:06,159 --> 00:04:06,169
not one after the other because the RPC
 

233
00:04:06,169 --> 00:04:07,449
not one after the other because the RPC
is a blocking operation that might take

234
00:04:07,449 --> 00:04:07,459
is a blocking operation that might take
 

235
00:04:07,459 --> 00:04:09,460
is a blocking operation that might take
some time or similarly the leader might

236
00:04:09,460 --> 00:04:09,470
some time or similarly the leader might
 

237
00:04:09,470 --> 00:04:10,900
some time or similarly the leader might
want to send append entries to all the

238
00:04:10,900 --> 00:04:10,910
want to send append entries to all the
 

239
00:04:10,910 --> 00:04:12,460
want to send append entries to all the
followers you want to do it in parallel

240
00:04:12,460 --> 00:04:12,470
followers you want to do it in parallel
 

241
00:04:12,470 --> 00:04:14,530
followers you want to do it in parallel
not in series and so threads are a clean

242
00:04:14,530 --> 00:04:14,540
not in series and so threads are a clean
 

243
00:04:14,540 --> 00:04:17,050
not in series and so threads are a clean
way to express this idea and so you

244
00:04:17,050 --> 00:04:17,060
way to express this idea and so you
 

245
00:04:17,060 --> 00:04:18,430
way to express this idea and so you
might have code that looks kind of like

246
00:04:18,430 --> 00:04:18,440
might have code that looks kind of like
 

247
00:04:18,440 --> 00:04:20,620
might have code that looks kind of like
this at a high level in a for loop you

248
00:04:20,620 --> 00:04:20,630
this at a high level in a for loop you
 

249
00:04:20,630 --> 00:04:23,740
this at a high level in a for loop you
spawn a bunch of go routines one thing

250
00:04:23,740 --> 00:04:23,750
spawn a bunch of go routines one thing
 

251
00:04:23,750 --> 00:04:24,850
spawn a bunch of go routines one thing
to be careful about here this is

252
00:04:24,850 --> 00:04:24,860
to be careful about here this is
 

253
00:04:24,860 --> 00:04:26,080
to be careful about here this is
something that was talked about in a

254
00:04:26,080 --> 00:04:26,090
something that was talked about in a
 

255
00:04:26,090 --> 00:04:27,450
something that was talked about in a
previous lecture

256
00:04:27,450 --> 00:04:27,460
previous lecture
 

257
00:04:27,460 --> 00:04:31,050
previous lecture
is identifier capture and goroutines and

258
00:04:31,050 --> 00:04:31,060
is identifier capture and goroutines and
 

259
00:04:31,060 --> 00:04:33,240
is identifier capture and goroutines and
mutation of that identifier in the outer

260
00:04:33,240 --> 00:04:33,250
mutation of that identifier in the outer
 

261
00:04:33,250 --> 00:04:35,070
mutation of that identifier in the outer
scope so we see here that we have this

262
00:04:35,070 --> 00:04:35,080
scope so we see here that we have this
 

263
00:04:35,080 --> 00:04:36,990
scope so we see here that we have this
eye that's being mutated by this for

264
00:04:36,990 --> 00:04:37,000
eye that's being mutated by this for
 

265
00:04:37,000 --> 00:04:38,999
eye that's being mutated by this for
loop and then we want to use that value

266
00:04:38,999 --> 00:04:39,009
loop and then we want to use that value
 

267
00:04:39,009 --> 00:04:41,430
loop and then we want to use that value
inside the square root een and the way

268
00:04:41,430 --> 00:04:41,440
inside the square root een and the way
 

269
00:04:41,440 --> 00:04:42,600
inside the square root een and the way
we do that like the correct way of

270
00:04:42,600 --> 00:04:42,610
we do that like the correct way of
 

271
00:04:42,610 --> 00:04:44,730
we do that like the correct way of
writing this code is to pass this value

272
00:04:44,730 --> 00:04:44,740
writing this code is to pass this value
 

273
00:04:44,740 --> 00:04:46,710
writing this code is to pass this value
I as an argument to this function and

274
00:04:46,710 --> 00:04:46,720
I as an argument to this function and
 

275
00:04:46,720 --> 00:04:49,290
I as an argument to this function and
this function or you can rename it to X

276
00:04:49,290 --> 00:04:49,300
this function or you can rename it to X
 

277
00:04:49,300 --> 00:04:50,939
this function or you can rename it to X
inside here and then use the value

278
00:04:50,939 --> 00:04:50,949
inside here and then use the value
 

279
00:04:50,949 --> 00:04:53,210
inside here and then use the value
inside and so if we run this program

280
00:04:53,210 --> 00:04:53,220
inside and so if we run this program
 

281
00:04:53,220 --> 00:04:55,620
inside and so if we run this program
so here I've kind of stubbed out to send

282
00:04:55,620 --> 00:04:55,630
so here I've kind of stubbed out to send
 

283
00:04:55,630 --> 00:04:57,029
so here I've kind of stubbed out to send
our PC thing was actually just prints

284
00:04:57,029 --> 00:04:57,039
our PC thing was actually just prints
 

285
00:04:57,039 --> 00:04:59,670
our PC thing was actually just prints
out the index this I might be like the

286
00:04:59,670 --> 00:04:59,680
out the index this I might be like the
 

287
00:04:59,680 --> 00:05:01,439
out the index this I might be like the
index of the follower trying to send an

288
00:05:01,439 --> 00:05:01,449
index of the follower trying to send an
 

289
00:05:01,449 --> 00:05:04,439
index of the follower trying to send an
RPC to here prints out the numbers 0

290
00:05:04,439 --> 00:05:04,449
RPC to here prints out the numbers 0
 

291
00:05:04,449 --> 00:05:06,120
RPC to here prints out the numbers 0
through 4 in some order so this is what

292
00:05:06,120 --> 00:05:06,130
through 4 in some order so this is what
 

293
00:05:06,130 --> 00:05:07,830
through 4 in some order so this is what
we want like send our PCs to all the

294
00:05:07,830 --> 00:05:07,840
we want like send our PCs to all the
 

295
00:05:07,840 --> 00:05:09,629
we want like send our PCs to all the
followers the reason we're showing you

296
00:05:09,629 --> 00:05:09,639
followers the reason we're showing you
 

297
00:05:09,639 --> 00:05:11,219
followers the reason we're showing you
this code is because there's a variation

298
00:05:11,219 --> 00:05:11,229
this code is because there's a variation
 

299
00:05:11,229 --> 00:05:13,740
this code is because there's a variation
of this code which looks really similar

300
00:05:13,740 --> 00:05:13,750
of this code which looks really similar
 

301
00:05:13,750 --> 00:05:15,360
of this code which looks really similar
and maybe intuitively you might think it

302
00:05:15,360 --> 00:05:15,370
and maybe intuitively you might think it
 

303
00:05:15,370 --> 00:05:16,529
and maybe intuitively you might think it
does the right thing but in fact it

304
00:05:16,529 --> 00:05:16,539
does the right thing but in fact it
 

305
00:05:16,539 --> 00:05:18,300
does the right thing but in fact it
doesn't so in this code the only thing

306
00:05:18,300 --> 00:05:18,310
doesn't so in this code the only thing
 

307
00:05:18,310 --> 00:05:21,510
doesn't so in this code the only thing
that's changed is we've gotten rid of

308
00:05:21,510 --> 00:05:21,520
that's changed is we've gotten rid of
 

309
00:05:21,520 --> 00:05:23,460
that's changed is we've gotten rid of
this argument here that we're explicitly

310
00:05:23,460 --> 00:05:23,470
this argument here that we're explicitly
 

311
00:05:23,470 --> 00:05:26,430
this argument here that we're explicitly
passing and instead we're letting this I

312
00:05:26,430 --> 00:05:26,440
passing and instead we're letting this I
 

313
00:05:26,440 --> 00:05:29,279
passing and instead we're letting this I
refer to the eye from the outer scope so

314
00:05:29,279 --> 00:05:29,289
refer to the eye from the outer scope so
 

315
00:05:29,289 --> 00:05:30,240
refer to the eye from the outer scope so
you might think that when you run this

316
00:05:30,240 --> 00:05:30,250
you might think that when you run this
 

317
00:05:30,250 --> 00:05:33,570
you might think that when you run this
it does the same thing but in fact in

318
00:05:33,570 --> 00:05:33,580
it does the same thing but in fact in
 

319
00:05:33,580 --> 00:05:35,839
it does the same thing but in fact in
this particular run it printed 4 5 5 5 5

320
00:05:35,839 --> 00:05:35,849
this particular run it printed 4 5 5 5 5
 

321
00:05:35,849 --> 00:05:39,570
this particular run it printed 4 5 5 5 5
so this would do the wrong thing and the

322
00:05:39,570 --> 00:05:39,580
so this would do the wrong thing and the
 

323
00:05:39,580 --> 00:05:41,490
so this would do the wrong thing and the
reason for this is that this I is being

324
00:05:41,490 --> 00:05:41,500
reason for this is that this I is being
 

325
00:05:41,500 --> 00:05:43,740
reason for this is that this I is being
mutated by this outer scope and by the

326
00:05:43,740 --> 00:05:43,750
mutated by this outer scope and by the
 

327
00:05:43,750 --> 00:05:45,180
mutated by this outer scope and by the
time this go routine ends up actually

328
00:05:45,180 --> 00:05:45,190
time this go routine ends up actually
 

329
00:05:45,190 --> 00:05:47,250
time this go routine ends up actually
executing this line well the for loop

330
00:05:47,250 --> 00:05:47,260
executing this line well the for loop
 

331
00:05:47,260 --> 00:05:49,589
executing this line well the for loop
has already changed the value of I so

332
00:05:49,589 --> 00:05:49,599
has already changed the value of I so
 

333
00:05:49,599 --> 00:05:52,439
has already changed the value of I so
this doesn't do the right thing so at a

334
00:05:52,439 --> 00:05:52,449
this doesn't do the right thing so at a
 

335
00:05:52,449 --> 00:05:54,930
this doesn't do the right thing so at a
high level if you're spawning goroutines

336
00:05:54,930 --> 00:05:54,940
high level if you're spawning goroutines
 

337
00:05:54,940 --> 00:05:57,510
high level if you're spawning goroutines
in a loop just make sure that you use

338
00:05:57,510 --> 00:05:57,520
in a loop just make sure that you use
 

339
00:05:57,520 --> 00:06:00,450
in a loop just make sure that you use
this pattern here and everything will

340
00:06:00,450 --> 00:06:00,460
this pattern here and everything will
 

341
00:06:00,460 --> 00:06:03,050
this pattern here and everything will
work right any questions about that

342
00:06:03,050 --> 00:06:03,060
work right any questions about that
 

343
00:06:03,060 --> 00:06:05,070
work right any questions about that
so it's just like a small gotcha but

344
00:06:05,070 --> 00:06:05,080
so it's just like a small gotcha but
 

345
00:06:05,080 --> 00:06:06,089
so it's just like a small gotcha but
we've seen this a whole bunch of times

346
00:06:06,089 --> 00:06:06,099
we've seen this a whole bunch of times
 

347
00:06:06,099 --> 00:06:07,170
we've seen this a whole bunch of times
in office hours so I just wanted to

348
00:06:07,170 --> 00:06:07,180
in office hours so I just wanted to
 

349
00:06:07,180 --> 00:06:10,710
in office hours so I just wanted to
point this out all right so moving on to

350
00:06:10,710 --> 00:06:10,720
point this out all right so moving on to
 

351
00:06:10,720 --> 00:06:13,409
point this out all right so moving on to
other patterns that you might want to

352
00:06:13,409 --> 00:06:13,419
other patterns that you might want to
 

353
00:06:13,419 --> 00:06:17,490
other patterns that you might want to
use in your code oftentimes you want

354
00:06:17,490 --> 00:06:17,500
use in your code oftentimes you want
 

355
00:06:17,500 --> 00:06:19,290
use in your code oftentimes you want
code that periodically does something a

356
00:06:19,290 --> 00:06:19,300
code that periodically does something a
 

357
00:06:19,300 --> 00:06:22,379
code that periodically does something a
very simple way to do that is to have a

358
00:06:22,379 --> 00:06:22,389
very simple way to do that is to have a
 

359
00:06:22,389 --> 00:06:24,719
very simple way to do that is to have a
separate function that in an infinite

360
00:06:24,719 --> 00:06:24,729
separate function that in an infinite
 

361
00:06:24,729 --> 00:06:26,939
separate function that in an infinite
loop does something in this case we're

362
00:06:26,939 --> 00:06:26,949
loop does something in this case we're
 

363
00:06:26,949 --> 00:06:29,460
loop does something in this case we're
just printing out tick and then use this

364
00:06:29,460 --> 00:06:29,470
just printing out tick and then use this
 

365
00:06:29,470 --> 00:06:31,230
just printing out tick and then use this
time dot sleep to wait for a certain

366
00:06:31,230 --> 00:06:31,240
time dot sleep to wait for a certain
 

367
00:06:31,240 --> 00:06:34,409
time dot sleep to wait for a certain
amount of time so very simple pattern

368
00:06:34,409 --> 00:06:34,419
amount of time so very simple pattern
 

369
00:06:34,419 --> 00:06:34,740
amount of time so very simple pattern
here

370
00:06:34,740 --> 00:06:34,750
here
 

371
00:06:34,750 --> 00:06:36,060
here
you don't need anything fancier than

372
00:06:36,060 --> 00:06:36,070
you don't need anything fancier than
 

373
00:06:36,070 --> 00:06:41,390
you don't need anything fancier than
this to do something periodically

374
00:06:41,390 --> 00:06:41,400

 

375
00:06:41,400 --> 00:06:43,740

one modification of this that you might

376
00:06:43,740 --> 00:06:43,750
one modification of this that you might
 

377
00:06:43,750 --> 00:06:44,970
one modification of this that you might
want is you want to do something

378
00:06:44,970 --> 00:06:44,980
want is you want to do something
 

379
00:06:44,980 --> 00:06:47,460
want is you want to do something
periodically until something happens for

380
00:06:47,460 --> 00:06:47,470
periodically until something happens for
 

381
00:06:47,470 --> 00:06:49,260
periodically until something happens for
example you might want to start up a

382
00:06:49,260 --> 00:06:49,270
example you might want to start up a
 

383
00:06:49,270 --> 00:06:51,270
example you might want to start up a
raft here and then periodically send

384
00:06:51,270 --> 00:06:51,280
raft here and then periodically send
 

385
00:06:51,280 --> 00:06:54,840
raft here and then periodically send
heartbeats but when we call dot kill on

386
00:06:54,840 --> 00:06:54,850
heartbeats but when we call dot kill on
 

387
00:06:54,850 --> 00:06:56,790
heartbeats but when we call dot kill on
the raft instance you want to actually

388
00:06:56,790 --> 00:06:56,800
the raft instance you want to actually
 

389
00:06:56,800 --> 00:06:58,170
the raft instance you want to actually
shut down all these goroutines so you

390
00:06:58,170 --> 00:06:58,180
shut down all these goroutines so you
 

391
00:06:58,180 --> 00:06:59,310
shut down all these goroutines so you
don't have all these random goroutines

392
00:06:59,310 --> 00:06:59,320
don't have all these random goroutines
 

393
00:06:59,320 --> 00:07:01,770
don't have all these random goroutines
still running in the background and so

394
00:07:01,770 --> 00:07:01,780
still running in the background and so
 

395
00:07:01,780 --> 00:07:03,000
still running in the background and so
the pattern for that looks something

396
00:07:03,000 --> 00:07:03,010
the pattern for that looks something
 

397
00:07:03,010 --> 00:07:08,190
the pattern for that looks something
like this you have a goroutine that will

398
00:07:08,190 --> 00:07:08,200
like this you have a goroutine that will
 

399
00:07:08,200 --> 00:07:10,740
like this you have a goroutine that will
run in an infinite loop and do something

400
00:07:10,740 --> 00:07:10,750
run in an infinite loop and do something
 

401
00:07:10,750 --> 00:07:13,230
run in an infinite loop and do something
and then wait for a little bit and then

402
00:07:13,230 --> 00:07:13,240
and then wait for a little bit and then
 

403
00:07:13,240 --> 00:07:14,130
and then wait for a little bit and then
you can just have a shared variable

404
00:07:14,130 --> 00:07:14,140
you can just have a shared variable
 

405
00:07:14,140 --> 00:07:16,560
you can just have a shared variable
between whatever control thread is going

406
00:07:16,560 --> 00:07:16,570
between whatever control thread is going
 

407
00:07:16,570 --> 00:07:18,060
between whatever control thread is going
to decide whether this goroutine should

408
00:07:18,060 --> 00:07:18,070
to decide whether this goroutine should
 

409
00:07:18,070 --> 00:07:20,160
to decide whether this goroutine should
die or not so in this example we have

410
00:07:20,160 --> 00:07:20,170
die or not so in this example we have
 

411
00:07:20,170 --> 00:07:21,660
die or not so in this example we have
this variable done that's a global

412
00:07:21,660 --> 00:07:21,670
this variable done that's a global
 

413
00:07:21,670 --> 00:07:23,550
this variable done that's a global
variable and what main does is it waits

414
00:07:23,550 --> 00:07:23,560
variable and what main does is it waits
 

415
00:07:23,560 --> 00:07:26,970
variable and what main does is it waits
for awhile and sets done to true and in

416
00:07:26,970 --> 00:07:26,980
for awhile and sets done to true and in
 

417
00:07:26,980 --> 00:07:28,620
for awhile and sets done to true and in
this go routine that's ticking and doing

418
00:07:28,620 --> 00:07:28,630
this go routine that's ticking and doing
 

419
00:07:28,630 --> 00:07:30,990
this go routine that's ticking and doing
work periodically we're just checking

420
00:07:30,990 --> 00:07:31,000
work periodically we're just checking
 

421
00:07:31,000 --> 00:07:32,640
work periodically we're just checking
the value of done and if done is set

422
00:07:32,640 --> 00:07:32,650
the value of done and if done is set
 

423
00:07:32,650 --> 00:07:34,230
the value of done and if done is set
then we terminate the square-root eeen

424
00:07:34,230 --> 00:07:34,240
then we terminate the square-root eeen
 

425
00:07:34,240 --> 00:07:38,100
then we terminate the square-root eeen
and here since done is a shared variable

426
00:07:38,100 --> 00:07:38,110
and here since done is a shared variable
 

427
00:07:38,110 --> 00:07:40,170
and here since done is a shared variable
being mutated and read by multiple

428
00:07:40,170 --> 00:07:40,180
being mutated and read by multiple
 

429
00:07:40,180 --> 00:07:41,670
being mutated and read by multiple
threads we need to make sure that we

430
00:07:41,670 --> 00:07:41,680
threads we need to make sure that we
 

431
00:07:41,680 --> 00:07:44,610
threads we need to make sure that we
guard the use of this with a lock so

432
00:07:44,610 --> 00:07:44,620
guard the use of this with a lock so
 

433
00:07:44,620 --> 00:07:45,930
guard the use of this with a lock so
that's where this mute outlaw can mute

434
00:07:45,930 --> 00:07:45,940
that's where this mute outlaw can mute
 

435
00:07:45,940 --> 00:07:49,050
that's where this mute outlaw can mute
it unlock comes in for the purpose of

436
00:07:49,050 --> 00:07:49,060
it unlock comes in for the purpose of
 

437
00:07:49,060 --> 00:07:50,190
it unlock comes in for the purpose of
the labs you can actually write

438
00:07:50,190 --> 00:07:50,200
the labs you can actually write
 

439
00:07:50,200 --> 00:07:51,330
the labs you can actually write
something a little bit simpler than this

440
00:07:51,330 --> 00:07:51,340
something a little bit simpler than this
 

441
00:07:51,340 --> 00:07:55,470
something a little bit simpler than this
so we have this method RF killed on your

442
00:07:55,470 --> 00:07:55,480
so we have this method RF killed on your
 

443
00:07:55,480 --> 00:07:57,300
so we have this method RF killed on your
raft instance so you might have code

444
00:07:57,300 --> 00:07:57,310
raft instance so you might have code
 

445
00:07:57,310 --> 00:07:58,470
raft instance so you might have code
that looks a little bit more like this

446
00:07:58,470 --> 00:07:58,480
that looks a little bit more like this
 

447
00:07:58,480 --> 00:08:01,230
that looks a little bit more like this
so while you're wrapped instance is not

448
00:08:01,230 --> 00:08:01,240
so while you're wrapped instance is not
 

449
00:08:01,240 --> 00:08:02,670
so while you're wrapped instance is not
dead you want to periodically do some

450
00:08:02,670 --> 00:08:02,680
dead you want to periodically do some
 

451
00:08:02,680 --> 00:08:10,550
dead you want to periodically do some
work any questions about that so far

452
00:08:10,550 --> 00:08:10,560
work any questions about that so far
 

453
00:08:10,560 --> 00:08:21,769
work any questions about that so far
yeah question

454
00:08:21,769 --> 00:08:21,779

 

455
00:08:21,779 --> 00:08:25,349

does using the locking mechanisms for

456
00:08:25,349 --> 00:08:25,359
does using the locking mechanisms for
 

457
00:08:25,359 --> 00:08:30,239
does using the locking mechanisms for
channels make it so that any right

458
00:08:30,239 --> 00:08:30,249
channels make it so that any right
 

459
00:08:30,249 --> 00:08:32,909
channels make it so that any right
stunts any variables and those functions

460
00:08:32,909 --> 00:08:32,919
stunts any variables and those functions
 

461
00:08:32,919 --> 00:08:36,149
stunts any variables and those functions
are to be observed by the fencer would

462
00:08:36,149 --> 00:08:36,159
are to be observed by the fencer would
 

463
00:08:36,159 --> 00:08:41,749
are to be observed by the fencer would
you need to send done across the channel

464
00:08:41,749 --> 00:08:41,759

 

465
00:08:41,759 --> 00:08:44,189

okay so let me try to simplify the

466
00:08:44,189 --> 00:08:44,199
okay so let me try to simplify the
 

467
00:08:44,199 --> 00:08:45,660
okay so let me try to simplify the
question a bit I think the question is

468
00:08:45,660 --> 00:08:45,670
question a bit I think the question is
 

469
00:08:45,670 --> 00:08:47,819
question a bit I think the question is
do you need to use locks here can you

470
00:08:47,819 --> 00:08:47,829
do you need to use locks here can you
 

471
00:08:47,829 --> 00:08:51,360
do you need to use locks here can you
use channels instead and R and can you

472
00:08:51,360 --> 00:08:51,370
use channels instead and R and can you
 

473
00:08:51,370 --> 00:08:52,679
use channels instead and R and can you
get away with not using locks and like

474
00:08:52,679 --> 00:08:52,689
get away with not using locks and like
 

475
00:08:52,689 --> 00:08:53,670
get away with not using locks and like
what's the difference between nothing

476
00:08:53,670 --> 00:08:53,680
what's the difference between nothing
 

477
00:08:53,680 --> 00:08:55,350
what's the difference between nothing
versus channels vs locks is that

478
00:08:55,350 --> 00:08:55,360
versus channels vs locks is that
 

479
00:08:55,360 --> 00:09:08,610
versus channels vs locks is that
basically what you're asking I think the

480
00:09:08,610 --> 00:09:08,620
basically what you're asking I think the
 

481
00:09:08,620 --> 00:09:10,949
basically what you're asking I think the
question is this done does it not need

482
00:09:10,949 --> 00:09:10,959
question is this done does it not need
 

483
00:09:10,959 --> 00:09:12,900
question is this done does it not need
to be sent across a channel does just

484
00:09:12,900 --> 00:09:12,910
to be sent across a channel does just
 

485
00:09:12,910 --> 00:09:15,090
to be sent across a channel does just
using these locks ensure that this read

486
00:09:15,090 --> 00:09:15,100
using these locks ensure that this read
 

487
00:09:15,100 --> 00:09:17,999
using these locks ensure that this read
here observes the write done by a thread

488
00:09:17,999 --> 00:09:18,009
here observes the write done by a thread
 

489
00:09:18,009 --> 00:09:21,449
here observes the write done by a thread
okay so the answer is yes basically at a

490
00:09:21,449 --> 00:09:21,459
okay so the answer is yes basically at a
 

491
00:09:21,459 --> 00:09:23,879
okay so the answer is yes basically at a
high level if you want to ensure cross

492
00:09:23,879 --> 00:09:23,889
high level if you want to ensure cross
 

493
00:09:23,889 --> 00:09:25,379
high level if you want to ensure cross
thread communication make sure you use

494
00:09:25,379 --> 00:09:25,389
thread communication make sure you use
 

495
00:09:25,389 --> 00:09:27,420
thread communication make sure you use
go synchronization primitives whether

496
00:09:27,420 --> 00:09:27,430
go synchronization primitives whether
 

497
00:09:27,430 --> 00:09:30,059
go synchronization primitives whether
it's channels or locks and condition

498
00:09:30,059 --> 00:09:30,069
it's channels or locks and condition
 

499
00:09:30,069 --> 00:09:33,360
it's channels or locks and condition
variables and so here because of the use

500
00:09:33,360 --> 00:09:33,370
variables and so here because of the use
 

501
00:09:33,370 --> 00:09:35,490
variables and so here because of the use
of locks after this thread writes done

502
00:09:35,490 --> 00:09:35,500
of locks after this thread writes done
 

503
00:09:35,500 --> 00:09:38,340
of locks after this thread writes done
and does unlock the next lock that

504
00:09:38,340 --> 00:09:38,350
and does unlock the next lock that
 

505
00:09:38,350 --> 00:09:40,679
and does unlock the next lock that
happens is guaranteed to observe the

506
00:09:40,679 --> 00:09:40,689
happens is guaranteed to observe the
 

507
00:09:40,689 --> 00:09:42,869
happens is guaranteed to observe the
writes done before that before this

508
00:09:42,869 --> 00:09:42,879
writes done before that before this
 

509
00:09:42,879 --> 00:09:44,549
writes done before that before this
unlock happened so you have this write

510
00:09:44,549 --> 00:09:44,559
unlock happened so you have this write
 

511
00:09:44,559 --> 00:09:46,350
unlock happened so you have this write
happened and this unlock happened then

512
00:09:46,350 --> 00:09:46,360
happened and this unlock happened then
 

513
00:09:46,360 --> 00:09:48,119
happened and this unlock happened then
one of these locks happens and then the

514
00:09:48,119 --> 00:09:48,129
one of these locks happens and then the
 

515
00:09:48,129 --> 00:09:49,769
one of these locks happens and then the
next done will be guaranteed to observe

516
00:09:49,769 --> 00:09:49,779
next done will be guaranteed to observe
 

517
00:09:49,779 --> 00:10:02,740
next done will be guaranteed to observe
that write of true question

518
00:10:02,740 --> 00:10:02,750

 

519
00:10:02,750 --> 00:10:05,560

that's a good question in this

520
00:10:05,560 --> 00:10:05,570
that's a good question in this
 

521
00:10:05,570 --> 00:10:07,360
that's a good question in this
particular code it doesn't matter but it

522
00:10:07,360 --> 00:10:07,370
particular code it doesn't matter but it
 

523
00:10:07,370 --> 00:10:08,950
particular code it doesn't matter but it
would be cleaner to do it so the

524
00:10:08,950 --> 00:10:08,960
would be cleaner to do it so the
 

525
00:10:08,960 --> 00:10:10,900
would be cleaner to do it so the
question is why don't we do mu dot

526
00:10:10,900 --> 00:10:10,910
question is why don't we do mu dot
 

527
00:10:10,910 --> 00:10:14,080
question is why don't we do mu dot
unlock here before returning and the

528
00:10:14,080 --> 00:10:14,090
unlock here before returning and the
 

529
00:10:14,090 --> 00:10:16,150
unlock here before returning and the
answer is in here there's no more like

530
00:10:16,150 --> 00:10:16,160
answer is in here there's no more like
 

531
00:10:16,160 --> 00:10:17,530
answer is in here there's no more like
the program's done so it doesn't

532
00:10:17,530 --> 00:10:17,540
the program's done so it doesn't
 

533
00:10:17,540 --> 00:10:18,820
the program's done so it doesn't
actually end up mattering but you're

534
00:10:18,820 --> 00:10:18,830
actually end up mattering but you're
 

535
00:10:18,830 --> 00:10:21,220
actually end up mattering but you're
right that like in general we would want

536
00:10:21,220 --> 00:10:21,230
right that like in general we would want
 

537
00:10:21,230 --> 00:10:23,560
right that like in general we would want
to ensure that we unlock before we

538
00:10:23,560 --> 00:10:23,570
to ensure that we unlock before we
 

539
00:10:23,570 --> 00:10:41,519
to ensure that we unlock before we
return yeah thanks for pointing that out

540
00:10:41,519 --> 00:10:41,529

 

541
00:10:41,529 --> 00:10:43,510

so I'm not sure entirely what the

542
00:10:43,510 --> 00:10:43,520
so I'm not sure entirely what the
 

543
00:10:43,520 --> 00:10:44,920
so I'm not sure entirely what the
question is but maybe something like can

544
00:10:44,920 --> 00:10:44,930
question is but maybe something like can
 

545
00:10:44,930 --> 00:10:46,750
question is but maybe something like can
both of these acquire the lock at the

546
00:10:46,750 --> 00:10:46,760
both of these acquire the lock at the
 

547
00:10:46,760 --> 00:11:00,730
both of these acquire the lock at the
same time is that the question and we'll

548
00:11:00,730 --> 00:11:00,740
same time is that the question and we'll
 

549
00:11:00,740 --> 00:11:03,070
same time is that the question and we'll
talk a little bit more about locks in

550
00:11:03,070 --> 00:11:03,080
talk a little bit more about locks in
 

551
00:11:03,080 --> 00:11:04,570
talk a little bit more about locks in
just a moment but at a high level the

552
00:11:04,570 --> 00:11:04,580
just a moment but at a high level the
 

553
00:11:04,580 --> 00:11:07,900
just a moment but at a high level the
semantics of a lock are the lock is

554
00:11:07,900 --> 00:11:07,910
semantics of a lock are the lock is
 

555
00:11:07,910 --> 00:11:09,579
semantics of a lock are the lock is
either held by somebody or not held by

556
00:11:09,579 --> 00:11:09,589
either held by somebody or not held by
 

557
00:11:09,589 --> 00:11:11,110
either held by somebody or not held by
somebody and if it's not held by

558
00:11:11,110 --> 00:11:11,120
somebody and if it's not held by
 

559
00:11:11,120 --> 00:11:12,850
somebody and if it's not held by
somebody then if someone calls lock they

560
00:11:12,850 --> 00:11:12,860
somebody then if someone calls lock they
 

561
00:11:12,860 --> 00:11:14,320
somebody then if someone calls lock they
have the chance to acquire the lock and

562
00:11:14,320 --> 00:11:14,330
have the chance to acquire the lock and
 

563
00:11:14,330 --> 00:11:16,990
have the chance to acquire the lock and
if before they call unlock somebody else

564
00:11:16,990 --> 00:11:17,000
if before they call unlock somebody else
 

565
00:11:17,000 --> 00:11:18,970
if before they call unlock somebody else
calls lock that other thread is going to

566
00:11:18,970 --> 00:11:18,980
calls lock that other thread is going to
 

567
00:11:18,980 --> 00:11:20,949
calls lock that other thread is going to
be blocked until the unlock happens then

568
00:11:20,949 --> 00:11:20,959
be blocked until the unlock happens then
 

569
00:11:20,959 --> 00:11:22,900
be blocked until the unlock happens then
the lock is free again so at a high

570
00:11:22,900 --> 00:11:22,910
the lock is free again so at a high
 

571
00:11:22,910 --> 00:11:24,990
the lock is free again so at a high
level between the lock and the unlock

572
00:11:24,990 --> 00:11:25,000
level between the lock and the unlock
 

573
00:11:25,000 --> 00:11:27,820
level between the lock and the unlock
for any particular lock like any only a

574
00:11:27,820 --> 00:11:27,830
for any particular lock like any only a
 

575
00:11:27,830 --> 00:11:29,139
for any particular lock like any only a
single thread can be executing what's

576
00:11:29,139 --> 00:11:29,149
single thread can be executing what's
 

577
00:11:29,149 --> 00:11:30,370
single thread can be executing what's
called a critical section between the

578
00:11:30,370 --> 00:11:30,380
called a critical section between the
 

579
00:11:30,380 --> 00:11:35,019
called a critical section between the
lock and unlock regions any other

580
00:11:35,019 --> 00:11:35,029
lock and unlock regions any other
 

581
00:11:35,029 --> 00:12:02,889
lock and unlock regions any other
questions

582
00:12:02,889 --> 00:12:02,899

 

583
00:12:02,899 --> 00:12:05,749

so the question is related to timing

584
00:12:05,749 --> 00:12:05,759
so the question is related to timing
 

585
00:12:05,759 --> 00:12:07,999
so the question is related to timing
like when you set done equals true and

586
00:12:07,999 --> 00:12:08,009
like when you set done equals true and
 

587
00:12:08,009 --> 00:12:09,920
like when you set done equals true and
then you unlock you have no guarantee in

588
00:12:09,920 --> 00:12:09,930
then you unlock you have no guarantee in
 

589
00:12:09,930 --> 00:12:11,960
then you unlock you have no guarantee in
terms of real time like when periodic

590
00:12:11,960 --> 00:12:11,970
terms of real time like when periodic
 

591
00:12:11,970 --> 00:12:13,430
terms of real time like when periodic
will end up being scheduled and observe

592
00:12:13,430 --> 00:12:13,440
will end up being scheduled and observe
 

593
00:12:13,440 --> 00:12:14,629
will end up being scheduled and observe
this right and actually end up

594
00:12:14,629 --> 00:12:14,639
this right and actually end up
 

595
00:12:14,639 --> 00:12:17,480
this right and actually end up
terminating and so yes if you want to

596
00:12:17,480 --> 00:12:17,490
terminating and so yes if you want to
 

597
00:12:17,490 --> 00:12:19,370
terminating and so yes if you want to
mean to actually ensure that periodic

598
00:12:19,370 --> 00:12:19,380
mean to actually ensure that periodic
 

599
00:12:19,380 --> 00:12:20,930
mean to actually ensure that periodic
has exited for some particular reason

600
00:12:20,930 --> 00:12:20,940
has exited for some particular reason
 

601
00:12:20,940 --> 00:12:22,759
has exited for some particular reason
then you could write some code that

602
00:12:22,759 --> 00:12:22,769
then you could write some code that
 

603
00:12:22,769 --> 00:12:24,079
then you could write some code that
communicates back from periodic

604
00:12:24,079 --> 00:12:24,089
communicates back from periodic
 

605
00:12:24,089 --> 00:12:25,730
communicates back from periodic
acknowledging this but in this

606
00:12:25,730 --> 00:12:25,740
acknowledging this but in this
 

607
00:12:25,740 --> 00:12:27,230
acknowledging this but in this
particular case like the only reason we

608
00:12:27,230 --> 00:12:27,240
particular case like the only reason we
 

609
00:12:27,240 --> 00:12:28,550
particular case like the only reason we
have the sleep here is just to

610
00:12:28,550 --> 00:12:28,560
have the sleep here is just to
 

611
00:12:28,560 --> 00:12:35,780
have the sleep here is just to
demonstrate that the sleep here is just

612
00:12:35,780 --> 00:12:35,790
demonstrate that the sleep here is just
 

613
00:12:35,790 --> 00:12:37,309
demonstrate that the sleep here is just
to demonstrate that tick prints for a

614
00:12:37,309 --> 00:12:37,319
to demonstrate that tick prints for a
 

615
00:12:37,319 --> 00:12:39,559
to demonstrate that tick prints for a
while and then periodic as indeed cancel

616
00:12:39,559 --> 00:12:39,569
while and then periodic as indeed cancel
 

617
00:12:39,569 --> 00:12:41,030
while and then periodic as indeed cancel
it because it stops being printed before

618
00:12:41,030 --> 00:12:41,040
it because it stops being printed before
 

619
00:12:41,040 --> 00:12:44,300
it because it stops being printed before
I get my shell prompt back and in

620
00:12:44,300 --> 00:12:44,310
I get my shell prompt back and in
 

621
00:12:44,310 --> 00:12:45,650
I get my shell prompt back and in
general for a lot of these background

622
00:12:45,650 --> 00:12:45,660
general for a lot of these background
 

623
00:12:45,660 --> 00:12:47,120
general for a lot of these background
threads like you can just say that you

624
00:12:47,120 --> 00:12:47,130
threads like you can just say that you
 

625
00:12:47,130 --> 00:12:48,170
threads like you can just say that you
want to kill them and it doesn't matter

626
00:12:48,170 --> 00:12:48,180
want to kill them and it doesn't matter
 

627
00:12:48,180 --> 00:12:49,879
want to kill them and it doesn't matter
if they're killed within 1 second or

628
00:12:49,879 --> 00:12:49,889
if they're killed within 1 second or
 

629
00:12:49,889 --> 00:12:51,319
if they're killed within 1 second or
within 2 seconds or one exactly go

630
00:12:51,319 --> 00:12:51,329
within 2 seconds or one exactly go
 

631
00:12:51,329 --> 00:12:52,879
within 2 seconds or one exactly go
schedules it because this thread is

632
00:12:52,879 --> 00:12:52,889
schedules it because this thread is
 

633
00:12:52,889 --> 00:12:54,829
schedules it because this thread is
going to just observe this right to done

634
00:12:54,829 --> 00:12:54,839
going to just observe this right to done
 

635
00:12:54,839 --> 00:12:56,480
going to just observe this right to done
and then exit do no more works it

636
00:12:56,480 --> 00:12:56,490
and then exit do no more works it
 

637
00:12:56,490 --> 00:12:58,370
and then exit do no more works it
doesn't really matter and also another

638
00:12:58,370 --> 00:12:58,380
doesn't really matter and also another
 

639
00:12:58,380 --> 00:13:00,949
doesn't really matter and also another
thing in go is that if you spawn a bunch

640
00:13:00,949 --> 00:13:00,959
thing in go is that if you spawn a bunch
 

641
00:13:00,959 --> 00:13:02,150
thing in go is that if you spawn a bunch
of goo routines one of them is the main

642
00:13:02,150 --> 00:13:02,160
of goo routines one of them is the main
 

643
00:13:02,160 --> 00:13:04,879
of goo routines one of them is the main
go routine this one here and the way go

644
00:13:04,879 --> 00:13:04,889
go routine this one here and the way go
 

645
00:13:04,889 --> 00:13:06,500
go routine this one here and the way go
works is that if the main goroutine

646
00:13:06,500 --> 00:13:06,510
works is that if the main goroutine
 

647
00:13:06,510 --> 00:13:08,540
works is that if the main goroutine
exits the whole program terminates and

648
00:13:08,540 --> 00:13:08,550
exits the whole program terminates and
 

649
00:13:08,550 --> 00:13:27,940
exits the whole program terminates and
all go routines are terminated

650
00:13:27,940 --> 00:13:27,950

 

651
00:13:27,950 --> 00:13:31,190

that's a great question okay so I think

652
00:13:31,190 --> 00:13:31,200
that's a great question okay so I think
 

653
00:13:31,200 --> 00:13:32,330
that's a great question okay so I think
the question is something like why do

654
00:13:32,330 --> 00:13:32,340
the question is something like why do
 

655
00:13:32,340 --> 00:13:33,680
the question is something like why do
you need locks at all like can you just

656
00:13:33,680 --> 00:13:33,690
you need locks at all like can you just
 

657
00:13:33,690 --> 00:13:36,290
you need locks at all like can you just
delete all the locks and then like

658
00:13:36,290 --> 00:13:36,300
delete all the locks and then like
 

659
00:13:36,300 --> 00:13:37,970
delete all the locks and then like
looking at this code it looks like okay

660
00:13:37,970 --> 00:13:37,980
looking at this code it looks like okay
 

661
00:13:37,980 --> 00:13:39,770
looking at this code it looks like okay
main does a right to true at some point

662
00:13:39,770 --> 00:13:39,780
main does a right to true at some point
 

663
00:13:39,780 --> 00:13:41,750
main does a right to true at some point
and periodic is repeatedly reading it so

664
00:13:41,750 --> 00:13:41,760
and periodic is repeatedly reading it so
 

665
00:13:41,760 --> 00:13:43,010
and periodic is repeatedly reading it so
at some point it should observe this

666
00:13:43,010 --> 00:13:43,020
at some point it should observe this
 

667
00:13:43,020 --> 00:13:45,860
at some point it should observe this
read right well it turns out that like

668
00:13:45,860 --> 00:13:45,870
read right well it turns out that like
 

669
00:13:45,870 --> 00:13:48,080
read right well it turns out that like
this is why go has this fancy memory

670
00:13:48,080 --> 00:13:48,090
this is why go has this fancy memory
 

671
00:13:48,090 --> 00:13:49,550
this is why go has this fancy memory
model and you have this whole thing on

672
00:13:49,550 --> 00:13:49,560
model and you have this whole thing on
 

673
00:13:49,560 --> 00:13:50,990
model and you have this whole thing on
that happens before relation the

674
00:13:50,990 --> 00:13:51,000
that happens before relation the
 

675
00:13:51,000 --> 00:13:53,060
that happens before relation the
compiler is allowed to take this code

676
00:13:53,060 --> 00:13:53,070
compiler is allowed to take this code
 

677
00:13:53,070 --> 00:13:55,880
compiler is allowed to take this code
and emit a kind of low-level machine

678
00:13:55,880 --> 00:13:55,890
and emit a kind of low-level machine
 

679
00:13:55,890 --> 00:13:57,230
and emit a kind of low-level machine
code that does something a little bit

680
00:13:57,230 --> 00:13:57,240
code that does something a little bit
 

681
00:13:57,240 --> 00:13:58,070
code that does something a little bit
different than what you intuitively

682
00:13:58,070 --> 00:13:58,080
different than what you intuitively
 

683
00:13:58,080 --> 00:14:00,650
different than what you intuitively
thought would happen here and we can

684
00:14:00,650 --> 00:14:00,660
thought would happen here and we can
 

685
00:14:00,660 --> 00:14:02,630
thought would happen here and we can
talk about that in detail offline after

686
00:14:02,630 --> 00:14:02,640
talk about that in detail offline after
 

687
00:14:02,640 --> 00:14:05,840
talk about that in detail offline after
the lecture and office hours but at a

688
00:14:05,840 --> 00:14:05,850
the lecture and office hours but at a
 

689
00:14:05,850 --> 00:14:07,100
the lecture and office hours but at a
high level I think one rule you can

690
00:14:07,100 --> 00:14:07,110
high level I think one rule you can
 

691
00:14:07,110 --> 00:14:09,080
high level I think one rule you can
follow is if you have accesses to shared

692
00:14:09,080 --> 00:14:09,090
follow is if you have accesses to shared
 

693
00:14:09,090 --> 00:14:10,700
follow is if you have accesses to shared
variables and you want to be able to

694
00:14:10,700 --> 00:14:10,710
variables and you want to be able to
 

695
00:14:10,710 --> 00:14:12,050
variables and you want to be able to
observe them across different threads

696
00:14:12,050 --> 00:14:12,060
observe them across different threads
 

697
00:14:12,060 --> 00:14:14,450
observe them across different threads
you need to be holding a lock before you

698
00:14:14,450 --> 00:14:14,460
you need to be holding a lock before you
 

699
00:14:14,460 --> 00:14:15,950
you need to be holding a lock before you
read or write those shared variables in

700
00:14:15,950 --> 00:14:15,960
read or write those shared variables in
 

701
00:14:15,960 --> 00:14:18,260
read or write those shared variables in
this particular case I think the go

702
00:14:18,260 --> 00:14:18,270
this particular case I think the go
 

703
00:14:18,270 --> 00:14:19,640
this particular case I think the go
compiler would be allowed to optimize

704
00:14:19,640 --> 00:14:19,650
compiler would be allowed to optimize
 

705
00:14:19,650 --> 00:14:21,530
compiler would be allowed to optimize
this to like lift the read of done

706
00:14:21,530 --> 00:14:21,540
this to like lift the read of done
 

707
00:14:21,540 --> 00:14:24,470
this to like lift the read of done
outside the four so read this shared

708
00:14:24,470 --> 00:14:24,480
outside the four so read this shared
 

709
00:14:24,480 --> 00:14:27,380
outside the four so read this shared
variable once and then if done is false

710
00:14:27,380 --> 00:14:27,390
variable once and then if done is false
 

711
00:14:27,390 --> 00:14:29,600
variable once and then if done is false
then set like make the inside be an

712
00:14:29,600 --> 00:14:29,610
then set like make the inside be an
 

713
00:14:29,610 --> 00:14:32,570
then set like make the inside be an
infinite loop because like now the way

714
00:14:32,570 --> 00:14:32,580
infinite loop because like now the way
 

715
00:14:32,580 --> 00:14:34,520
infinite loop because like now the way
this thread is written it had uses no

716
00:14:34,520 --> 00:14:34,530
this thread is written it had uses no
 

717
00:14:34,530 --> 00:14:35,810
this thread is written it had uses no
synchronization primitives there's no

718
00:14:35,810 --> 00:14:35,820
synchronization primitives there's no
 

719
00:14:35,820 --> 00:14:37,670
synchronization primitives there's no
mutex lock or unlock no channel sends or

720
00:14:37,670 --> 00:14:37,680
mutex lock or unlock no channel sends or
 

721
00:14:37,680 --> 00:14:39,140
mutex lock or unlock no channel sends or
receives and so it's actually not

722
00:14:39,140 --> 00:14:39,150
receives and so it's actually not
 

723
00:14:39,150 --> 00:14:41,120
receives and so it's actually not
guaranteed to observe any mutations done

724
00:14:41,120 --> 00:14:41,130
guaranteed to observe any mutations done
 

725
00:14:41,130 --> 00:14:43,180
guaranteed to observe any mutations done
by other concurrently running threads

726
00:14:43,180 --> 00:14:43,190
by other concurrently running threads
 

727
00:14:43,190 --> 00:14:45,680
by other concurrently running threads
and if you look on Piazza I've actually

728
00:14:45,680 --> 00:14:45,690
and if you look on Piazza I've actually
 

729
00:14:45,690 --> 00:14:47,720
and if you look on Piazza I've actually
like written a particular go program

730
00:14:47,720 --> 00:14:47,730
like written a particular go program
 

731
00:14:47,730 --> 00:14:49,580
like written a particular go program
that is optimized in the unintuitive way

732
00:14:49,580 --> 00:14:49,590
that is optimized in the unintuitive way
 

733
00:14:49,590 --> 00:14:50,930
that is optimized in the unintuitive way
like it'll produce code that does an

734
00:14:50,930 --> 00:14:50,940
like it'll produce code that does an
 

735
00:14:50,940 --> 00:14:52,130
like it'll produce code that does an
infinite loop even though looking at it

736
00:14:52,130 --> 00:14:52,140
infinite loop even though looking at it
 

737
00:14:52,140 --> 00:14:54,380
infinite loop even though looking at it
like you might think that oh the obvious

738
00:14:54,380 --> 00:14:54,390
like you might think that oh the obvious
 

739
00:14:54,390 --> 00:14:56,210
like you might think that oh the obvious
way to compile this code will produce

740
00:14:56,210 --> 00:14:56,220
way to compile this code will produce
 

741
00:14:56,220 --> 00:15:00,020
way to compile this code will produce
something that terminates yeah so the

742
00:15:00,020 --> 00:15:00,030
something that terminates yeah so the
 

743
00:15:00,030 --> 00:15:02,840
something that terminates yeah so the
memory model is pretty fancy and it's

744
00:15:02,840 --> 00:15:02,850
memory model is pretty fancy and it's
 

745
00:15:02,850 --> 00:15:04,550
memory model is pretty fancy and it's
really hard to think about why exactly

746
00:15:04,550 --> 00:15:04,560
really hard to think about why exactly
 

747
00:15:04,560 --> 00:15:06,230
really hard to think about why exactly
incorrect programs are incorrect but if

748
00:15:06,230 --> 00:15:06,240
incorrect programs are incorrect but if
 

749
00:15:06,240 --> 00:15:08,870
incorrect programs are incorrect but if
you follow some general rules like whole

750
00:15:08,870 --> 00:15:08,880
you follow some general rules like whole
 

751
00:15:08,880 --> 00:15:10,070
you follow some general rules like whole
blocks before you mutate shared

752
00:15:10,070 --> 00:15:10,080
blocks before you mutate shared
 

753
00:15:10,080 --> 00:15:11,510
blocks before you mutate shared
variables then you can avoid thinking

754
00:15:11,510 --> 00:15:11,520
variables then you can avoid thinking
 

755
00:15:11,520 --> 00:15:15,280
variables then you can avoid thinking
about some of these nasty issues

756
00:15:15,280 --> 00:15:15,290

 

757
00:15:15,290 --> 00:15:19,190

any other questions all right so let's

758
00:15:19,190 --> 00:15:19,200
any other questions all right so let's
 

759
00:15:19,200 --> 00:15:21,670
any other questions all right so let's
talk a little bit more about mutexes now

760
00:15:21,670 --> 00:15:21,680
talk a little bit more about mutexes now
 

761
00:15:21,680 --> 00:15:25,010
talk a little bit more about mutexes now
so why do you need mutex is at a high

762
00:15:25,010 --> 00:15:25,020
so why do you need mutex is at a high
 

763
00:15:25,020 --> 00:15:28,190
so why do you need mutex is at a high
level whenever you have concurrent

764
00:15:28,190 --> 00:15:28,200
level whenever you have concurrent
 

765
00:15:28,200 --> 00:15:30,080
level whenever you have concurrent
access but by different threads to some

766
00:15:30,080 --> 00:15:30,090
access but by different threads to some
 

767
00:15:30,090 --> 00:15:32,809
access but by different threads to some
shared data you want to ensure that

768
00:15:32,809 --> 00:15:32,819
shared data you want to ensure that
 

769
00:15:32,819 --> 00:15:35,749
shared data you want to ensure that
reads and writes of that data are atomic

770
00:15:35,749 --> 00:15:35,759
reads and writes of that data are atomic
 

771
00:15:35,759 --> 00:15:38,659
reads and writes of that data are atomic
so here's one example of program that

772
00:15:38,659 --> 00:15:38,669
so here's one example of program that
 

773
00:15:38,669 --> 00:15:40,519
so here's one example of program that
declares a counter and then spawns a

774
00:15:40,519 --> 00:15:40,529
declares a counter and then spawns a
 

775
00:15:40,529 --> 00:15:40,939
declares a counter and then spawns a
goroutine

776
00:15:40,939 --> 00:15:40,949
goroutine
 

777
00:15:40,949 --> 00:15:42,439
goroutine
actually spawns a thousand go routines

778
00:15:42,439 --> 00:15:42,449
actually spawns a thousand go routines
 

779
00:15:42,449 --> 00:15:44,329
actually spawns a thousand go routines
that each update the counter value and

780
00:15:44,329 --> 00:15:44,339
that each update the counter value and
 

781
00:15:44,339 --> 00:15:46,639
that each update the counter value and
increment it by one and you might think

782
00:15:46,639 --> 00:15:46,649
increment it by one and you might think
 

783
00:15:46,649 --> 00:15:48,199
increment it by one and you might think
that looking at this intuitively when I

784
00:15:48,199 --> 00:15:48,209
that looking at this intuitively when I
 

785
00:15:48,209 --> 00:15:49,429
that looking at this intuitively when I
print out the value of the counter at

786
00:15:49,429 --> 00:15:49,439
print out the value of the counter at
 

787
00:15:49,439 --> 00:15:51,919
print out the value of the counter at
the end it should print a thousand but

788
00:15:51,919 --> 00:15:51,929
the end it should print a thousand but
 

789
00:15:51,929 --> 00:15:53,689
the end it should print a thousand but
it turns out that we missed some of the

790
00:15:53,689 --> 00:15:53,699
it turns out that we missed some of the
 

791
00:15:53,699 --> 00:15:55,579
it turns out that we missed some of the
updates here and in this particular case

792
00:15:55,579 --> 00:15:55,589
updates here and in this particular case
 

793
00:15:55,589 --> 00:15:59,179
updates here and in this particular case
it only printed 947 so what's going on

794
00:15:59,179 --> 00:15:59,189
it only printed 947 so what's going on
 

795
00:15:59,189 --> 00:16:03,049
it only printed 947 so what's going on
here is that this update here is not

796
00:16:03,049 --> 00:16:03,059
here is that this update here is not
 

797
00:16:03,059 --> 00:16:04,999
here is that this update here is not
really protected in any way and so these

798
00:16:04,999 --> 00:16:05,009
really protected in any way and so these
 

799
00:16:05,009 --> 00:16:06,739
really protected in any way and so these
threads running concurrently can read

800
00:16:06,739 --> 00:16:06,749
threads running concurrently can read
 

801
00:16:06,749 --> 00:16:08,479
threads running concurrently can read
the value of counter and update it and

802
00:16:08,479 --> 00:16:08,489
the value of counter and update it and
 

803
00:16:08,489 --> 00:16:11,659
the value of counter and update it and
clobber other threads updates of this

804
00:16:11,659 --> 00:16:11,669
clobber other threads updates of this
 

805
00:16:11,669 --> 00:16:13,400
clobber other threads updates of this
value like basically we want to ensure

806
00:16:13,400 --> 00:16:13,410
value like basically we want to ensure
 

807
00:16:13,410 --> 00:16:16,099
value like basically we want to ensure
that this entire section here happens

808
00:16:16,099 --> 00:16:16,109
that this entire section here happens
 

809
00:16:16,109 --> 00:16:18,379
that this entire section here happens
atomically and so the way you make

810
00:16:18,379 --> 00:16:18,389
atomically and so the way you make
 

811
00:16:18,389 --> 00:16:22,429
atomically and so the way you make
blocks of code run atomically are by

812
00:16:22,429 --> 00:16:22,439
blocks of code run atomically are by
 

813
00:16:22,439 --> 00:16:25,340
blocks of code run atomically are by
using locks and so in this code example

814
00:16:25,340 --> 00:16:25,350
using locks and so in this code example
 

815
00:16:25,350 --> 00:16:29,029
using locks and so in this code example
we've fixed this bug we create a lock

816
00:16:29,029 --> 00:16:29,039
we've fixed this bug we create a lock
 

817
00:16:29,039 --> 00:16:30,949
we've fixed this bug we create a lock
and then all these go routines that

818
00:16:30,949 --> 00:16:30,959
and then all these go routines that
 

819
00:16:30,959 --> 00:16:33,379
and then all these go routines that
modify this counter value first grab the

820
00:16:33,379 --> 00:16:33,389
modify this counter value first grab the
 

821
00:16:33,389 --> 00:16:36,049
modify this counter value first grab the
lock then update the counter value and

822
00:16:36,049 --> 00:16:36,059
lock then update the counter value and
 

823
00:16:36,059 --> 00:16:37,789
lock then update the counter value and
then unlock and we see that we're using

824
00:16:37,789 --> 00:16:37,799
then unlock and we see that we're using
 

825
00:16:37,799 --> 00:16:39,979
then unlock and we see that we're using
this defer keyword here what this does

826
00:16:39,979 --> 00:16:39,989
this defer keyword here what this does
 

827
00:16:39,989 --> 00:16:42,979
this defer keyword here what this does
is basically the same as putting this

828
00:16:42,979 --> 00:16:42,989
is basically the same as putting this
 

829
00:16:42,989 --> 00:16:45,469
is basically the same as putting this
code down here so we grab a lock do some

830
00:16:45,469 --> 00:16:45,479
code down here so we grab a lock do some
 

831
00:16:45,479 --> 00:16:47,509
code down here so we grab a lock do some
update then unlock defer is just a nice

832
00:16:47,509 --> 00:16:47,519
update then unlock defer is just a nice
 

833
00:16:47,519 --> 00:16:51,529
update then unlock defer is just a nice
way of remembering to do this you might

834
00:16:51,529 --> 00:16:51,539
way of remembering to do this you might
 

835
00:16:51,539 --> 00:16:53,329
way of remembering to do this you might
forget to write the unlock later and so

836
00:16:53,329 --> 00:16:53,339
forget to write the unlock later and so
 

837
00:16:53,339 --> 00:16:54,979
forget to write the unlock later and so
what defer does is it you can think of

838
00:16:54,979 --> 00:16:54,989
what defer does is it you can think of
 

839
00:16:54,989 --> 00:16:56,899
what defer does is it you can think of
it as like scheduling this to run at the

840
00:16:56,899 --> 00:16:56,909
it as like scheduling this to run at the
 

841
00:16:56,909 --> 00:16:59,419
it as like scheduling this to run at the
end of the current function body and so

842
00:16:59,419 --> 00:16:59,429
end of the current function body and so
 

843
00:16:59,429 --> 00:17:00,679
end of the current function body and so
this is a really common pattern you'll

844
00:17:00,679 --> 00:17:00,689
this is a really common pattern you'll
 

845
00:17:00,689 --> 00:17:02,989
this is a really common pattern you'll
see for example in your RPC handlers for

846
00:17:02,989 --> 00:17:02,999
see for example in your RPC handlers for
 

847
00:17:02,999 --> 00:17:05,389
see for example in your RPC handlers for
the lab so oftentimes RPC handlers will

848
00:17:05,389 --> 00:17:05,399
the lab so oftentimes RPC handlers will
 

849
00:17:05,399 --> 00:17:08,210
the lab so oftentimes RPC handlers will
manipulate either read or write data on

850
00:17:08,210 --> 00:17:08,220
manipulate either read or write data on
 

851
00:17:08,220 --> 00:17:10,369
manipulate either read or write data on
the RAF structure right and those

852
00:17:10,369 --> 00:17:10,379
the RAF structure right and those
 

853
00:17:10,379 --> 00:17:11,990
the RAF structure right and those
updates should be synchronized with

854
00:17:11,990 --> 00:17:12,000
updates should be synchronized with
 

855
00:17:12,000 --> 00:17:13,909
updates should be synchronized with
other concurrently happening updates and

856
00:17:13,909 --> 00:17:13,919
other concurrently happening updates and
 

857
00:17:13,919 --> 00:17:15,829
other concurrently happening updates and
so oftentimes the pattern for RPC

858
00:17:15,829 --> 00:17:15,839
so oftentimes the pattern for RPC
 

859
00:17:15,839 --> 00:17:17,029
so oftentimes the pattern for RPC
handles would be like grab the lock

860
00:17:17,029 --> 00:17:17,039
handles would be like grab the lock
 

861
00:17:17,039 --> 00:17:19,039
handles would be like grab the lock
differ unlock and then go do some work

862
00:17:19,039 --> 00:17:19,049
differ unlock and then go do some work
 

863
00:17:19,049 --> 00:17:26,919
differ unlock and then go do some work
inside so we can see if we run this code

864
00:17:26,919 --> 00:17:26,929
inside so we can see if we run this code
 

865
00:17:26,929 --> 00:17:29,600
inside so we can see if we run this code
it produces the expected results so it

866
00:17:29,600 --> 00:17:29,610
it produces the expected results so it
 

867
00:17:29,610 --> 00:17:30,950
it produces the expected results so it
prints out a thousand and we haven't

868
00:17:30,950 --> 00:17:30,960
prints out a thousand and we haven't
 

869
00:17:30,960 --> 00:17:34,549
prints out a thousand and we haven't
lost any of these updates and so what at

870
00:17:34,549 --> 00:17:34,559
lost any of these updates and so what at
 

871
00:17:34,559 --> 00:17:35,990
lost any of these updates and so what at
a high level what a lock or a mutex can

872
00:17:35,990 --> 00:17:36,000
a high level what a lock or a mutex can
 

873
00:17:36,000 --> 00:17:38,600
a high level what a lock or a mutex can
do is guarantee mutual exclusion for a

874
00:17:38,600 --> 00:17:38,610
do is guarantee mutual exclusion for a
 

875
00:17:38,610 --> 00:17:40,369
do is guarantee mutual exclusion for a
region of code which we call a critical

876
00:17:40,369 --> 00:17:40,379
region of code which we call a critical
 

877
00:17:40,379 --> 00:17:41,810
region of code which we call a critical
section so in here this is the critical

878
00:17:41,810 --> 00:17:41,820
section so in here this is the critical
 

879
00:17:41,820 --> 00:17:43,730
section so in here this is the critical
section and it ensures that none of

880
00:17:43,730 --> 00:17:43,740
section and it ensures that none of
 

881
00:17:43,740 --> 00:17:45,470
section and it ensures that none of
these critical sections execute

882
00:17:45,470 --> 00:17:45,480
these critical sections execute
 

883
00:17:45,480 --> 00:17:46,250
these critical sections execute
concurrently with

884
00:17:46,250 --> 00:17:46,260
concurrently with
 

885
00:17:46,260 --> 00:17:47,810
concurrently with
ones they're all serialized happened one

886
00:17:47,810 --> 00:17:47,820
ones they're all serialized happened one
 

887
00:17:47,820 --> 00:18:00,590
ones they're all serialized happened one
after another question

888
00:18:00,590 --> 00:18:00,600

 

889
00:18:00,600 --> 00:18:03,090

yes so this is a good observation this

890
00:18:03,090 --> 00:18:03,100
yes so this is a good observation this
 

891
00:18:03,100 --> 00:18:04,260
yes so this is a good observation this
particular could is actually not

892
00:18:04,260 --> 00:18:04,270
particular could is actually not
 

893
00:18:04,270 --> 00:18:05,640
particular could is actually not
guaranteed to produce a thousand

894
00:18:05,640 --> 00:18:05,650
guaranteed to produce a thousand
 

895
00:18:05,650 --> 00:18:07,380
guaranteed to produce a thousand
depending on how thread scheduling end

896
00:18:07,380 --> 00:18:07,390
depending on how thread scheduling end
 

897
00:18:07,390 --> 00:18:08,940
depending on how thread scheduling end
up ends up happening because all the

898
00:18:08,940 --> 00:18:08,950
up ends up happening because all the
 

899
00:18:08,950 --> 00:18:10,950
up ends up happening because all the
mean guru teen does is it waits for one

900
00:18:10,950 --> 00:18:10,960
mean guru teen does is it waits for one
 

901
00:18:10,960 --> 00:18:12,420
mean guru teen does is it waits for one
second which is some arbitrary unit of

902
00:18:12,420 --> 00:18:12,430
second which is some arbitrary unit of
 

903
00:18:12,430 --> 00:18:14,070
second which is some arbitrary unit of
time and then it prints out the value of

904
00:18:14,070 --> 00:18:14,080
time and then it prints out the value of
 

905
00:18:14,080 --> 00:18:15,960
time and then it prints out the value of
the counter I just want to keep this

906
00:18:15,960 --> 00:18:15,970
the counter I just want to keep this
 

907
00:18:15,970 --> 00:18:17,520
the counter I just want to keep this
example as simple as possible a

908
00:18:17,520 --> 00:18:17,530
example as simple as possible a
 

909
00:18:17,530 --> 00:18:18,840
example as simple as possible a
different way to write this code that

910
00:18:18,840 --> 00:18:18,850
different way to write this code that
 

911
00:18:18,850 --> 00:18:20,580
different way to write this code that
would be guaranteed to print a thousand

912
00:18:20,580 --> 00:18:20,590
would be guaranteed to print a thousand
 

913
00:18:20,590 --> 00:18:22,710
would be guaranteed to print a thousand
would be to have the main goroutine wait

914
00:18:22,710 --> 00:18:22,720
would be to have the main goroutine wait
 

915
00:18:22,720 --> 00:18:24,360
would be to have the main goroutine wait
for all these thousand threads to finish

916
00:18:24,360 --> 00:18:24,370
for all these thousand threads to finish
 

917
00:18:24,370 --> 00:18:25,290
for all these thousand threads to finish
so you could do this using a weight

918
00:18:25,290 --> 00:18:25,300
so you could do this using a weight
 

919
00:18:25,300 --> 00:18:26,880
so you could do this using a weight
group for example but we didn't want to

920
00:18:26,880 --> 00:18:26,890
group for example but we didn't want to
 

921
00:18:26,890 --> 00:18:28,320
group for example but we didn't want to
put two synchronization primitives like

922
00:18:28,320 --> 00:18:28,330
put two synchronization primitives like
 

923
00:18:28,330 --> 00:18:29,820
put two synchronization primitives like
weight groups and mutex is in the same

924
00:18:29,820 --> 00:18:29,830
weight groups and mutex is in the same
 

925
00:18:29,830 --> 00:18:31,410
weight groups and mutex is in the same
example so that's why we're at this code

926
00:18:31,410 --> 00:18:31,420
example so that's why we're at this code
 

927
00:18:31,420 --> 00:18:33,090
example so that's why we're at this code
that is like technically incorrect but I

928
00:18:33,090 --> 00:18:33,100
that is like technically incorrect but I
 

929
00:18:33,100 --> 00:18:34,410
that is like technically incorrect but I
think it still demonstrates the point of

930
00:18:34,410 --> 00:18:34,420
think it still demonstrates the point of
 

931
00:18:34,420 --> 00:18:43,410
think it still demonstrates the point of
locks any other questions great so at a

932
00:18:43,410 --> 00:18:43,420
locks any other questions great so at a
 

933
00:18:43,420 --> 00:18:44,880
locks any other questions great so at a
very high level you can think of locks

934
00:18:44,880 --> 00:18:44,890
very high level you can think of locks
 

935
00:18:44,890 --> 00:18:46,920
very high level you can think of locks
is like you grab the lock you mutate the

936
00:18:46,920 --> 00:18:46,930
is like you grab the lock you mutate the
 

937
00:18:46,930 --> 00:18:49,380
is like you grab the lock you mutate the
shared data and then you unlock so does

938
00:18:49,380 --> 00:18:49,390
shared data and then you unlock so does
 

939
00:18:49,390 --> 00:18:52,260
shared data and then you unlock so does
this pattern always work well turns out

940
00:18:52,260 --> 00:18:52,270
this pattern always work well turns out
 

941
00:18:52,270 --> 00:18:57,300
this pattern always work well turns out
that that's like a useful starting point

942
00:18:57,300 --> 00:18:57,310
that that's like a useful starting point
 

943
00:18:57,310 --> 00:18:58,740
that that's like a useful starting point
for how to think about locks but it's

944
00:18:58,740 --> 00:18:58,750
for how to think about locks but it's
 

945
00:18:58,750 --> 00:19:01,170
for how to think about locks but it's
not really the complete story so here's

946
00:19:01,170 --> 00:19:01,180
not really the complete story so here's
 

947
00:19:01,180 --> 00:19:03,480
not really the complete story so here's
some code this doesn't fit on the screen

948
00:19:03,480 --> 00:19:03,490
some code this doesn't fit on the screen
 

949
00:19:03,490 --> 00:19:04,770
some code this doesn't fit on the screen
but I'll explain it to you we can scroll

950
00:19:04,770 --> 00:19:04,780
but I'll explain it to you we can scroll
 

951
00:19:04,780 --> 00:19:06,540
but I'll explain it to you we can scroll
through it it basically implements a

952
00:19:06,540 --> 00:19:06,550
through it it basically implements a
 

953
00:19:06,550 --> 00:19:08,820
through it it basically implements a
bank at a high level so I have Alice and

954
00:19:08,820 --> 00:19:08,830
bank at a high level so I have Alice and
 

955
00:19:08,830 --> 00:19:10,140
bank at a high level so I have Alice and
Bob who both start out with some

956
00:19:10,140 --> 00:19:10,150
Bob who both start out with some
 

957
00:19:10,150 --> 00:19:12,420
Bob who both start out with some
balances and then I keep track of what

958
00:19:12,420 --> 00:19:12,430
balances and then I keep track of what
 

959
00:19:12,430 --> 00:19:14,400
balances and then I keep track of what
the total balances like the total amount

960
00:19:14,400 --> 00:19:14,410
the total balances like the total amount
 

961
00:19:14,410 --> 00:19:16,230
the total balances like the total amount
of money I store in my bank and then I'm

962
00:19:16,230 --> 00:19:16,240
of money I store in my bank and then I'm
 

963
00:19:16,240 --> 00:19:18,000
of money I store in my bank and then I'm
going to spawn to go routines that will

964
00:19:18,000 --> 00:19:18,010
going to spawn to go routines that will
 

965
00:19:18,010 --> 00:19:19,320
going to spawn to go routines that will
transfer money back and forth between

966
00:19:19,320 --> 00:19:19,330
transfer money back and forth between
 

967
00:19:19,330 --> 00:19:21,690
transfer money back and forth between
our Alice and Bob so this one girl

968
00:19:21,690 --> 00:19:21,700
our Alice and Bob so this one girl
 

969
00:19:21,700 --> 00:19:23,720
our Alice and Bob so this one girl
routine that a thousand times will

970
00:19:23,720 --> 00:19:23,730
routine that a thousand times will
 

971
00:19:23,730 --> 00:19:26,460
routine that a thousand times will
reduce one from Alice and send it to Bob

972
00:19:26,460 --> 00:19:26,470
reduce one from Alice and send it to Bob
 

973
00:19:26,470 --> 00:19:28,830
reduce one from Alice and send it to Bob
and concurrently running I have this

974
00:19:28,830 --> 00:19:28,840
and concurrently running I have this
 

975
00:19:28,840 --> 00:19:30,120
and concurrently running I have this
other go routine that in a loop will

976
00:19:30,120 --> 00:19:30,130
other go routine that in a loop will
 

977
00:19:30,130 --> 00:19:31,890
other go routine that in a loop will
reduce one from Bob and send it to Alice

978
00:19:31,890 --> 00:19:31,900
reduce one from Bob and send it to Alice
 

979
00:19:31,900 --> 00:19:35,340
reduce one from Bob and send it to Alice
and notice that I have this mutex here

980
00:19:35,340 --> 00:19:35,350
and notice that I have this mutex here
 

981
00:19:35,350 --> 00:19:38,130
and notice that I have this mutex here
and whenever I manipulate these shared

982
00:19:38,130 --> 00:19:38,140
and whenever I manipulate these shared
 

983
00:19:38,140 --> 00:19:39,510
and whenever I manipulate these shared
variables between these two different

984
00:19:39,510 --> 00:19:39,520
variables between these two different
 

985
00:19:39,520 --> 00:19:39,780
variables between these two different
threads

986
00:19:39,780 --> 00:19:39,790
threads
 

987
00:19:39,790 --> 00:19:42,170
threads
I'm always locking the mutex and this

988
00:19:42,170 --> 00:19:42,180
I'm always locking the mutex and this
 

989
00:19:42,180 --> 00:19:44,880
I'm always locking the mutex and this
update only happens while this lock is

990
00:19:44,880 --> 00:19:44,890
update only happens while this lock is
 

991
00:19:44,890 --> 00:19:49,230
update only happens while this lock is
held right and so is this code correct

992
00:19:49,230 --> 00:19:49,240
held right and so is this code correct
 

993
00:19:49,240 --> 00:19:53,910
held right and so is this code correct
or incorrect there actually isn't really

994
00:19:53,910 --> 00:19:53,920
or incorrect there actually isn't really
 

995
00:19:53,920 --> 00:19:55,110
or incorrect there actually isn't really
a straightforward answer to that

996
00:19:55,110 --> 00:19:55,120
a straightforward answer to that
 

997
00:19:55,120 --> 00:19:57,510
a straightforward answer to that
question it depends on like what are the

998
00:19:57,510 --> 00:19:57,520
question it depends on like what are the
 

999
00:19:57,520 --> 00:19:59,700
question it depends on like what are the
semantics of my bank like what behavior

1000
00:19:59,700 --> 00:19:59,710
semantics of my bank like what behavior
 

1001
00:19:59,710 --> 00:20:03,000
semantics of my bank like what behavior
do I expect so I'm going to introduce

1002
00:20:03,000 --> 00:20:03,010
do I expect so I'm going to introduce
 

1003
00:20:03,010 --> 00:20:04,260
do I expect so I'm going to introduce
another thread here I'll call this one

1004
00:20:04,260 --> 00:20:04,270
another thread here I'll call this one
 

1005
00:20:04,270 --> 00:20:06,120
another thread here I'll call this one
the audit thread and what this is going

1006
00:20:06,120 --> 00:20:06,130
the audit thread and what this is going
 

1007
00:20:06,130 --> 00:20:07,530
the audit thread and what this is going
to do is every once in a while I'll

1008
00:20:07,530 --> 00:20:07,540
to do is every once in a while I'll
 

1009
00:20:07,540 --> 00:20:09,030
to do is every once in a while I'll
check it check the sum of all the

1010
00:20:09,030 --> 00:20:09,040
check it check the sum of all the
 

1011
00:20:09,040 --> 00:20:10,830
check it check the sum of all the
accounts in my bank and make sure that

1012
00:20:10,830 --> 00:20:10,840
accounts in my bank and make sure that
 

1013
00:20:10,840 --> 00:20:12,390
accounts in my bank and make sure that
the sum is the same as what it started

1014
00:20:12,390 --> 00:20:12,400
the sum is the same as what it started
 

1015
00:20:12,400 --> 00:20:13,100
the sum is the same as what it started
out as

1016
00:20:13,100 --> 00:20:13,110
out as
 

1017
00:20:13,110 --> 00:20:14,450
out as
right click if I only allow transfers

1018
00:20:14,450 --> 00:20:14,460
right click if I only allow transfers
 

1019
00:20:14,460 --> 00:20:15,890
right click if I only allow transfers
within my bank the total amount should

1020
00:20:15,890 --> 00:20:15,900
within my bank the total amount should
 

1021
00:20:15,900 --> 00:20:18,289
within my bank the total amount should
never change so now given this other

1022
00:20:18,289 --> 00:20:18,299
never change so now given this other
 

1023
00:20:18,299 --> 00:20:20,120
never change so now given this other
thread so what this does is it grabs the

1024
00:20:20,120 --> 00:20:20,130
thread so what this does is it grabs the
 

1025
00:20:20,130 --> 00:20:22,669
thread so what this does is it grabs the
lock then sums up Alice Plus Bob and

1026
00:20:22,669 --> 00:20:22,679
lock then sums up Alice Plus Bob and
 

1027
00:20:22,679 --> 00:20:24,320
lock then sums up Alice Plus Bob and
compares it to the total and if it

1028
00:20:24,320 --> 00:20:24,330
compares it to the total and if it
 

1029
00:20:24,330 --> 00:20:25,970
compares it to the total and if it
doesn't match then it says that though

1030
00:20:25,970 --> 00:20:25,980
doesn't match then it says that though
 

1031
00:20:25,980 --> 00:20:27,470
doesn't match then it says that though
I've observed some violation that my

1032
00:20:27,470 --> 00:20:27,480
I've observed some violation that my
 

1033
00:20:27,480 --> 00:20:34,310
I've observed some violation that my
total is no longer what it should be if

1034
00:20:34,310 --> 00:20:34,320
total is no longer what it should be if
 

1035
00:20:34,320 --> 00:20:36,500
total is no longer what it should be if
I run this code I actually see that a

1036
00:20:36,500 --> 00:20:36,510
I run this code I actually see that a
 

1037
00:20:36,510 --> 00:20:37,370
I run this code I actually see that a
whole bunch of times

1038
00:20:37,370 --> 00:20:37,380
whole bunch of times
 

1039
00:20:37,380 --> 00:20:39,710
whole bunch of times
this concurrently running thread does

1040
00:20:39,710 --> 00:20:39,720
this concurrently running thread does
 

1041
00:20:39,720 --> 00:20:41,480
this concurrently running thread does
indeed observe that Alice Plus Bob is

1042
00:20:41,480 --> 00:20:41,490
indeed observe that Alice Plus Bob is
 

1043
00:20:41,490 --> 00:20:43,700
indeed observe that Alice Plus Bob is
not equal to the overall sum so what

1044
00:20:43,700 --> 00:20:43,710
not equal to the overall sum so what
 

1045
00:20:43,710 --> 00:20:45,740
not equal to the overall sum so what
went wrong here like we're following our

1046
00:20:45,740 --> 00:20:45,750
went wrong here like we're following our
 

1047
00:20:45,750 --> 00:20:47,900
went wrong here like we're following our
basic rule of whenever we're accessing

1048
00:20:47,900 --> 00:20:47,910
basic rule of whenever we're accessing
 

1049
00:20:47,910 --> 00:20:49,490
basic rule of whenever we're accessing
data that's shared between threads we

1050
00:20:49,490 --> 00:20:49,500
data that's shared between threads we
 

1051
00:20:49,500 --> 00:20:52,310
data that's shared between threads we
grab a lock it is indeed true that no

1052
00:20:52,310 --> 00:20:52,320
grab a lock it is indeed true that no
 

1053
00:20:52,320 --> 00:20:54,130
grab a lock it is indeed true that no
updates to these shared variables happen

1054
00:20:54,130 --> 00:20:54,140
updates to these shared variables happen
 

1055
00:20:54,140 --> 00:21:15,530
updates to these shared variables happen
while the lock is not held exactly so

1056
00:21:15,530 --> 00:21:15,540
while the lock is not held exactly so
 

1057
00:21:15,540 --> 00:21:16,909
while the lock is not held exactly so
let me repeat that for everybody to hear

1058
00:21:16,909 --> 00:21:16,919
let me repeat that for everybody to hear
 

1059
00:21:16,919 --> 00:21:19,549
let me repeat that for everybody to hear
what we intended here was for this

1060
00:21:19,549 --> 00:21:19,559
what we intended here was for this
 

1061
00:21:19,559 --> 00:21:21,500
what we intended here was for this
decrement and increment to happen

1062
00:21:21,500 --> 00:21:21,510
decrement and increment to happen
 

1063
00:21:21,510 --> 00:21:23,510
decrement and increment to happen
atomically but instead of what we ended

1064
00:21:23,510 --> 00:21:23,520
atomically but instead of what we ended
 

1065
00:21:23,520 --> 00:21:25,580
atomically but instead of what we ended
up writing was code that decrement

1066
00:21:25,580 --> 00:21:25,590
up writing was code that decrement
 

1067
00:21:25,590 --> 00:21:27,110
up writing was code that decrement
atomically and then increments

1068
00:21:27,110 --> 00:21:27,120
atomically and then increments
 

1069
00:21:27,120 --> 00:21:28,909
atomically and then increments
atomically and so in this particular

1070
00:21:28,909 --> 00:21:28,919
atomically and so in this particular
 

1071
00:21:28,919 --> 00:21:30,950
atomically and so in this particular
code actually like we won't lose money

1072
00:21:30,950 --> 00:21:30,960
code actually like we won't lose money
 

1073
00:21:30,960 --> 00:21:32,720
code actually like we won't lose money
in the long term like if we let these

1074
00:21:32,720 --> 00:21:32,730
in the long term like if we let these
 

1075
00:21:32,730 --> 00:21:34,010
in the long term like if we let these
threads run and then wait till they

1076
00:21:34,010 --> 00:21:34,020
threads run and then wait till they
 

1077
00:21:34,020 --> 00:21:36,020
threads run and then wait till they
finish and then check the total it will

1078
00:21:36,020 --> 00:21:36,030
finish and then check the total it will
 

1079
00:21:36,030 --> 00:21:37,820
finish and then check the total it will
indeed be what it started out as but

1080
00:21:37,820 --> 00:21:37,830
indeed be what it started out as but
 

1081
00:21:37,830 --> 00:21:39,530
indeed be what it started out as but
while these are running since this

1082
00:21:39,530 --> 00:21:39,540
while these are running since this
 

1083
00:21:39,540 --> 00:21:41,840
while these are running since this
entire block of code is not atomic we

1084
00:21:41,840 --> 00:21:41,850
entire block of code is not atomic we
 

1085
00:21:41,850 --> 00:21:44,169
entire block of code is not atomic we
can temporarily observe these violations

1086
00:21:44,169 --> 00:21:44,179
can temporarily observe these violations
 

1087
00:21:44,179 --> 00:21:46,880
can temporarily observe these violations
and so at a higher level the way should

1088
00:21:46,880 --> 00:21:46,890
and so at a higher level the way should
 

1089
00:21:46,890 --> 00:21:49,250
and so at a higher level the way should
think about locking is not just like

1090
00:21:49,250 --> 00:21:49,260
think about locking is not just like
 

1091
00:21:49,260 --> 00:21:51,650
think about locking is not just like
locks are to protect access to shared

1092
00:21:51,650 --> 00:21:51,660
locks are to protect access to shared
 

1093
00:21:51,660 --> 00:21:53,630
locks are to protect access to shared
data but locks are meant to protect

1094
00:21:53,630 --> 00:21:53,640
data but locks are meant to protect
 

1095
00:21:53,640 --> 00:21:55,940
data but locks are meant to protect
invariants you have some shared data

1096
00:21:55,940 --> 00:21:55,950
invariants you have some shared data
 

1097
00:21:55,950 --> 00:21:57,380
invariants you have some shared data
that multiple people might access and

1098
00:21:57,380 --> 00:21:57,390
that multiple people might access and
 

1099
00:21:57,390 --> 00:21:58,760
that multiple people might access and
there's some properties that hold on

1100
00:21:58,760 --> 00:21:58,770
there's some properties that hold on
 

1101
00:21:58,770 --> 00:22:00,799
there's some properties that hold on
that shared data like for example here I

1102
00:22:00,799 --> 00:22:00,809
that shared data like for example here I
 

1103
00:22:00,809 --> 00:22:02,659
that shared data like for example here I
is the programmer decided that I want

1104
00:22:02,659 --> 00:22:02,669
is the programmer decided that I want
 

1105
00:22:02,669 --> 00:22:04,310
is the programmer decided that I want
this property that alice + Bob should

1106
00:22:04,310 --> 00:22:04,320
this property that alice + Bob should
 

1107
00:22:04,320 --> 00:22:05,750
this property that alice + Bob should
equal some constant and that should

1108
00:22:05,750 --> 00:22:05,760
equal some constant and that should
 

1109
00:22:05,760 --> 00:22:07,520
equal some constant and that should
always be that way I want that property

1110
00:22:07,520 --> 00:22:07,530
always be that way I want that property
 

1111
00:22:07,530 --> 00:22:09,230
always be that way I want that property
to hold but then it may be the case that

1112
00:22:09,230 --> 00:22:09,240
to hold but then it may be the case that
 

1113
00:22:09,240 --> 00:22:10,130
to hold but then it may be the case that
different threads running concurrently

1114
00:22:10,130 --> 00:22:10,140
different threads running concurrently
 

1115
00:22:10,140 --> 00:22:12,380
different threads running concurrently
are making changes to this data and

1116
00:22:12,380 --> 00:22:12,390
are making changes to this data and
 

1117
00:22:12,390 --> 00:22:14,600
are making changes to this data and
might temporarily break this invariant

1118
00:22:14,600 --> 00:22:14,610
might temporarily break this invariant
 

1119
00:22:14,610 --> 00:22:16,640
might temporarily break this invariant
here right like here when I decrement

1120
00:22:16,640 --> 00:22:16,650
here right like here when I decrement
 

1121
00:22:16,650 --> 00:22:19,130
here right like here when I decrement
from Alice temporarily the sum Alice

1122
00:22:19,130 --> 00:22:19,140
from Alice temporarily the sum Alice
 

1123
00:22:19,140 --> 00:22:20,750
from Alice temporarily the sum Alice
Plus Bob has changed but then this

1124
00:22:20,750 --> 00:22:20,760
Plus Bob has changed but then this
 

1125
00:22:20,760 --> 00:22:22,549
Plus Bob has changed but then this
thread eventually ends up restoring this

1126
00:22:22,549 --> 00:22:22,559
thread eventually ends up restoring this
 

1127
00:22:22,559 --> 00:22:25,220
thread eventually ends up restoring this
invariant here and so locks are meant to

1128
00:22:25,220 --> 00:22:25,230
invariant here and so locks are meant to
 

1129
00:22:25,230 --> 00:22:25,990
invariant here and so locks are meant to
protect and vary

1130
00:22:25,990 --> 00:22:26,000
protect and vary
 

1131
00:22:26,000 --> 00:22:27,940
protect and vary
at a high level you grab a lock then you

1132
00:22:27,940 --> 00:22:27,950
at a high level you grab a lock then you
 

1133
00:22:27,950 --> 00:22:29,230
at a high level you grab a lock then you
do some work that might temporarily

1134
00:22:29,230 --> 00:22:29,240
do some work that might temporarily
 

1135
00:22:29,240 --> 00:22:31,360
do some work that might temporarily
break the invariant but then you restore

1136
00:22:31,360 --> 00:22:31,370
break the invariant but then you restore
 

1137
00:22:31,370 --> 00:22:32,799
break the invariant but then you restore
the invariant before you release the

1138
00:22:32,799 --> 00:22:32,809
the invariant before you release the
 

1139
00:22:32,809 --> 00:22:34,269
the invariant before you release the
lock so nobody can observe these in

1140
00:22:34,269 --> 00:22:34,279
lock so nobody can observe these in
 

1141
00:22:34,279 --> 00:22:36,399
lock so nobody can observe these in
progress updates and so the correct way

1142
00:22:36,399 --> 00:22:36,409
progress updates and so the correct way
 

1143
00:22:36,409 --> 00:22:38,440
progress updates and so the correct way
to write this code is to actually have

1144
00:22:38,440 --> 00:22:38,450
to write this code is to actually have
 

1145
00:22:38,450 --> 00:22:39,789
to write this code is to actually have
less use of lock and unlock

1146
00:22:39,789 --> 00:22:39,799
less use of lock and unlock
 

1147
00:22:39,799 --> 00:22:41,799
less use of lock and unlock
we have lock then we do a bunch of work

1148
00:22:41,799 --> 00:22:41,809
we have lock then we do a bunch of work
 

1149
00:22:41,809 --> 00:22:43,749
we have lock then we do a bunch of work
and then we unlock and when you run this

1150
00:22:43,749 --> 00:22:43,759
and then we unlock and when you run this
 

1151
00:22:43,759 --> 00:22:48,249
and then we unlock and when you run this
code we see no more printouts like this

1152
00:22:48,249 --> 00:22:48,259
code we see no more printouts like this
 

1153
00:22:48,259 --> 00:22:50,379
code we see no more printouts like this
that we never have this audit thread

1154
00:22:50,379 --> 00:22:50,389
that we never have this audit thread
 

1155
00:22:50,389 --> 00:22:52,480
that we never have this audit thread
observe that the total is not what it

1156
00:22:52,480 --> 00:22:52,490
observe that the total is not what it
 

1157
00:22:52,490 --> 00:22:55,570
observe that the total is not what it
should be all right so that's the right

1158
00:22:55,570 --> 00:22:55,580
should be all right so that's the right
 

1159
00:22:55,580 --> 00:22:58,960
should be all right so that's the right
way to think about locking at kind of a

1160
00:22:58,960 --> 00:22:58,970
way to think about locking at kind of a
 

1161
00:22:58,970 --> 00:23:00,669
way to think about locking at kind of a
high level you can think about it as

1162
00:23:00,669 --> 00:23:00,679
high level you can think about it as
 

1163
00:23:00,679 --> 00:23:02,289
high level you can think about it as
make sure you grab locks when every

1164
00:23:02,289 --> 00:23:02,299
make sure you grab locks when every
 

1165
00:23:02,299 --> 00:23:03,759
make sure you grab locks when every
access shared data like that is a rule

1166
00:23:03,759 --> 00:23:03,769
access shared data like that is a rule
 

1167
00:23:03,769 --> 00:23:06,759
access shared data like that is a rule
but another important rule is locks

1168
00:23:06,759 --> 00:23:06,769
but another important rule is locks
 

1169
00:23:06,769 --> 00:23:09,190
but another important rule is locks
protect invariants so grab a lock

1170
00:23:09,190 --> 00:23:09,200
protect invariants so grab a lock
 

1171
00:23:09,200 --> 00:23:10,779
protect invariants so grab a lock
manipulate things in a way that might

1172
00:23:10,779 --> 00:23:10,789
manipulate things in a way that might
 

1173
00:23:10,789 --> 00:23:12,039
manipulate things in a way that might
break the invariants but restore them

1174
00:23:12,039 --> 00:23:12,049
break the invariants but restore them
 

1175
00:23:12,049 --> 00:23:15,480
break the invariants but restore them
afterwards and then release the lock

1176
00:23:15,480 --> 00:23:15,490
afterwards and then release the lock
 

1177
00:23:15,490 --> 00:23:17,320
afterwards and then release the lock
another way you can think about it is

1178
00:23:17,320 --> 00:23:17,330
another way you can think about it is
 

1179
00:23:17,330 --> 00:23:19,269
another way you can think about it is
locks can make regions of code atomic

1180
00:23:19,269 --> 00:23:19,279
locks can make regions of code atomic
 

1181
00:23:19,279 --> 00:23:21,129
locks can make regions of code atomic
not just like single statements or

1182
00:23:21,129 --> 00:23:21,139
not just like single statements or
 

1183
00:23:21,139 --> 00:23:26,049
not just like single statements or
single updates to shared variables any

1184
00:23:26,049 --> 00:23:26,059
single updates to shared variables any
 

1185
00:23:26,059 --> 00:23:30,850
single updates to shared variables any
questions about that great so the next

1186
00:23:30,850 --> 00:23:30,860
questions about that great so the next
 

1187
00:23:30,860 --> 00:23:32,830
questions about that great so the next
synchronization primitive we're going to

1188
00:23:32,830 --> 00:23:32,840
synchronization primitive we're going to
 

1189
00:23:32,840 --> 00:23:34,090
synchronization primitive we're going to
talk about it something called condition

1190
00:23:34,090 --> 00:23:34,100
talk about it something called condition
 

1191
00:23:34,100 --> 00:23:37,060
talk about it something called condition
variables and this is it seems like

1192
00:23:37,060 --> 00:23:37,070
variables and this is it seems like
 

1193
00:23:37,070 --> 00:23:38,200
variables and this is it seems like
there's been a source of confusion from

1194
00:23:38,200 --> 00:23:38,210
there's been a source of confusion from
 

1195
00:23:38,210 --> 00:23:39,369
there's been a source of confusion from
lab one where we mentioned condition

1196
00:23:39,369 --> 00:23:39,379
lab one where we mentioned condition
 

1197
00:23:39,379 --> 00:23:40,690
lab one where we mentioned condition
variables but didn't quite explain them

1198
00:23:40,690 --> 00:23:40,700
variables but didn't quite explain them
 

1199
00:23:40,700 --> 00:23:41,590
variables but didn't quite explain them
so we're going to take the time to

1200
00:23:41,590 --> 00:23:41,600
so we're going to take the time to
 

1201
00:23:41,600 --> 00:23:43,539
so we're going to take the time to
explain them to you now and we're going

1202
00:23:43,539 --> 00:23:43,549
explain them to you now and we're going
 

1203
00:23:43,549 --> 00:23:45,460
explain them to you now and we're going
to do that in the context of an example

1204
00:23:45,460 --> 00:23:45,470
to do that in the context of an example
 

1205
00:23:45,470 --> 00:23:47,639
to do that in the context of an example
that you should all be familiar with

1206
00:23:47,639 --> 00:23:47,649
that you should all be familiar with
 

1207
00:23:47,649 --> 00:23:51,100
that you should all be familiar with
counting votes so remember in lab 2a you

1208
00:23:51,100 --> 00:23:51,110
counting votes so remember in lab 2a you
 

1209
00:23:51,110 --> 00:23:53,019
counting votes so remember in lab 2a you
have this pattern where whenever Raph

1210
00:23:53,019 --> 00:23:53,029
have this pattern where whenever Raph
 

1211
00:23:53,029 --> 00:23:54,879
have this pattern where whenever Raph
Pierre becomes a candidate it wants to

1212
00:23:54,879 --> 00:23:54,889
Pierre becomes a candidate it wants to
 

1213
00:23:54,889 --> 00:23:56,350
Pierre becomes a candidate it wants to
send out vote requests all of its

1214
00:23:56,350 --> 00:23:56,360
send out vote requests all of its
 

1215
00:23:56,360 --> 00:23:58,869
send out vote requests all of its
followers and eventually the followers

1216
00:23:58,869 --> 00:23:58,879
followers and eventually the followers
 

1217
00:23:58,879 --> 00:24:01,480
followers and eventually the followers
come back to the candidate and say yes

1218
00:24:01,480 --> 00:24:01,490
come back to the candidate and say yes
 

1219
00:24:01,490 --> 00:24:02,860
come back to the candidate and say yes
or no like whether or not the candidate

1220
00:24:02,860 --> 00:24:02,870
or no like whether or not the candidate
 

1221
00:24:02,870 --> 00:24:04,600
or no like whether or not the candidate
got the vote right and one way we could

1222
00:24:04,600 --> 00:24:04,610
got the vote right and one way we could
 

1223
00:24:04,610 --> 00:24:06,669
got the vote right and one way we could
write this code is have the candidate in

1224
00:24:06,669 --> 00:24:06,679
write this code is have the candidate in
 

1225
00:24:06,679 --> 00:24:09,039
write this code is have the candidate in
serial ask Pierre number one car number

1226
00:24:09,039 --> 00:24:09,049
serial ask Pierre number one car number
 

1227
00:24:09,049 --> 00:24:10,570
serial ask Pierre number one car number
two for number three and so on but

1228
00:24:10,570 --> 00:24:10,580
two for number three and so on but
 

1229
00:24:10,580 --> 00:24:12,399
two for number three and so on but
that's bad right because we want the

1230
00:24:12,399 --> 00:24:12,409
that's bad right because we want the
 

1231
00:24:12,409 --> 00:24:14,080
that's bad right because we want the
candidate ask all the peers in parallel

1232
00:24:14,080 --> 00:24:14,090
candidate ask all the peers in parallel
 

1233
00:24:14,090 --> 00:24:15,519
candidate ask all the peers in parallel
so it can quickly win the election when

1234
00:24:15,519 --> 00:24:15,529
so it can quickly win the election when
 

1235
00:24:15,529 --> 00:24:17,019
so it can quickly win the election when
possible and then there's some other

1236
00:24:17,019 --> 00:24:17,029
possible and then there's some other
 

1237
00:24:17,029 --> 00:24:19,149
possible and then there's some other
complexities there like when we ask all

1238
00:24:19,149 --> 00:24:19,159
complexities there like when we ask all
 

1239
00:24:19,159 --> 00:24:21,399
complexities there like when we ask all
the peers in parallel we don't want to

1240
00:24:21,399 --> 00:24:21,409
the peers in parallel we don't want to
 

1241
00:24:21,409 --> 00:24:22,899
the peers in parallel we don't want to
wait so we get a response from all of

1242
00:24:22,899 --> 00:24:22,909
wait so we get a response from all of
 

1243
00:24:22,909 --> 00:24:24,279
wait so we get a response from all of
them before making up our mind right

1244
00:24:24,279 --> 00:24:24,289
them before making up our mind right
 

1245
00:24:24,289 --> 00:24:25,899
them before making up our mind right
because if a candidate gets a majority

1246
00:24:25,899 --> 00:24:25,909
because if a candidate gets a majority
 

1247
00:24:25,909 --> 00:24:27,759
because if a candidate gets a majority
of votes like it doesn't need to wait

1248
00:24:27,759 --> 00:24:27,769
of votes like it doesn't need to wait
 

1249
00:24:27,769 --> 00:24:29,200
of votes like it doesn't need to wait
till it hears back from everybody else

1250
00:24:29,200 --> 00:24:29,210
till it hears back from everybody else
 

1251
00:24:29,210 --> 00:24:31,480
till it hears back from everybody else
so this code is kind of complicated in

1252
00:24:31,480 --> 00:24:31,490
so this code is kind of complicated in
 

1253
00:24:31,490 --> 00:24:34,919
so this code is kind of complicated in
some ways and so here here's a kind of

1254
00:24:34,919 --> 00:24:34,929
some ways and so here here's a kind of
 

1255
00:24:34,929 --> 00:24:37,029
some ways and so here here's a kind of
stubbed out version of what that vote

1256
00:24:37,029 --> 00:24:37,039
stubbed out version of what that vote
 

1257
00:24:37,039 --> 00:24:39,100
stubbed out version of what that vote
counting code might look like

1258
00:24:39,100 --> 00:24:39,110
counting code might look like
 

1259
00:24:39,110 --> 00:24:40,240
counting code might look like
with a little bit of infrastructure to

1260
00:24:40,240 --> 00:24:40,250
with a little bit of infrastructure to
 

1261
00:24:40,250 --> 00:24:41,769
with a little bit of infrastructure to
make it actually run and so here have

1262
00:24:41,769 --> 00:24:41,779
make it actually run and so here have
 

1263
00:24:41,779 --> 00:24:43,389
make it actually run and so here have
this mean goroutine that sets count

1264
00:24:43,389 --> 00:24:43,399
this mean goroutine that sets count
 

1265
00:24:43,399 --> 00:24:44,919
this mean goroutine that sets count
which is like the number of yes votes I

1266
00:24:44,919 --> 00:24:44,929
which is like the number of yes votes I
 

1267
00:24:44,929 --> 00:24:47,560
which is like the number of yes votes I
got to zero and finish to zero finished

1268
00:24:47,560 --> 00:24:47,570
got to zero and finish to zero finished
 

1269
00:24:47,570 --> 00:24:48,850
got to zero and finish to zero finished
as the number of responses I've gotten

1270
00:24:48,850 --> 00:24:48,860
as the number of responses I've gotten
 

1271
00:24:48,860 --> 00:24:50,769
as the number of responses I've gotten
in total and the idea is I want to send

1272
00:24:50,769 --> 00:24:50,779
in total and the idea is I want to send
 

1273
00:24:50,779 --> 00:24:52,659
in total and the idea is I want to send
out vote requests in parallel and keep

1274
00:24:52,659 --> 00:24:52,669
out vote requests in parallel and keep
 

1275
00:24:52,669 --> 00:24:54,399
out vote requests in parallel and keep
track of how many yeses I've got and how

1276
00:24:54,399 --> 00:24:54,409
track of how many yeses I've got and how
 

1277
00:24:54,409 --> 00:24:55,840
track of how many yeses I've got and how
many responses I've gotten in general

1278
00:24:55,840 --> 00:24:55,850
many responses I've gotten in general
 

1279
00:24:55,850 --> 00:24:58,240
many responses I've gotten in general
and then once I know whether I've won

1280
00:24:58,240 --> 00:24:58,250
and then once I know whether I've won
 

1281
00:24:58,250 --> 00:24:59,710
and then once I know whether I've won
the election or whether I know that I've

1282
00:24:59,710 --> 00:24:59,720
the election or whether I know that I've
 

1283
00:24:59,720 --> 00:25:01,930
the election or whether I know that I've
lost the election then I can determine

1284
00:25:01,930 --> 00:25:01,940
lost the election then I can determine
 

1285
00:25:01,940 --> 00:25:03,880
lost the election then I can determine
that and move on and like the real raft

1286
00:25:03,880 --> 00:25:03,890
that and move on and like the real raft
 

1287
00:25:03,890 --> 00:25:05,169
that and move on and like the real raft
code you actually do whatever you need

1288
00:25:05,169 --> 00:25:05,179
code you actually do whatever you need
 

1289
00:25:05,179 --> 00:25:07,840
code you actually do whatever you need
to do don't step up to a leader or to

1290
00:25:07,840 --> 00:25:07,850
to do don't step up to a leader or to
 

1291
00:25:07,850 --> 00:25:10,029
to do don't step up to a leader or to
step down to a follower after you have

1292
00:25:10,029 --> 00:25:10,039
step down to a follower after you have
 

1293
00:25:10,039 --> 00:25:12,759
step down to a follower after you have
the result from this and so looking at

1294
00:25:12,759 --> 00:25:12,769
the result from this and so looking at
 

1295
00:25:12,769 --> 00:25:15,039
the result from this and so looking at
this code here I'm going to in parallel

1296
00:25:15,039 --> 00:25:15,049
this code here I'm going to in parallel
 

1297
00:25:15,049 --> 00:25:17,470
this code here I'm going to in parallel
spun say I have ten peers in parallel

1298
00:25:17,470 --> 00:25:17,480
spun say I have ten peers in parallel
 

1299
00:25:17,480 --> 00:25:18,730
spun say I have ten peers in parallel
spawn ten goroutines

1300
00:25:18,730 --> 00:25:18,740
spawn ten goroutines
 

1301
00:25:18,740 --> 00:25:20,889
spawn ten goroutines
here I pass in this closure here and I'm

1302
00:25:20,889 --> 00:25:20,899
here I pass in this closure here and I'm
 

1303
00:25:20,899 --> 00:25:23,259
here I pass in this closure here and I'm
gonna do is request a vote and then if I

1304
00:25:23,259 --> 00:25:23,269
gonna do is request a vote and then if I
 

1305
00:25:23,269 --> 00:25:24,850
gonna do is request a vote and then if I
get the vote I'm going to increment the

1306
00:25:24,850 --> 00:25:24,860
get the vote I'm going to increment the
 

1307
00:25:24,860 --> 00:25:26,620
get the vote I'm going to increment the
count by one and then I'm also going to

1308
00:25:26,620 --> 00:25:26,630
count by one and then I'm also going to
 

1309
00:25:26,630 --> 00:25:28,419
count by one and then I'm also going to
increment this finished by one so like

1310
00:25:28,419 --> 00:25:28,429
increment this finished by one so like
 

1311
00:25:28,429 --> 00:25:30,220
increment this finished by one so like
this is a number of yeses this is total

1312
00:25:30,220 --> 00:25:30,230
this is a number of yeses this is total
 

1313
00:25:30,230 --> 00:25:32,200
this is a number of yeses this is total
number of responses I've gotten and then

1314
00:25:32,200 --> 00:25:32,210
number of responses I've gotten and then
 

1315
00:25:32,210 --> 00:25:34,299
number of responses I've gotten and then
outside here in the main go routine what

1316
00:25:34,299 --> 00:25:34,309
outside here in the main go routine what
 

1317
00:25:34,309 --> 00:25:35,440
outside here in the main go routine what
I'm doing is keeping track of this

1318
00:25:35,440 --> 00:25:35,450
I'm doing is keeping track of this
 

1319
00:25:35,450 --> 00:25:36,850
I'm doing is keeping track of this
condition I'm waiting for this condition

1320
00:25:36,850 --> 00:25:36,860
condition I'm waiting for this condition
 

1321
00:25:36,860 --> 00:25:38,740
condition I'm waiting for this condition
to become true that either I have enough

1322
00:25:38,740 --> 00:25:38,750
to become true that either I have enough
 

1323
00:25:38,750 --> 00:25:40,480
to become true that either I have enough
yes votes that I've won the election or

1324
00:25:40,480 --> 00:25:40,490
yes votes that I've won the election or
 

1325
00:25:40,490 --> 00:25:42,430
yes votes that I've won the election or
I've heard back from enough peers and I

1326
00:25:42,430 --> 00:25:42,440
I've heard back from enough peers and I
 

1327
00:25:42,440 --> 00:25:44,200
I've heard back from enough peers and I
know that I've lost and so I'm just

1328
00:25:44,200 --> 00:25:44,210
know that I've lost and so I'm just
 

1329
00:25:44,210 --> 00:25:47,019
know that I've lost and so I'm just
going to in a in a loop check to see and

1330
00:25:47,019 --> 00:25:47,029
going to in a in a loop check to see and
 

1331
00:25:47,029 --> 00:25:49,419
going to in a in a loop check to see and
wait until count is greater than or

1332
00:25:49,419 --> 00:25:49,429
wait until count is greater than or
 

1333
00:25:49,429 --> 00:25:51,549
wait until count is greater than or
equal to five or wait until finished is

1334
00:25:51,549 --> 00:25:51,559
equal to five or wait until finished is
 

1335
00:25:51,559 --> 00:25:53,320
equal to five or wait until finished is
equal to ten and then after that's the

1336
00:25:53,320 --> 00:25:53,330
equal to ten and then after that's the
 

1337
00:25:53,330 --> 00:25:54,940
equal to ten and then after that's the
case I can either determine that I've

1338
00:25:54,940 --> 00:25:54,950
case I can either determine that I've
 

1339
00:25:54,950 --> 00:25:56,830
case I can either determine that I've
lost drive one so does anybody see any

1340
00:25:56,830 --> 00:25:56,840
lost drive one so does anybody see any
 

1341
00:25:56,840 --> 00:25:58,659
lost drive one so does anybody see any
problems with this code given what we

1342
00:25:58,659 --> 00:25:58,669
problems with this code given what we
 

1343
00:25:58,669 --> 00:26:04,760
problems with this code given what we
just talked about about mutexes yes

1344
00:26:04,760 --> 00:26:04,770

 

1345
00:26:04,770 --> 00:26:06,420

yeah exactly

1346
00:26:06,420 --> 00:26:06,430
yeah exactly
 

1347
00:26:06,430 --> 00:26:07,980
yeah exactly
countin finished aren't protected by

1348
00:26:07,980 --> 00:26:07,990
countin finished aren't protected by
 

1349
00:26:07,990 --> 00:26:10,110
countin finished aren't protected by
mutexes so one thing we certainly need

1350
00:26:10,110 --> 00:26:10,120
mutexes so one thing we certainly need
 

1351
00:26:10,120 --> 00:26:13,410
mutexes so one thing we certainly need
to fix here is that whenever we have

1352
00:26:13,410 --> 00:26:13,420
to fix here is that whenever we have
 

1353
00:26:13,420 --> 00:26:15,000
to fix here is that whenever we have
shared variables we need to protect

1354
00:26:15,000 --> 00:26:15,010
shared variables we need to protect
 

1355
00:26:15,010 --> 00:26:17,490
shared variables we need to protect
access with new taxes and so that's not

1356
00:26:17,490 --> 00:26:17,500
access with new taxes and so that's not
 

1357
00:26:17,500 --> 00:26:21,030
access with new taxes and so that's not
too bad to fix here I declare mutex

1358
00:26:21,030 --> 00:26:21,040
too bad to fix here I declare mutex
 

1359
00:26:21,040 --> 00:26:23,100
too bad to fix here I declare mutex
that's accessible by everybody and then

1360
00:26:23,100 --> 00:26:23,110
that's accessible by everybody and then
 

1361
00:26:23,110 --> 00:26:25,470
that's accessible by everybody and then
in the go routines I'm launching in

1362
00:26:25,470 --> 00:26:25,480
in the go routines I'm launching in
 

1363
00:26:25,480 --> 00:26:27,540
in the go routines I'm launching in
parallel to request votes I'm going to

1364
00:26:27,540 --> 00:26:27,550
parallel to request votes I'm going to
 

1365
00:26:27,550 --> 00:26:29,310
parallel to request votes I'm going to
and this this pattern here is pretty

1366
00:26:29,310 --> 00:26:29,320
and this this pattern here is pretty
 

1367
00:26:29,320 --> 00:26:30,930
and this this pattern here is pretty
important I'm going to first request a

1368
00:26:30,930 --> 00:26:30,940
important I'm going to first request a
 

1369
00:26:30,940 --> 00:26:33,120
important I'm going to first request a
vote while I'm not holding the lock and

1370
00:26:33,120 --> 00:26:33,130
vote while I'm not holding the lock and
 

1371
00:26:33,130 --> 00:26:34,410
vote while I'm not holding the lock and
then after wear that I'm going to grab

1372
00:26:34,410 --> 00:26:34,420
then after wear that I'm going to grab
 

1373
00:26:34,420 --> 00:26:35,760
then after wear that I'm going to grab
the lock and then update these shared

1374
00:26:35,760 --> 00:26:35,770
the lock and then update these shared
 

1375
00:26:35,770 --> 00:26:40,320
the lock and then update these shared
variables and then outside I have the

1376
00:26:40,320 --> 00:26:40,330
variables and then outside I have the
 

1377
00:26:40,330 --> 00:26:41,820
variables and then outside I have the
same patterns as before except I make

1378
00:26:41,820 --> 00:26:41,830
same patterns as before except I make
 

1379
00:26:41,830 --> 00:26:43,770
same patterns as before except I make
sure to lock and unlock between reading

1380
00:26:43,770 --> 00:26:43,780
sure to lock and unlock between reading
 

1381
00:26:43,780 --> 00:26:45,720
sure to lock and unlock between reading
these shared variables so in an infinite

1382
00:26:45,720 --> 00:26:45,730
these shared variables so in an infinite
 

1383
00:26:45,730 --> 00:26:48,270
these shared variables so in an infinite
loop I grab the lock and check to see if

1384
00:26:48,270 --> 00:26:48,280
loop I grab the lock and check to see if
 

1385
00:26:48,280 --> 00:26:49,800
loop I grab the lock and check to see if
the results of the election have been

1386
00:26:49,800 --> 00:26:49,810
the results of the election have been
 

1387
00:26:49,810 --> 00:26:51,750
the results of the election have been
determined by this point and if not I'm

1388
00:26:51,750 --> 00:26:51,760
determined by this point and if not I'm
 

1389
00:26:51,760 --> 00:26:52,830
determined by this point and if not I'm
going to keep running in this infinite

1390
00:26:52,830 --> 00:26:52,840
going to keep running in this infinite
 

1391
00:26:52,840 --> 00:26:57,810
going to keep running in this infinite
loop otherwise I'll unlock and then do

1392
00:26:57,810 --> 00:26:57,820
loop otherwise I'll unlock and then do
 

1393
00:26:57,820 --> 00:27:00,990
loop otherwise I'll unlock and then do
what I need to do outside of here and so

1394
00:27:00,990 --> 00:27:01,000
what I need to do outside of here and so
 

1395
00:27:01,000 --> 00:27:09,420
what I need to do outside of here and so
if I run this example whoops it seems to

1396
00:27:09,420 --> 00:27:09,430
if I run this example whoops it seems to
 

1397
00:27:09,430 --> 00:27:12,840
if I run this example whoops it seems to
work and this is actually like a correct

1398
00:27:12,840 --> 00:27:12,850
work and this is actually like a correct
 

1399
00:27:12,850 --> 00:27:14,760
work and this is actually like a correct
implementation it does the right thing

1400
00:27:14,760 --> 00:27:14,770
implementation it does the right thing
 

1401
00:27:14,770 --> 00:27:16,950
implementation it does the right thing
but there's some problems with it so can

1402
00:27:16,950 --> 00:27:16,960
but there's some problems with it so can
 

1403
00:27:16,960 --> 00:27:18,360
but there's some problems with it so can
anybody recognize any problems with this

1404
00:27:18,360 --> 00:27:18,370
anybody recognize any problems with this
 

1405
00:27:18,370 --> 00:27:22,980
anybody recognize any problems with this
implementation I'll give you a hint this

1406
00:27:22,980 --> 00:27:22,990
implementation I'll give you a hint this
 

1407
00:27:22,990 --> 00:27:32,400
implementation I'll give you a hint this
code is not as nice as it could be

1408
00:27:32,400 --> 00:27:32,410

 

1409
00:27:32,410 --> 00:27:35,050

so not quite it's going to wait for

1410
00:27:35,050 --> 00:27:35,060
so not quite it's going to wait for
 

1411
00:27:35,060 --> 00:27:37,060
so not quite it's going to wait for
exactly the right amount of time the

1412
00:27:37,060 --> 00:27:37,070
exactly the right amount of time the
 

1413
00:27:37,070 --> 00:27:39,160
exactly the right amount of time the
issue here is that it's busy waiting

1414
00:27:39,160 --> 00:27:39,170
issue here is that it's busy waiting
 

1415
00:27:39,170 --> 00:27:41,860
issue here is that it's busy waiting
what it's doing is in a very tight loop

1416
00:27:41,860 --> 00:27:41,870
what it's doing is in a very tight loop
 

1417
00:27:41,870 --> 00:27:43,510
what it's doing is in a very tight loop
it's grabbing the lock checking this

1418
00:27:43,510 --> 00:27:43,520
it's grabbing the lock checking this
 

1419
00:27:43,520 --> 00:27:45,700
it's grabbing the lock checking this
condition unlocking grabbing this lock

1420
00:27:45,700 --> 00:27:45,710
condition unlocking grabbing this lock
 

1421
00:27:45,710 --> 00:27:47,080
condition unlocking grabbing this lock
checking this condition unlocking and

1422
00:27:47,080 --> 00:27:47,090
checking this condition unlocking and
 

1423
00:27:47,090 --> 00:27:49,420
checking this condition unlocking and
it's going to burn up 100% CPU on one

1424
00:27:49,420 --> 00:27:49,430
it's going to burn up 100% CPU on one
 

1425
00:27:49,430 --> 00:27:51,610
it's going to burn up 100% CPU on one
core while it's doing this so this code

1426
00:27:51,610 --> 00:27:51,620
core while it's doing this so this code
 

1427
00:27:51,620 --> 00:27:54,010
core while it's doing this so this code
is correct but it's like at a high level

1428
00:27:54,010 --> 00:27:54,020
is correct but it's like at a high level
 

1429
00:27:54,020 --> 00:27:55,960
is correct but it's like at a high level
we don't care about efficiency like CPU

1430
00:27:55,960 --> 00:27:55,970
we don't care about efficiency like CPU
 

1431
00:27:55,970 --> 00:27:57,610
we don't care about efficiency like CPU
efficiency for the purpose of the labs

1432
00:27:57,610 --> 00:27:57,620
efficiency for the purpose of the labs
 

1433
00:27:57,620 --> 00:27:59,830
efficiency for the purpose of the labs
but if you're using a hundred percent of

1434
00:27:59,830 --> 00:27:59,840
but if you're using a hundred percent of
 

1435
00:27:59,840 --> 00:28:01,240
but if you're using a hundred percent of
one core you might actually slow down

1436
00:28:01,240 --> 00:28:01,250
one core you might actually slow down
 

1437
00:28:01,250 --> 00:28:02,650
one core you might actually slow down
the rest of your program enough that it

1438
00:28:02,650 --> 00:28:02,660
the rest of your program enough that it
 

1439
00:28:02,660 --> 00:28:05,110
the rest of your program enough that it
won't make progress and so that's why

1440
00:28:05,110 --> 00:28:05,120
won't make progress and so that's why
 

1441
00:28:05,120 --> 00:28:06,700
won't make progress and so that's why
this pattern is bad that we're burning

1442
00:28:06,700 --> 00:28:06,710
this pattern is bad that we're burning
 

1443
00:28:06,710 --> 00:28:08,560
this pattern is bad that we're burning
up a hundred percent CPU waiting for

1444
00:28:08,560 --> 00:28:08,570
up a hundred percent CPU waiting for
 

1445
00:28:08,570 --> 00:28:10,750
up a hundred percent CPU waiting for
some condition to become true right so

1446
00:28:10,750 --> 00:28:10,760
some condition to become true right so
 

1447
00:28:10,760 --> 00:28:12,100
some condition to become true right so
does anybody have any ideas for how we

1448
00:28:12,100 --> 00:28:12,110
does anybody have any ideas for how we
 

1449
00:28:12,110 --> 00:28:18,070
does anybody have any ideas for how we
could fix this so here's one simple

1450
00:28:18,070 --> 00:28:18,080
could fix this so here's one simple
 

1451
00:28:18,080 --> 00:28:18,760
could fix this so here's one simple
solution

1452
00:28:18,760 --> 00:28:18,770
solution
 

1453
00:28:18,770 --> 00:28:23,140
solution
I will change a single line of code all

1454
00:28:23,140 --> 00:28:23,150
I will change a single line of code all
 

1455
00:28:23,150 --> 00:28:25,270
I will change a single line of code all
I've added here is wait for 50

1456
00:28:25,270 --> 00:28:25,280
I've added here is wait for 50
 

1457
00:28:25,280 --> 00:28:28,660
I've added here is wait for 50
milliseconds and so this is a correct

1458
00:28:28,660 --> 00:28:28,670
milliseconds and so this is a correct
 

1459
00:28:28,670 --> 00:28:30,550
milliseconds and so this is a correct
transformation of that program and it

1460
00:28:30,550 --> 00:28:30,560
transformation of that program and it
 

1461
00:28:30,560 --> 00:28:32,020
transformation of that program and it
kind of seems to solve the problem right

1462
00:28:32,020 --> 00:28:32,030
kind of seems to solve the problem right
 

1463
00:28:32,030 --> 00:28:33,610
kind of seems to solve the problem right
like before I was burning up a hundred

1464
00:28:33,610 --> 00:28:33,620
like before I was burning up a hundred
 

1465
00:28:33,620 --> 00:28:36,370
like before I was burning up a hundred
percent CPU now only once every 50

1466
00:28:36,370 --> 00:28:36,380
percent CPU now only once every 50
 

1467
00:28:36,380 --> 00:28:37,570
percent CPU now only once every 50
milliseconds I'm going to briefly wake

1468
00:28:37,570 --> 00:28:37,580
milliseconds I'm going to briefly wake
 

1469
00:28:37,580 --> 00:28:39,760
milliseconds I'm going to briefly wake
up check this condition and go back to

1470
00:28:39,760 --> 00:28:39,770
up check this condition and go back to
 

1471
00:28:39,770 --> 00:28:40,210
up check this condition and go back to
sleep

1472
00:28:40,210 --> 00:28:40,220
sleep
 

1473
00:28:40,220 --> 00:28:43,060
sleep
if it doesn't hold and so this is like

1474
00:28:43,060 --> 00:28:43,070
if it doesn't hold and so this is like
 

1475
00:28:43,070 --> 00:28:46,300
if it doesn't hold and so this is like
basically a working solution any

1476
00:28:46,300 --> 00:28:46,310
basically a working solution any
 

1477
00:28:46,310 --> 00:28:51,670
basically a working solution any
questions so this kind of sorta works

1478
00:28:51,670 --> 00:28:51,680
questions so this kind of sorta works
 

1479
00:28:51,680 --> 00:28:53,200
questions so this kind of sorta works
but one thing you should always be aware

1480
00:28:53,200 --> 00:28:53,210
but one thing you should always be aware
 

1481
00:28:53,210 --> 00:28:55,870
but one thing you should always be aware
of whenever you write code is magic

1482
00:28:55,870 --> 00:28:55,880
of whenever you write code is magic
 

1483
00:28:55,880 --> 00:28:58,360
of whenever you write code is magic
constants why is this 50 milliseconds

1484
00:28:58,360 --> 00:28:58,370
constants why is this 50 milliseconds
 

1485
00:28:58,370 --> 00:29:00,130
constants why is this 50 milliseconds
why not a different number like whenever

1486
00:29:00,130 --> 00:29:00,140
why not a different number like whenever
 

1487
00:29:00,140 --> 00:29:01,270
why not a different number like whenever
you have an arbitrary number in your

1488
00:29:01,270 --> 00:29:01,280
you have an arbitrary number in your
 

1489
00:29:01,280 --> 00:29:02,800
you have an arbitrary number in your
code it's a sign that you're doing

1490
00:29:02,800 --> 00:29:02,810
code it's a sign that you're doing
 

1491
00:29:02,810 --> 00:29:04,630
code it's a sign that you're doing
something that's not quite right or not

1492
00:29:04,630 --> 00:29:04,640
something that's not quite right or not
 

1493
00:29:04,640 --> 00:29:07,000
something that's not quite right or not
quite as clean as it could be and so it

1494
00:29:07,000 --> 00:29:07,010
quite as clean as it could be and so it
 

1495
00:29:07,010 --> 00:29:08,230
quite as clean as it could be and so it
turns out that there's a concurrency

1496
00:29:08,230 --> 00:29:08,240
turns out that there's a concurrency
 

1497
00:29:08,240 --> 00:29:10,300
turns out that there's a concurrency
primitive designed to solve exactly this

1498
00:29:10,300 --> 00:29:10,310
primitive designed to solve exactly this
 

1499
00:29:10,310 --> 00:29:12,790
primitive designed to solve exactly this
problem of I have some threads running

1500
00:29:12,790 --> 00:29:12,800
problem of I have some threads running
 

1501
00:29:12,800 --> 00:29:15,310
problem of I have some threads running
concurrently that are making updates to

1502
00:29:15,310 --> 00:29:15,320
concurrently that are making updates to
 

1503
00:29:15,320 --> 00:29:17,050
concurrently that are making updates to
some shared data and then I have another

1504
00:29:17,050 --> 00:29:17,060
some shared data and then I have another
 

1505
00:29:17,060 --> 00:29:19,240
some shared data and then I have another
thread that's waiting for some property

1506
00:29:19,240 --> 00:29:19,250
thread that's waiting for some property
 

1507
00:29:19,250 --> 00:29:21,070
thread that's waiting for some property
some condition on that shared data to

1508
00:29:21,070 --> 00:29:21,080
some condition on that shared data to
 

1509
00:29:21,080 --> 00:29:22,720
some condition on that shared data to
become true and until that condition

1510
00:29:22,720 --> 00:29:22,730
become true and until that condition
 

1511
00:29:22,730 --> 00:29:24,160
become true and until that condition
becomes true the thread is just going to

1512
00:29:24,160 --> 00:29:24,170
becomes true the thread is just going to
 

1513
00:29:24,170 --> 00:29:26,650
becomes true the thread is just going to
wait there's a tool designed exactly to

1514
00:29:26,650 --> 00:29:26,660
wait there's a tool designed exactly to
 

1515
00:29:26,660 --> 00:29:28,240
wait there's a tool designed exactly to
solve this problem and that's a tool

1516
00:29:28,240 --> 00:29:28,250
solve this problem and that's a tool
 

1517
00:29:28,250 --> 00:29:33,850
solve this problem and that's a tool
called a condition variable and the way

1518
00:29:33,850 --> 00:29:33,860
called a condition variable and the way
 

1519
00:29:33,860 --> 00:29:36,970
called a condition variable and the way
you use a condition variable is the

1520
00:29:36,970 --> 00:29:36,980
you use a condition variable is the
 

1521
00:29:36,980 --> 00:29:38,950
you use a condition variable is the
pattern basically looks like this so we

1522
00:29:38,950 --> 00:29:38,960
pattern basically looks like this so we
 

1523
00:29:38,960 --> 00:29:40,780
pattern basically looks like this so we
have our lock from earlier condition

1524
00:29:40,780 --> 00:29:40,790
have our lock from earlier condition
 

1525
00:29:40,790 --> 00:29:43,389
have our lock from earlier condition
variables are associated with locks so

1526
00:29:43,389 --> 00:29:43,399
variables are associated with locks so
 

1527
00:29:43,399 --> 00:29:46,719
variables are associated with locks so
we have some shared data some a lock

1528
00:29:46,719 --> 00:29:46,729
we have some shared data some a lock
 

1529
00:29:46,729 --> 00:29:48,430
we have some shared data some a lock
that protects that shared data and then

1530
00:29:48,430 --> 00:29:48,440
that protects that shared data and then
 

1531
00:29:48,440 --> 00:29:49,989
that protects that shared data and then
we have this condition variable that is

1532
00:29:49,989 --> 00:29:49,999
we have this condition variable that is
 

1533
00:29:49,999 --> 00:29:51,399
we have this condition variable that is
given a pointer to the lock when it's

1534
00:29:51,399 --> 00:29:51,409
given a pointer to the lock when it's
 

1535
00:29:51,409 --> 00:29:53,139
given a pointer to the lock when it's
initialized and we're going to use this

1536
00:29:53,139 --> 00:29:53,149
initialized and we're going to use this
 

1537
00:29:53,149 --> 00:29:54,639
initialized and we're going to use this
condition variable for kind of

1538
00:29:54,639 --> 00:29:54,649
condition variable for kind of
 

1539
00:29:54,649 --> 00:29:56,649
condition variable for kind of
coordinating when a certain condition

1540
00:29:56,649 --> 00:29:56,659
coordinating when a certain condition
 

1541
00:29:56,659 --> 00:29:58,570
coordinating when a certain condition
some property on that shared data when

1542
00:29:58,570 --> 00:29:58,580
some property on that shared data when
 

1543
00:29:58,580 --> 00:30:02,049
some property on that shared data when
that becomes true and the way we modify

1544
00:30:02,049 --> 00:30:02,059
that becomes true and the way we modify
 

1545
00:30:02,059 --> 00:30:05,200
that becomes true and the way we modify
our code is like we have two places one

1546
00:30:05,200 --> 00:30:05,210
our code is like we have two places one
 

1547
00:30:05,210 --> 00:30:07,329
our code is like we have two places one
we're making changes to that data which

1548
00:30:07,329 --> 00:30:07,339
we're making changes to that data which
 

1549
00:30:07,339 --> 00:30:08,979
we're making changes to that data which
might make the condition become true and

1550
00:30:08,979 --> 00:30:08,989
might make the condition become true and
 

1551
00:30:08,989 --> 00:30:10,299
might make the condition become true and
then we have another place where we're

1552
00:30:10,299 --> 00:30:10,309
then we have another place where we're
 

1553
00:30:10,309 --> 00:30:11,560
then we have another place where we're
waiting for that condition to become

1554
00:30:11,560 --> 00:30:11,570
waiting for that condition to become
 

1555
00:30:11,570 --> 00:30:14,200
waiting for that condition to become
true and the general pattern is whenever

1556
00:30:14,200 --> 00:30:14,210
true and the general pattern is whenever
 

1557
00:30:14,210 --> 00:30:17,709
true and the general pattern is whenever
we do something that changes the data we

1558
00:30:17,709 --> 00:30:17,719
we do something that changes the data we
 

1559
00:30:17,719 --> 00:30:20,709
we do something that changes the data we
call a conduct broadcast and we do this

1560
00:30:20,709 --> 00:30:20,719
call a conduct broadcast and we do this
 

1561
00:30:20,719 --> 00:30:22,779
call a conduct broadcast and we do this
while holding the lock and then on the

1562
00:30:22,779 --> 00:30:22,789
while holding the lock and then on the
 

1563
00:30:22,789 --> 00:30:24,070
while holding the lock and then on the
other side where we're waiting for some

1564
00:30:24,070 --> 00:30:24,080
other side where we're waiting for some
 

1565
00:30:24,080 --> 00:30:25,419
other side where we're waiting for some
condition on that share data to become

1566
00:30:25,419 --> 00:30:25,429
condition on that share data to become
 

1567
00:30:25,429 --> 00:30:28,659
condition on that share data to become
true we call con dot wait and so what

1568
00:30:28,659 --> 00:30:28,669
true we call con dot wait and so what
 

1569
00:30:28,669 --> 00:30:30,700
true we call con dot wait and so what
this does is like let's think about what

1570
00:30:30,700 --> 00:30:30,710
this does is like let's think about what
 

1571
00:30:30,710 --> 00:30:32,049
this does is like let's think about what
happens in the mean thread for a moment

1572
00:30:32,049 --> 00:30:32,059
happens in the mean thread for a moment
 

1573
00:30:32,059 --> 00:30:34,060
happens in the mean thread for a moment
the main thread grabs the lock it checks

1574
00:30:34,060 --> 00:30:34,070
the main thread grabs the lock it checks
 

1575
00:30:34,070 --> 00:30:36,159
the main thread grabs the lock it checks
this condition suppose it's false it

1576
00:30:36,159 --> 00:30:36,169
this condition suppose it's false it
 

1577
00:30:36,169 --> 00:30:38,889
this condition suppose it's false it
calls con dot wait what this will do is

1578
00:30:38,889 --> 00:30:38,899
calls con dot wait what this will do is
 

1579
00:30:38,899 --> 00:30:40,479
calls con dot wait what this will do is
it will atomically you can think of it

1580
00:30:40,479 --> 00:30:40,489
it will atomically you can think of it
 

1581
00:30:40,489 --> 00:30:42,399
it will atomically you can think of it
as it'll release the lock in order to

1582
00:30:42,399 --> 00:30:42,409
as it'll release the lock in order to
 

1583
00:30:42,409 --> 00:30:44,349
as it'll release the lock in order to
let other people make progress and it'll

1584
00:30:44,349 --> 00:30:44,359
let other people make progress and it'll
 

1585
00:30:44,359 --> 00:30:46,539
let other people make progress and it'll
add its thread like it'll add itself to

1586
00:30:46,539 --> 00:30:46,549
add its thread like it'll add itself to
 

1587
00:30:46,549 --> 00:30:48,789
add its thread like it'll add itself to
a like list of people who are waiting on

1588
00:30:48,789 --> 00:30:48,799
a like list of people who are waiting on
 

1589
00:30:48,799 --> 00:30:50,950
a like list of people who are waiting on
this condition variable then

1590
00:30:50,950 --> 00:30:50,960
this condition variable then
 

1591
00:30:50,960 --> 00:30:52,779
this condition variable then
concurrently one of these threads might

1592
00:30:52,779 --> 00:30:52,789
concurrently one of these threads might
 

1593
00:30:52,789 --> 00:30:54,639
concurrently one of these threads might
be able to acquire the lock after it's

1594
00:30:54,639 --> 00:30:54,649
be able to acquire the lock after it's
 

1595
00:30:54,649 --> 00:30:56,709
be able to acquire the lock after it's
gotten a vote and then it manipulates

1596
00:30:56,709 --> 00:30:56,719
gotten a vote and then it manipulates
 

1597
00:30:56,719 --> 00:30:57,999
gotten a vote and then it manipulates
these variables and then it calls

1598
00:30:57,999 --> 00:30:58,009
these variables and then it calls
 

1599
00:30:58,009 --> 00:31:00,759
these variables and then it calls
conduct broadcast what that does is it

1600
00:31:00,759 --> 00:31:00,769
conduct broadcast what that does is it
 

1601
00:31:00,769 --> 00:31:03,070
conduct broadcast what that does is it
wakes up whoever's waiting on the

1602
00:31:03,070 --> 00:31:03,080
wakes up whoever's waiting on the
 

1603
00:31:03,080 --> 00:31:05,109
wakes up whoever's waiting on the
condition variable and so once this

1604
00:31:05,109 --> 00:31:05,119
condition variable and so once this
 

1605
00:31:05,119 --> 00:31:08,950
condition variable and so once this
thread unlocks the mutex this one what

1606
00:31:08,950 --> 00:31:08,960
thread unlocks the mutex this one what
 

1607
00:31:08,960 --> 00:31:10,690
thread unlocks the mutex this one what
do we want as it's returning from wait

1608
00:31:10,690 --> 00:31:10,700
do we want as it's returning from wait
 

1609
00:31:10,700 --> 00:31:13,209
do we want as it's returning from wait
we'll reacquire the mutex and then

1610
00:31:13,209 --> 00:31:13,219
we'll reacquire the mutex and then
 

1611
00:31:13,219 --> 00:31:15,070
we'll reacquire the mutex and then
return to the top of this for loop which

1612
00:31:15,070 --> 00:31:15,080
return to the top of this for loop which
 

1613
00:31:15,080 --> 00:31:18,219
return to the top of this for loop which
is checking this condition so this

1614
00:31:18,219 --> 00:31:18,229
is checking this condition so this
 

1615
00:31:18,229 --> 00:31:20,529
is checking this condition so this
broadcast wakes up whoever's waiting at

1616
00:31:20,529 --> 00:31:20,539
broadcast wakes up whoever's waiting at
 

1617
00:31:20,539 --> 00:31:25,389
broadcast wakes up whoever's waiting at
this wait and so this avoids having to

1618
00:31:25,389 --> 00:31:25,399
this wait and so this avoids having to
 

1619
00:31:25,399 --> 00:31:27,339
this wait and so this avoids having to
have that time dot sleeve for some

1620
00:31:27,339 --> 00:31:27,349
have that time dot sleeve for some
 

1621
00:31:27,349 --> 00:31:29,109
have that time dot sleeve for some
arbitrary amount of time like this

1622
00:31:29,109 --> 00:31:29,119
arbitrary amount of time like this
 

1623
00:31:29,119 --> 00:31:30,579
arbitrary amount of time like this
thread that's waiting for some condition

1624
00:31:30,579 --> 00:31:30,589
thread that's waiting for some condition
 

1625
00:31:30,589 --> 00:31:32,950
thread that's waiting for some condition
to become true only gets woken up when

1626
00:31:32,950 --> 00:31:32,960
to become true only gets woken up when
 

1627
00:31:32,960 --> 00:31:34,509
to become true only gets woken up when
something changes that might make that

1628
00:31:34,509 --> 00:31:34,519
something changes that might make that
 

1629
00:31:34,519 --> 00:31:36,099
something changes that might make that
condition become true right like if you

1630
00:31:36,099 --> 00:31:36,109
condition become true right like if you
 

1631
00:31:36,109 --> 00:31:37,570
condition become true right like if you
think about these threads if they're

1632
00:31:37,570 --> 00:31:37,580
think about these threads if they're
 

1633
00:31:37,580 --> 00:31:40,119
think about these threads if they're
very slow and they don't call conned out

1634
00:31:40,119 --> 00:31:40,129
very slow and they don't call conned out
 

1635
00:31:40,129 --> 00:31:42,190
very slow and they don't call conned out
broadcast for a long time this one will

1636
00:31:42,190 --> 00:31:42,200
broadcast for a long time this one will
 

1637
00:31:42,200 --> 00:31:43,479
broadcast for a long time this one will
just be waiting it won't be like

1638
00:31:43,479 --> 00:31:43,489
just be waiting it won't be like
 

1639
00:31:43,489 --> 00:31:44,829
just be waiting it won't be like
periodically waking up and checking some

1640
00:31:44,829 --> 00:31:44,839
periodically waking up and checking some
 

1641
00:31:44,839 --> 00:31:46,839
periodically waking up and checking some
condition that can't have changed

1642
00:31:46,839 --> 00:31:46,849
condition that can't have changed
 

1643
00:31:46,849 --> 00:31:48,489
condition that can't have changed
because nobody else manipulated their

1644
00:31:48,489 --> 00:31:48,499
because nobody else manipulated their
 

1645
00:31:48,499 --> 00:31:52,180
because nobody else manipulated their
shared data so any questions about this

1646
00:31:52,180 --> 00:31:52,190
shared data so any questions about this
 

1647
00:31:52,190 --> 00:32:16,150
shared data so any questions about this
pattern yeah

1648
00:32:16,150 --> 00:32:16,160

 

1649
00:32:16,160 --> 00:32:17,800

so that's a great question I think

1650
00:32:17,800 --> 00:32:17,810
so that's a great question I think
 

1651
00:32:17,810 --> 00:32:19,120
so that's a great question I think
you're referring to something called the

1652
00:32:19,120 --> 00:32:19,130
you're referring to something called the
 

1653
00:32:19,130 --> 00:32:21,940
you're referring to something called the
lost wake up problem and this is a topic

1654
00:32:21,940 --> 00:32:21,950
lost wake up problem and this is a topic
 

1655
00:32:21,950 --> 00:32:23,170
lost wake up problem and this is a topic
in operating systems and we won't talk

1656
00:32:23,170 --> 00:32:23,180
in operating systems and we won't talk
 

1657
00:32:23,180 --> 00:32:24,700
in operating systems and we won't talk
about it in detail now there feel free

1658
00:32:24,700 --> 00:32:24,710
about it in detail now there feel free
 

1659
00:32:24,710 --> 00:32:26,590
about it in detail now there feel free
to ask me after lecture but at a high

1660
00:32:26,590 --> 00:32:26,600
to ask me after lecture but at a high
 

1661
00:32:26,600 --> 00:32:28,090
to ask me after lecture but at a high
level you can avoid funny race

1662
00:32:28,090 --> 00:32:28,100
level you can avoid funny race
 

1663
00:32:28,100 --> 00:32:29,350
level you can avoid funny race
conditions that might happen between

1664
00:32:29,350 --> 00:32:29,360
conditions that might happen between
 

1665
00:32:29,360 --> 00:32:31,330
conditions that might happen between
wait and broadcast by following the

1666
00:32:31,330 --> 00:32:31,340
wait and broadcast by following the
 

1667
00:32:31,340 --> 00:32:32,710
wait and broadcast by following the
particular pattern I'm showing here and

1668
00:32:32,710 --> 00:32:32,720
particular pattern I'm showing here and
 

1669
00:32:32,720 --> 00:32:33,970
particular pattern I'm showing here and
I'll show you an abstracted version of

1670
00:32:33,970 --> 00:32:33,980
I'll show you an abstracted version of
 

1671
00:32:33,980 --> 00:32:36,640
I'll show you an abstracted version of
this pattern in a moment basically the

1672
00:32:36,640 --> 00:32:36,650
this pattern in a moment basically the
 

1673
00:32:36,650 --> 00:32:39,340
this pattern in a moment basically the
pattern is for the side that might make

1674
00:32:39,340 --> 00:32:39,350
pattern is for the side that might make
 

1675
00:32:39,350 --> 00:32:41,170
pattern is for the side that might make
changes that will change the outcome of

1676
00:32:41,170 --> 00:32:41,180
changes that will change the outcome of
 

1677
00:32:41,180 --> 00:32:44,550
changes that will change the outcome of
the condition test you always lock then

1678
00:32:44,550 --> 00:32:44,560
the condition test you always lock then
 

1679
00:32:44,560 --> 00:32:47,380
the condition test you always lock then
manipulate the data then call broadcast

1680
00:32:47,380 --> 00:32:47,390
manipulate the data then call broadcast
 

1681
00:32:47,390 --> 00:32:49,450
manipulate the data then call broadcast
and call unlock afterwards so the

1682
00:32:49,450 --> 00:32:49,460
and call unlock afterwards so the
 

1683
00:32:49,460 --> 00:32:51,130
and call unlock afterwards so the
broadcast must be called while holding

1684
00:32:51,130 --> 00:32:51,140
broadcast must be called while holding
 

1685
00:32:51,140 --> 00:32:53,260
broadcast must be called while holding
the lock similarly when you're checking

1686
00:32:53,260 --> 00:32:53,270
the lock similarly when you're checking
 

1687
00:32:53,270 --> 00:32:55,480
the lock similarly when you're checking
the condition you grab the lock then

1688
00:32:55,480 --> 00:32:55,490
the condition you grab the lock then
 

1689
00:32:55,490 --> 00:32:56,920
the condition you grab the lock then
you're always checking the condition in

1690
00:32:56,920 --> 00:32:56,930
you're always checking the condition in
 

1691
00:32:56,930 --> 00:32:59,470
you're always checking the condition in
a loop and then inside so when that

1692
00:32:59,470 --> 00:32:59,480
a loop and then inside so when that
 

1693
00:32:59,480 --> 00:33:01,780
a loop and then inside so when that
condition is false you call Condit wait

1694
00:33:01,780 --> 00:33:01,790
condition is false you call Condit wait
 

1695
00:33:01,790 --> 00:33:03,580
condition is false you call Condit wait
this is only called while you're holding

1696
00:33:03,580 --> 00:33:03,590
this is only called while you're holding
 

1697
00:33:03,590 --> 00:33:05,740
this is only called while you're holding
the lock and it atomically releases the

1698
00:33:05,740 --> 00:33:05,750
the lock and it atomically releases the
 

1699
00:33:05,750 --> 00:33:07,510
the lock and it atomically releases the
lock and kind of schedule like puts

1700
00:33:07,510 --> 00:33:07,520
lock and kind of schedule like puts
 

1701
00:33:07,520 --> 00:33:09,100
lock and kind of schedule like puts
itself in a list of waiting threads and

1702
00:33:09,100 --> 00:33:09,110
itself in a list of waiting threads and
 

1703
00:33:09,110 --> 00:33:12,130
itself in a list of waiting threads and
then as waits returning so as we like

1704
00:33:12,130 --> 00:33:12,140
then as waits returning so as we like
 

1705
00:33:12,140 --> 00:33:13,630
then as waits returning so as we like
return from this wait call and then go

1706
00:33:13,630 --> 00:33:13,640
return from this wait call and then go
 

1707
00:33:13,640 --> 00:33:15,070
return from this wait call and then go
back to the top of this for loop it will

1708
00:33:15,070 --> 00:33:15,080
back to the top of this for loop it will
 

1709
00:33:15,080 --> 00:33:16,840
back to the top of this for loop it will
reacquire the lock so this check will

1710
00:33:16,840 --> 00:33:16,850
reacquire the lock so this check will
 

1711
00:33:16,850 --> 00:33:18,310
reacquire the lock so this check will
only happen while holding the lock and

1712
00:33:18,310 --> 00:33:18,320
only happen while holding the lock and
 

1713
00:33:18,320 --> 00:33:19,810
only happen while holding the lock and
then so outside of this we still have

1714
00:33:19,810 --> 00:33:19,820
then so outside of this we still have
 

1715
00:33:19,820 --> 00:33:21,610
then so outside of this we still have
the lock here and we unlock after we're

1716
00:33:21,610 --> 00:33:21,620
the lock here and we unlock after we're
 

1717
00:33:21,620 --> 00:33:24,030
the lock here and we unlock after we're
done doing whatever we need to do here

1718
00:33:24,030 --> 00:33:24,040
done doing whatever we need to do here
 

1719
00:33:24,040 --> 00:33:26,170
done doing whatever we need to do here
at a high level this pattern looks like

1720
00:33:26,170 --> 00:33:26,180
at a high level this pattern looks like
 

1721
00:33:26,180 --> 00:33:28,600
at a high level this pattern looks like
this so we have one thread or some

1722
00:33:28,600 --> 00:33:28,610
this so we have one thread or some
 

1723
00:33:28,610 --> 00:33:29,770
this so we have one thread or some
number of threads doing something that

1724
00:33:29,770 --> 00:33:29,780
number of threads doing something that
 

1725
00:33:29,780 --> 00:33:31,300
number of threads doing something that
might affect the condition so they're

1726
00:33:31,300 --> 00:33:31,310
might affect the condition so they're
 

1727
00:33:31,310 --> 00:33:33,520
might affect the condition so they're
going to grab a lock do the thing call

1728
00:33:33,520 --> 00:33:33,530
going to grab a lock do the thing call
 

1729
00:33:33,530 --> 00:33:36,160
going to grab a lock do the thing call
broadcast then call unlock and on the

1730
00:33:36,160 --> 00:33:36,170
broadcast then call unlock and on the
 

1731
00:33:36,170 --> 00:33:37,330
broadcast then call unlock and on the
other side we have some thread that's

1732
00:33:37,330 --> 00:33:37,340
other side we have some thread that's
 

1733
00:33:37,340 --> 00:33:38,560
other side we have some thread that's
waiting for some condition to become

1734
00:33:38,560 --> 00:33:38,570
waiting for some condition to become
 

1735
00:33:38,570 --> 00:33:40,450
waiting for some condition to become
true the pattern there it looks like we

1736
00:33:40,450 --> 00:33:40,460
true the pattern there it looks like we
 

1737
00:33:40,460 --> 00:33:42,580
true the pattern there it looks like we
grab the lock then in a while loop while

1738
00:33:42,580 --> 00:33:42,590
grab the lock then in a while loop while
 

1739
00:33:42,590 --> 00:33:44,890
grab the lock then in a while loop while
the condition is false we wait and so

1740
00:33:44,890 --> 00:33:44,900
the condition is false we wait and so
 

1741
00:33:44,900 --> 00:33:46,600
the condition is false we wait and so
then we know that when we get past this

1742
00:33:46,600 --> 00:33:46,610
then we know that when we get past this
 

1743
00:33:46,610 --> 00:33:48,280
then we know that when we get past this
while loop now the condition is true and

1744
00:33:48,280 --> 00:33:48,290
while loop now the condition is true and
 

1745
00:33:48,290 --> 00:33:49,990
while loop now the condition is true and
we're holding the lock and we can do

1746
00:33:49,990 --> 00:33:50,000
we're holding the lock and we can do
 

1747
00:33:50,000 --> 00:33:51,550
we're holding the lock and we can do
whatever we need to do here and then

1748
00:33:51,550 --> 00:33:51,560
whatever we need to do here and then
 

1749
00:33:51,560 --> 00:33:54,670
whatever we need to do here and then
finally we call unlock so we can talk

1750
00:33:54,670 --> 00:33:54,680
finally we call unlock so we can talk
 

1751
00:33:54,680 --> 00:33:55,780
finally we call unlock so we can talk
about all the things that might go wrong

1752
00:33:55,780 --> 00:33:55,790
about all the things that might go wrong
 

1753
00:33:55,790 --> 00:33:57,700
about all the things that might go wrong
if you violate one of these rules like

1754
00:33:57,700 --> 00:33:57,710
if you violate one of these rules like
 

1755
00:33:57,710 --> 00:33:59,140
if you violate one of these rules like
after lecture if you're interested but

1756
00:33:59,140 --> 00:33:59,150
after lecture if you're interested but
 

1757
00:33:59,150 --> 00:34:00,520
after lecture if you're interested but
at a high level if you follow this

1758
00:34:00,520 --> 00:34:00,530
at a high level if you follow this
 

1759
00:34:00,530 --> 00:34:01,990
at a high level if you follow this
pattern then you won't need to deal with

1760
00:34:01,990 --> 00:34:02,000
pattern then you won't need to deal with
 

1761
00:34:02,000 --> 00:34:08,880
pattern then you won't need to deal with
those issues so any questions about that

1762
00:34:08,880 --> 00:34:08,890

 

1763
00:34:08,890 --> 00:34:14,040

yeah

1764
00:34:14,040 --> 00:34:14,050

 

1765
00:34:14,050 --> 00:34:15,940

so that's a great question

1766
00:34:15,940 --> 00:34:15,950
so that's a great question
 

1767
00:34:15,950 --> 00:34:17,980
so that's a great question
when do you use broadcast versus when do

1768
00:34:17,980 --> 00:34:17,990
when do you use broadcast versus when do
 

1769
00:34:17,990 --> 00:34:19,570
when do you use broadcast versus when do
use signals so converse have three

1770
00:34:19,570 --> 00:34:19,580
use signals so converse have three
 

1771
00:34:19,580 --> 00:34:21,310
use signals so converse have three
methods on them one is wait for the

1772
00:34:21,310 --> 00:34:21,320
methods on them one is wait for the
 

1773
00:34:21,320 --> 00:34:23,169
methods on them one is wait for the
waiting side and then on the other side

1774
00:34:23,169 --> 00:34:23,179
waiting side and then on the other side
 

1775
00:34:23,179 --> 00:34:25,450
waiting side and then on the other side
you can use signal or broadcast and the

1776
00:34:25,450 --> 00:34:25,460
you can use signal or broadcast and the
 

1777
00:34:25,460 --> 00:34:27,700
you can use signal or broadcast and the
semantics of those are signal wait wakes

1778
00:34:27,700 --> 00:34:27,710
semantics of those are signal wait wakes
 

1779
00:34:27,710 --> 00:34:30,100
semantics of those are signal wait wakes
up exactly one waiter like one thread

1780
00:34:30,100 --> 00:34:30,110
up exactly one waiter like one thread
 

1781
00:34:30,110 --> 00:34:30,790
up exactly one waiter like one thread
that may be waiting

1782
00:34:30,790 --> 00:34:30,800
that may be waiting
 

1783
00:34:30,800 --> 00:34:32,800
that may be waiting
whereas broadcast wakes up everybody

1784
00:34:32,800 --> 00:34:32,810
whereas broadcast wakes up everybody
 

1785
00:34:32,810 --> 00:34:34,000
whereas broadcast wakes up everybody
who's waiting and they'll all reach out

1786
00:34:34,000 --> 00:34:34,010
who's waiting and they'll all reach out
 

1787
00:34:34,010 --> 00:34:35,560
who's waiting and they'll all reach out
like they'll all try to grab the law can

1788
00:34:35,560 --> 00:34:35,570
like they'll all try to grab the law can
 

1789
00:34:35,570 --> 00:34:37,360
like they'll all try to grab the law can
recheck the condition and only one of

1790
00:34:37,360 --> 00:34:37,370
recheck the condition and only one of
 

1791
00:34:37,370 --> 00:34:38,770
recheck the condition and only one of
them will proceed because only one a

1792
00:34:38,770 --> 00:34:38,780
them will proceed because only one a
 

1793
00:34:38,780 --> 00:34:39,970
them will proceed because only one a
little he'll door lock until it gets

1794
00:34:39,970 --> 00:34:39,980
little he'll door lock until it gets
 

1795
00:34:39,980 --> 00:34:42,160
little he'll door lock until it gets
past this point I think for the purpose

1796
00:34:42,160 --> 00:34:42,170
past this point I think for the purpose
 

1797
00:34:42,170 --> 00:34:44,110
past this point I think for the purpose
of this class always use broadcast never

1798
00:34:44,110 --> 00:34:44,120
of this class always use broadcast never
 

1799
00:34:44,120 --> 00:34:45,580
of this class always use broadcast never
use signal if you follow this pattern

1800
00:34:45,580 --> 00:34:45,590
use signal if you follow this pattern
 

1801
00:34:45,590 --> 00:34:46,870
use signal if you follow this pattern
and just like don't use signal and

1802
00:34:46,870 --> 00:34:46,880
and just like don't use signal and
 

1803
00:34:46,880 --> 00:34:48,730
and just like don't use signal and
always use broadcast your code will work

1804
00:34:48,730 --> 00:34:48,740
always use broadcast your code will work
 

1805
00:34:48,740 --> 00:34:51,760
always use broadcast your code will work
I think you can stick think of signal as

1806
00:34:51,760 --> 00:34:51,770
I think you can stick think of signal as
 

1807
00:34:51,770 --> 00:34:54,040
I think you can stick think of signal as
something used for efficiency and we

1808
00:34:54,040 --> 00:34:54,050
something used for efficiency and we
 

1809
00:34:54,050 --> 00:34:55,480
something used for efficiency and we
don't really care about that level of

1810
00:34:55,480 --> 00:34:55,490
don't really care about that level of
 

1811
00:34:55,490 --> 00:34:57,160
don't really care about that level of
CPU efficiency in the labs for this

1812
00:34:57,160 --> 00:34:57,170
CPU efficiency in the labs for this
 

1813
00:34:57,170 --> 00:35:00,270
CPU efficiency in the labs for this
class

1814
00:35:00,270 --> 00:35:00,280

 

1815
00:35:00,280 --> 00:35:06,250

any more questions ok so the final topic

1816
00:35:06,250 --> 00:35:06,260
any more questions ok so the final topic
 

1817
00:35:06,260 --> 00:35:07,870
any more questions ok so the final topic
we're going to cover in terms of go

1818
00:35:07,870 --> 00:35:07,880
we're going to cover in terms of go
 

1819
00:35:07,880 --> 00:35:10,630
we're going to cover in terms of go
concurrency primitives is channels so

1820
00:35:10,630 --> 00:35:10,640
concurrency primitives is channels so
 

1821
00:35:10,640 --> 00:35:12,610
concurrency primitives is channels so
two high level channels are like a queue

1822
00:35:12,610 --> 00:35:12,620
two high level channels are like a queue
 

1823
00:35:12,620 --> 00:35:14,890
two high level channels are like a queue
like synchronization primitive but they

1824
00:35:14,890 --> 00:35:14,900
like synchronization primitive but they
 

1825
00:35:14,900 --> 00:35:18,240
like synchronization primitive but they
don't behave quite like cues in the

1826
00:35:18,240 --> 00:35:18,250
don't behave quite like cues in the
 

1827
00:35:18,250 --> 00:35:22,120
don't behave quite like cues in the
intuitive sense like I think some people

1828
00:35:22,120 --> 00:35:22,130
intuitive sense like I think some people
 

1829
00:35:22,130 --> 00:35:23,770
intuitive sense like I think some people
think of channels is like there's this

1830
00:35:23,770 --> 00:35:23,780
think of channels is like there's this
 

1831
00:35:23,780 --> 00:35:25,360
think of channels is like there's this
data structure we can sticks that stick

1832
00:35:25,360 --> 00:35:25,370
data structure we can sticks that stick
 

1833
00:35:25,370 --> 00:35:26,830
data structure we can sticks that stick
things in and eventually someone will

1834
00:35:26,830 --> 00:35:26,840
things in and eventually someone will
 

1835
00:35:26,840 --> 00:35:28,330
things in and eventually someone will
pull those things out but in fact

1836
00:35:28,330 --> 00:35:28,340
pull those things out but in fact
 

1837
00:35:28,340 --> 00:35:31,180
pull those things out but in fact
channels have no queuing capacity they

1838
00:35:31,180 --> 00:35:31,190
channels have no queuing capacity they
 

1839
00:35:31,190 --> 00:35:34,570
channels have no queuing capacity they
have no internal storage basically

1840
00:35:34,570 --> 00:35:34,580
have no internal storage basically
 

1841
00:35:34,580 --> 00:35:36,520
have no internal storage basically
channels are synchronous if you have to

1842
00:35:36,520 --> 00:35:36,530
channels are synchronous if you have to
 

1843
00:35:36,530 --> 00:35:37,690
channels are synchronous if you have to
go routines that are going to send and

1844
00:35:37,690 --> 00:35:37,700
go routines that are going to send and
 

1845
00:35:37,700 --> 00:35:39,340
go routines that are going to send and
receive on a channel if someone tries to

1846
00:35:39,340 --> 00:35:39,350
receive on a channel if someone tries to
 

1847
00:35:39,350 --> 00:35:41,050
receive on a channel if someone tries to
send on the channel while nobody's

1848
00:35:41,050 --> 00:35:41,060
send on the channel while nobody's
 

1849
00:35:41,060 --> 00:35:43,180
send on the channel while nobody's
receiving that thread will block until

1850
00:35:43,180 --> 00:35:43,190
receiving that thread will block until
 

1851
00:35:43,190 --> 00:35:45,850
receiving that thread will block until
somebody's ready to receive and at that

1852
00:35:45,850 --> 00:35:45,860
somebody's ready to receive and at that
 

1853
00:35:45,860 --> 00:35:47,650
somebody's ready to receive and at that
point synchronously it will exchange

1854
00:35:47,650 --> 00:35:47,660
point synchronously it will exchange
 

1855
00:35:47,660 --> 00:35:50,290
point synchronously it will exchange
that data over to the receiver and the

1856
00:35:50,290 --> 00:35:50,300
that data over to the receiver and the
 

1857
00:35:50,300 --> 00:35:51,730
that data over to the receiver and the
same is true the other direction if

1858
00:35:51,730 --> 00:35:51,740
same is true the other direction if
 

1859
00:35:51,740 --> 00:35:53,020
same is true the other direction if
someone tries to receive from a channel

1860
00:35:53,020 --> 00:35:53,030
someone tries to receive from a channel
 

1861
00:35:53,030 --> 00:35:54,910
someone tries to receive from a channel
while nobody's sending that receive will

1862
00:35:54,910 --> 00:35:54,920
while nobody's sending that receive will
 

1863
00:35:54,920 --> 00:35:56,680
while nobody's sending that receive will
block until there's another goroutine

1864
00:35:56,680 --> 00:35:56,690
block until there's another goroutine
 

1865
00:35:56,690 --> 00:35:58,300
block until there's another goroutine
that's about to send on the channel and

1866
00:35:58,300 --> 00:35:58,310
that's about to send on the channel and
 

1867
00:35:58,310 --> 00:36:00,790
that's about to send on the channel and
that send will happen synchronously so

1868
00:36:00,790 --> 00:36:00,800
that send will happen synchronously so
 

1869
00:36:00,800 --> 00:36:01,960
that send will happen synchronously so
here's a little demo program that

1870
00:36:01,960 --> 00:36:01,970
here's a little demo program that
 

1871
00:36:01,970 --> 00:36:04,660
here's a little demo program that
demonstrates this here I have a I

1872
00:36:04,660 --> 00:36:04,670
demonstrates this here I have a I
 

1873
00:36:04,670 --> 00:36:06,430
demonstrates this here I have a I
declare channel and then I spawn a go

1874
00:36:06,430 --> 00:36:06,440
declare channel and then I spawn a go
 

1875
00:36:06,440 --> 00:36:08,740
declare channel and then I spawn a go
routine that waits for a second and then

1876
00:36:08,740 --> 00:36:08,750
routine that waits for a second and then
 

1877
00:36:08,750 --> 00:36:11,590
routine that waits for a second and then
sent and then receives from a channel

1878
00:36:11,590 --> 00:36:11,600
sent and then receives from a channel
 

1879
00:36:11,600 --> 00:36:14,860
sent and then receives from a channel
and then in my main girl routine I keep

1880
00:36:14,860 --> 00:36:14,870
and then in my main girl routine I keep
 

1881
00:36:14,870 --> 00:36:16,630
and then in my main girl routine I keep
track of the time then I send on the

1882
00:36:16,630 --> 00:36:16,640
track of the time then I send on the
 

1883
00:36:16,640 --> 00:36:17,770
track of the time then I send on the
channel so I just put some dummy data

1884
00:36:17,770 --> 00:36:17,780
channel so I just put some dummy data
 

1885
00:36:17,780 --> 00:36:19,360
channel so I just put some dummy data
into the channel and then I'm going to

1886
00:36:19,360 --> 00:36:19,370
into the channel and then I'm going to
 

1887
00:36:19,370 --> 00:36:25,559
into the channel and then I'm going to
print out how long the send took

1888
00:36:25,559 --> 00:36:25,569

 

1889
00:36:25,569 --> 00:36:29,319

and if you think of channels as cues

1890
00:36:29,319 --> 00:36:29,329
and if you think of channels as cues
 

1891
00:36:29,329 --> 00:36:31,569
and if you think of channels as cues
with internal storage capacity you might

1892
00:36:31,569 --> 00:36:31,579
with internal storage capacity you might
 

1893
00:36:31,579 --> 00:36:32,950
with internal storage capacity you might
think of this thing as completing very

1894
00:36:32,950 --> 00:36:32,960
think of this thing as completing very
 

1895
00:36:32,960 --> 00:36:35,289
think of this thing as completing very
fast but that's not how channels work

1896
00:36:35,289 --> 00:36:35,299
fast but that's not how channels work
 

1897
00:36:35,299 --> 00:36:38,230
fast but that's not how channels work
this send is going to block until this

1898
00:36:38,230 --> 00:36:38,240
this send is going to block until this
 

1899
00:36:38,240 --> 00:36:39,730
this send is going to block until this
receive happens and this one happened

1900
00:36:39,730 --> 00:36:39,740
receive happens and this one happened
 

1901
00:36:39,740 --> 00:36:41,140
receive happens and this one happened
till this one second is the elapsed and

1902
00:36:41,140 --> 00:36:41,150
till this one second is the elapsed and
 

1903
00:36:41,150 --> 00:36:42,940
till this one second is the elapsed and
so from here to here

1904
00:36:42,940 --> 00:36:42,950
so from here to here
 

1905
00:36:42,950 --> 00:36:44,829
so from here to here
we're actually blocked in the main goo

1906
00:36:44,829 --> 00:36:44,839
we're actually blocked in the main goo
 

1907
00:36:44,839 --> 00:36:48,309
we're actually blocked in the main goo
routine for one whole second alright so

1908
00:36:48,309 --> 00:36:48,319
routine for one whole second alright so
 

1909
00:36:48,319 --> 00:36:50,140
routine for one whole second alright so
don't think of channels as queues think

1910
00:36:50,140 --> 00:36:50,150
don't think of channels as queues think
 

1911
00:36:50,150 --> 00:36:51,670
don't think of channels as queues think
of them as this synchronous like the

1912
00:36:51,670 --> 00:36:51,680
of them as this synchronous like the
 

1913
00:36:51,680 --> 00:36:55,410
of them as this synchronous like the
synchronous communication mechanism

1914
00:36:55,410 --> 00:36:55,420

 

1915
00:36:55,420 --> 00:36:57,579

another example that'll make this really

1916
00:36:57,579 --> 00:36:57,589
another example that'll make this really
 

1917
00:36:57,589 --> 00:36:59,650
another example that'll make this really
obvious is here we have a goroutine that

1918
00:36:59,650 --> 00:36:59,660
obvious is here we have a goroutine that
 

1919
00:36:59,660 --> 00:37:01,390
obvious is here we have a goroutine that
creates a channel then sends on the

1920
00:37:01,390 --> 00:37:01,400
creates a channel then sends on the
 

1921
00:37:01,400 --> 00:37:02,680
creates a channel then sends on the
channel and tries receiving from it

1922
00:37:02,680 --> 00:37:02,690
channel and tries receiving from it
 

1923
00:37:02,690 --> 00:37:04,210
channel and tries receiving from it
doesn't anybody know what'll happen when

1924
00:37:04,210 --> 00:37:04,220
doesn't anybody know what'll happen when
 

1925
00:37:04,220 --> 00:37:05,140
doesn't anybody know what'll happen when
I try running this

1926
00:37:05,140 --> 00:37:05,150
I try running this
 

1927
00:37:05,150 --> 00:37:15,870
I try running this
I think the file name might give it away

1928
00:37:15,870 --> 00:37:15,880

 

1929
00:37:15,880 --> 00:37:18,279

yeah exactly the send is going to block

1930
00:37:18,279 --> 00:37:18,289
yeah exactly the send is going to block
 

1931
00:37:18,289 --> 00:37:19,630
yeah exactly the send is going to block
till somebody's ready to receive but

1932
00:37:19,630 --> 00:37:19,640
till somebody's ready to receive but
 

1933
00:37:19,640 --> 00:37:22,720
till somebody's ready to receive but
there is no receiver and go actually

1934
00:37:22,720 --> 00:37:22,730
there is no receiver and go actually
 

1935
00:37:22,730 --> 00:37:24,190
there is no receiver and go actually
detects this condition if all your

1936
00:37:24,190 --> 00:37:24,200
detects this condition if all your
 

1937
00:37:24,200 --> 00:37:25,599
detects this condition if all your
threads are sleeping it to text this is

1938
00:37:25,599 --> 00:37:25,609
threads are sleeping it to text this is
 

1939
00:37:25,609 --> 00:37:27,609
threads are sleeping it to text this is
a deadlock condition and it'll actually

1940
00:37:27,609 --> 00:37:27,619
a deadlock condition and it'll actually
 

1941
00:37:27,619 --> 00:37:29,289
a deadlock condition and it'll actually
crash but you can have more subtle bugs

1942
00:37:29,289 --> 00:37:29,299
crash but you can have more subtle bugs
 

1943
00:37:29,299 --> 00:37:31,420
crash but you can have more subtle bugs
where if you have some other thread like

1944
00:37:31,420 --> 00:37:31,430
where if you have some other thread like
 

1945
00:37:31,430 --> 00:37:36,880
where if you have some other thread like
off doing something if I spawn this go

1946
00:37:36,880 --> 00:37:36,890
off doing something if I spawn this go
 

1947
00:37:36,890 --> 00:37:38,650
off doing something if I spawn this go
routine that you know for loop does

1948
00:37:38,650 --> 00:37:38,660
routine that you know for loop does
 

1949
00:37:38,660 --> 00:37:41,829
routine that you know for loop does
nothing and I try running this program

1950
00:37:41,829 --> 00:37:41,839
nothing and I try running this program
 

1951
00:37:41,839 --> 00:37:44,049
nothing and I try running this program
again now it goes deadlock detector

1952
00:37:44,049 --> 00:37:44,059
again now it goes deadlock detector
 

1953
00:37:44,059 --> 00:37:45,250
again now it goes deadlock detector
won't notice that all threads are not

1954
00:37:45,250 --> 00:37:45,260
won't notice that all threads are not
 

1955
00:37:45,260 --> 00:37:46,599
won't notice that all threads are not
doing any use will work like there's one

1956
00:37:46,599 --> 00:37:46,609
doing any use will work like there's one
 

1957
00:37:46,609 --> 00:37:48,519
doing any use will work like there's one
thread running it's just this is never

1958
00:37:48,519 --> 00:37:48,529
thread running it's just this is never
 

1959
00:37:48,529 --> 00:37:49,990
thread running it's just this is never
receiving and we can tell by looking at

1960
00:37:49,990 --> 00:37:50,000
receiving and we can tell by looking at
 

1961
00:37:50,000 --> 00:37:51,250
receiving and we can tell by looking at
this program that it'll never terminate

1962
00:37:51,250 --> 00:37:51,260
this program that it'll never terminate
 

1963
00:37:51,260 --> 00:37:54,910
this program that it'll never terminate
but here it just looks like it hangs so

1964
00:37:54,910 --> 00:37:54,920
but here it just looks like it hangs so
 

1965
00:37:54,920 --> 00:37:56,349
but here it just looks like it hangs so
if you're not careful with channels you

1966
00:37:56,349 --> 00:37:56,359
if you're not careful with channels you
 

1967
00:37:56,359 --> 00:37:58,660
if you're not careful with channels you
can get these subtle bugs where you have

1968
00:37:58,660 --> 00:37:58,670
can get these subtle bugs where you have
 

1969
00:37:58,670 --> 00:38:05,589
can get these subtle bugs where you have
double X as a result yeah yeah exactly

1970
00:38:05,589 --> 00:38:05,599
double X as a result yeah yeah exactly
 

1971
00:38:05,599 --> 00:38:07,660
double X as a result yeah yeah exactly
there's no data nobody's sending on this

1972
00:38:07,660 --> 00:38:07,670
there's no data nobody's sending on this
 

1973
00:38:07,670 --> 00:38:08,890
there's no data nobody's sending on this
channel so this is gonna block here it's

1974
00:38:08,890 --> 00:38:08,900
channel so this is gonna block here it's
 

1975
00:38:08,900 --> 00:38:19,460
channel so this is gonna block here it's
never gonna get to this line

1976
00:38:19,460 --> 00:38:19,470

 

1977
00:38:19,470 --> 00:38:22,010

yeah so channels as you pointed out

1978
00:38:22,010 --> 00:38:22,020
yeah so channels as you pointed out
 

1979
00:38:22,020 --> 00:38:23,750
yeah so channels as you pointed out
can't really be used just within a

1980
00:38:23,750 --> 00:38:23,760
can't really be used just within a
 

1981
00:38:23,760 --> 00:38:25,010
can't really be used just within a
single goroutine it doesn't really make

1982
00:38:25,010 --> 00:38:25,020
single goroutine it doesn't really make
 

1983
00:38:25,020 --> 00:38:27,260
single goroutine it doesn't really make
sense because in order to send or in

1984
00:38:27,260 --> 00:38:27,270
sense because in order to send or in
 

1985
00:38:27,270 --> 00:38:28,880
sense because in order to send or in
order to receive there has to be another

1986
00:38:28,880 --> 00:38:28,890
order to receive there has to be another
 

1987
00:38:28,890 --> 00:38:30,770
order to receive there has to be another
go routine doing the opposite action at

1988
00:38:30,770 --> 00:38:30,780
go routine doing the opposite action at
 

1989
00:38:30,780 --> 00:38:32,690
go routine doing the opposite action at
the same time so if there isn't you're

1990
00:38:32,690 --> 00:38:32,700
the same time so if there isn't you're
 

1991
00:38:32,700 --> 00:38:34,070
the same time so if there isn't you're
just gonna block forever and then that

1992
00:38:34,070 --> 00:38:34,080
just gonna block forever and then that
 

1993
00:38:34,080 --> 00:38:35,870
just gonna block forever and then that
chant but thread will no longer do any

1994
00:38:35,870 --> 00:38:35,880
chant but thread will no longer do any
 

1995
00:38:35,880 --> 00:38:44,390
chant but thread will no longer do any
useful work yeah sans wait for receives

1996
00:38:44,390 --> 00:38:44,400
useful work yeah sans wait for receives
 

1997
00:38:44,400 --> 00:38:45,740
useful work yeah sans wait for receives
receives wait for signs and it happens

1998
00:38:45,740 --> 00:38:45,750
receives wait for signs and it happens
 

1999
00:38:45,750 --> 00:38:47,060
receives wait for signs and it happens
synchronously once there's both the

2000
00:38:47,060 --> 00:38:47,070
synchronously once there's both the
 

2001
00:38:47,070 --> 00:38:53,000
synchronously once there's both the
sender and receiver present what I

2002
00:38:53,000 --> 00:38:53,010
sender and receiver present what I
 

2003
00:38:53,010 --> 00:38:54,560
sender and receiver present what I
talked about so far is unbuffered

2004
00:38:54,560 --> 00:38:54,570
talked about so far is unbuffered
 

2005
00:38:54,570 --> 00:38:56,270
talked about so far is unbuffered
channels I was going to avoid talking

2006
00:38:56,270 --> 00:38:56,280
channels I was going to avoid talking
 

2007
00:38:56,280 --> 00:38:57,620
channels I was going to avoid talking
about buffered channels because there

2008
00:38:57,620 --> 00:38:57,630
about buffered channels because there
 

2009
00:38:57,630 --> 00:38:58,610
about buffered channels because there
are very few problems that they're

2010
00:38:58,610 --> 00:38:58,620
are very few problems that they're
 

2011
00:38:58,620 --> 00:39:00,590
are very few problems that they're
actually useful for solving so buffered

2012
00:39:00,590 --> 00:39:00,600
actually useful for solving so buffered
 

2013
00:39:00,600 --> 00:39:04,670
actually useful for solving so buffered
channels can take in a capacity and then

2014
00:39:04,670 --> 00:39:04,680
channels can take in a capacity and then
 

2015
00:39:04,680 --> 00:39:07,340
channels can take in a capacity and then
you can think of it as it's just switch

2016
00:39:07,340 --> 00:39:07,350
you can think of it as it's just switch
 

2017
00:39:07,350 --> 00:39:09,860
you can think of it as it's just switch
this to so here's a buffered channel

2018
00:39:09,860 --> 00:39:09,870
this to so here's a buffered channel
 

2019
00:39:09,870 --> 00:39:11,840
this to so here's a buffered channel
with a capacity of one this program does

2020
00:39:11,840 --> 00:39:11,850
with a capacity of one this program does
 

2021
00:39:11,850 --> 00:39:14,620
with a capacity of one this program does
terminate because buffered channels are

2022
00:39:14,620 --> 00:39:14,630
terminate because buffered channels are
 

2023
00:39:14,630 --> 00:39:16,730
terminate because buffered channels are
like they have some internal storage

2024
00:39:16,730 --> 00:39:16,740
like they have some internal storage
 

2025
00:39:16,740 --> 00:39:18,680
like they have some internal storage
space and until that space fills up

2026
00:39:18,680 --> 00:39:18,690
space and until that space fills up
 

2027
00:39:18,690 --> 00:39:20,510
space and until that space fills up
sends are non blocking because they can

2028
00:39:20,510 --> 00:39:20,520
sends are non blocking because they can
 

2029
00:39:20,520 --> 00:39:21,740
sends are non blocking because they can
just put that data in the internal

2030
00:39:21,740 --> 00:39:21,750
just put that data in the internal
 

2031
00:39:21,750 --> 00:39:23,690
just put that data in the internal
storage space but once the channel does

2032
00:39:23,690 --> 00:39:23,700
storage space but once the channel does
 

2033
00:39:23,700 --> 00:39:26,180
storage space but once the channel does
fill up then it does behave like a nun

2034
00:39:26,180 --> 00:39:26,190
fill up then it does behave like a nun
 

2035
00:39:26,190 --> 00:39:28,040
fill up then it does behave like a nun
buffer channel in the sense that further

2036
00:39:28,040 --> 00:39:28,050
buffer channel in the sense that further
 

2037
00:39:28,050 --> 00:39:29,990
buffer channel in the sense that further
sends will block until there's a receive

2038
00:39:29,990 --> 00:39:30,000
sends will block until there's a receive
 

2039
00:39:30,000 --> 00:39:34,310
sends will block until there's a receive
to make space in the channel but I think

2040
00:39:34,310 --> 00:39:34,320
to make space in the channel but I think
 

2041
00:39:34,320 --> 00:39:35,750
to make space in the channel but I think
at a high level we should avoid buffered

2042
00:39:35,750 --> 00:39:35,760
at a high level we should avoid buffered
 

2043
00:39:35,760 --> 00:39:37,010
at a high level we should avoid buffered
channels because they basically don't

2044
00:39:37,010 --> 00:39:37,020
channels because they basically don't
 

2045
00:39:37,020 --> 00:39:39,740
channels because they basically don't
solve any problems and another path and

2046
00:39:39,740 --> 00:39:39,750
solve any problems and another path and
 

2047
00:39:39,750 --> 00:39:40,640
solve any problems and another path and
other things should be thinking about is

2048
00:39:40,640 --> 00:39:40,650
other things should be thinking about is
 

2049
00:39:40,650 --> 00:39:41,570
other things should be thinking about is
whenever you to make up arbitrary

2050
00:39:41,570 --> 00:39:41,580
whenever you to make up arbitrary
 

2051
00:39:41,580 --> 00:39:43,250
whenever you to make up arbitrary
numbers like this one here to make your

2052
00:39:43,250 --> 00:39:43,260
numbers like this one here to make your
 

2053
00:39:43,260 --> 00:39:44,270
numbers like this one here to make your
code work you're probably doing

2054
00:39:44,270 --> 00:39:44,280
code work you're probably doing
 

2055
00:39:44,280 --> 00:40:00,499
code work you're probably doing
something wrong yeah

2056
00:40:00,499 --> 00:40:00,509

 

2057
00:40:00,509 --> 00:40:02,549

so I think this is a question about

2058
00:40:02,549 --> 00:40:02,559
so I think this is a question about
 

2059
00:40:02,559 --> 00:40:04,019
so I think this is a question about
terminology like what exactly does

2060
00:40:04,019 --> 00:40:04,029
terminology like what exactly does
 

2061
00:40:04,029 --> 00:40:05,309
terminology like what exactly does
deadlock mean into this count as a

2062
00:40:05,309 --> 00:40:05,319
deadlock mean into this count as a
 

2063
00:40:05,319 --> 00:40:06,690
deadlock mean into this count as a
deadlock like yes this counts as a

2064
00:40:06,690 --> 00:40:06,700
deadlock like yes this counts as a
 

2065
00:40:06,700 --> 00:40:08,099
deadlock like yes this counts as a
deadlock like no useful progress will be

2066
00:40:08,099 --> 00:40:08,109
deadlock like no useful progress will be
 

2067
00:40:08,109 --> 00:40:10,289
deadlock like no useful progress will be
made here like this these threads are

2068
00:40:10,289 --> 00:40:10,299
made here like this these threads are
 

2069
00:40:10,299 --> 00:40:12,410
made here like this these threads are
just stuck forever

2070
00:40:12,410 --> 00:40:12,420
just stuck forever
 

2071
00:40:12,420 --> 00:40:16,829
just stuck forever
any other questions so what our channel

2072
00:40:16,829 --> 00:40:16,839
any other questions so what our channel
 

2073
00:40:16,839 --> 00:40:18,630
any other questions so what our channel
is useful for I think channels are

2074
00:40:18,630 --> 00:40:18,640
is useful for I think channels are
 

2075
00:40:18,640 --> 00:40:20,190
is useful for I think channels are
useful for a small set of things like

2076
00:40:20,190 --> 00:40:20,200
useful for a small set of things like
 

2077
00:40:20,200 --> 00:40:23,099
useful for a small set of things like
for example I think for producer

2078
00:40:23,099 --> 00:40:23,109
for example I think for producer
 

2079
00:40:23,109 --> 00:40:25,319
for example I think for producer
consumer queues sort of situations like

2080
00:40:25,319 --> 00:40:25,329
consumer queues sort of situations like
 

2081
00:40:25,329 --> 00:40:26,880
consumer queues sort of situations like
here I have a program that makes a

2082
00:40:26,880 --> 00:40:26,890
here I have a program that makes a
 

2083
00:40:26,890 --> 00:40:28,259
here I have a program that makes a
channel and this spawns a bunch of

2084
00:40:28,259 --> 00:40:28,269
channel and this spawns a bunch of
 

2085
00:40:28,269 --> 00:40:29,640
channel and this spawns a bunch of
goroutines that are going to be doing

2086
00:40:29,640 --> 00:40:29,650
goroutines that are going to be doing
 

2087
00:40:29,650 --> 00:40:31,049
goroutines that are going to be doing
some work like say they're competing

2088
00:40:31,049 --> 00:40:31,059
some work like say they're competing
 

2089
00:40:31,059 --> 00:40:33,299
some work like say they're competing
some result in producing some data and I

2090
00:40:33,299 --> 00:40:33,309
some result in producing some data and I
 

2091
00:40:33,309 --> 00:40:34,709
some result in producing some data and I
have a bunch of these go routines

2092
00:40:34,709 --> 00:40:34,719
have a bunch of these go routines
 

2093
00:40:34,719 --> 00:40:36,239
have a bunch of these go routines
running in parallel and I want to

2094
00:40:36,239 --> 00:40:36,249
running in parallel and I want to
 

2095
00:40:36,249 --> 00:40:37,979
running in parallel and I want to
collect all that data as it comes in and

2096
00:40:37,979 --> 00:40:37,989
collect all that data as it comes in and
 

2097
00:40:37,989 --> 00:40:38,789
collect all that data as it comes in and
do something with it

2098
00:40:38,789 --> 00:40:38,799
do something with it
 

2099
00:40:38,799 --> 00:40:40,559
do something with it
so this do work thing just like waits

2100
00:40:40,559 --> 00:40:40,569
so this do work thing just like waits
 

2101
00:40:40,569 --> 00:40:42,150
so this do work thing just like waits
for a bit and produces a random number

2102
00:40:42,150 --> 00:40:42,160
for a bit and produces a random number
 

2103
00:40:42,160 --> 00:40:43,829
for a bit and produces a random number
and in the main goroutine I'm going to

2104
00:40:43,829 --> 00:40:43,839
and in the main goroutine I'm going to
 

2105
00:40:43,839 --> 00:40:45,690
and in the main goroutine I'm going to
continuously receive on this channel and

2106
00:40:45,690 --> 00:40:45,700
continuously receive on this channel and
 

2107
00:40:45,700 --> 00:40:47,759
continuously receive on this channel and
print it out like this is a great use of

2108
00:40:47,759 --> 00:40:47,769
print it out like this is a great use of
 

2109
00:40:47,769 --> 00:40:50,700
print it out like this is a great use of
channels another good use of channels is

2110
00:40:50,700 --> 00:40:50,710
channels another good use of channels is
 

2111
00:40:50,710 --> 00:40:52,620
channels another good use of channels is
to achieve something similar to what

2112
00:40:52,620 --> 00:40:52,630
to achieve something similar to what
 

2113
00:40:52,630 --> 00:40:56,069
to achieve something similar to what
wait groups do so rather than use a wait

2114
00:40:56,069 --> 00:40:56,079
wait groups do so rather than use a wait
 

2115
00:40:56,079 --> 00:40:57,509
wait groups do so rather than use a wait
group suppose I want to spawn a bunch of

2116
00:40:57,509 --> 00:40:57,519
group suppose I want to spawn a bunch of
 

2117
00:40:57,519 --> 00:40:58,920
group suppose I want to spawn a bunch of
threads and wait till they're all done

2118
00:40:58,920 --> 00:40:58,930
threads and wait till they're all done
 

2119
00:40:58,930 --> 00:41:01,140
threads and wait till they're all done
doing something one way to do that is to

2120
00:41:01,140 --> 00:41:01,150
doing something one way to do that is to
 

2121
00:41:01,150 --> 00:41:03,269
doing something one way to do that is to
create a channel and then I spawn a

2122
00:41:03,269 --> 00:41:03,279
create a channel and then I spawn a
 

2123
00:41:03,279 --> 00:41:04,380
create a channel and then I spawn a
bunch of threads and know how many

2124
00:41:04,380 --> 00:41:04,390
bunch of threads and know how many
 

2125
00:41:04,390 --> 00:41:06,539
bunch of threads and know how many
threads I've spawned so five goroutines

2126
00:41:06,539 --> 00:41:06,549
threads I've spawned so five goroutines
 

2127
00:41:06,549 --> 00:41:07,799
threads I've spawned so five goroutines
created here they're going to do

2128
00:41:07,799 --> 00:41:07,809
created here they're going to do
 

2129
00:41:07,809 --> 00:41:09,359
created here they're going to do
something and then send on this channel

2130
00:41:09,359 --> 00:41:09,369
something and then send on this channel
 

2131
00:41:09,369 --> 00:41:11,609
something and then send on this channel
when they're done and then in the main

2132
00:41:11,609 --> 00:41:11,619
when they're done and then in the main
 

2133
00:41:11,619 --> 00:41:13,799
when they're done and then in the main
go routine I can just receive from that

2134
00:41:13,799 --> 00:41:13,809
go routine I can just receive from that
 

2135
00:41:13,809 --> 00:41:15,390
go routine I can just receive from that
channel the same number of times and

2136
00:41:15,390 --> 00:41:15,400
channel the same number of times and
 

2137
00:41:15,400 --> 00:41:22,830
channel the same number of times and
this has the same effect as a wait group

2138
00:41:22,830 --> 00:41:22,840

 

2139
00:41:22,840 --> 00:41:31,320

so question so what exactly is the

2140
00:41:31,320 --> 00:41:31,330
so question so what exactly is the
 

2141
00:41:31,330 --> 00:41:33,830
so question so what exactly is the
question

2142
00:41:33,830 --> 00:41:33,840

 

2143
00:41:33,840 --> 00:41:37,500

[Music]

2144
00:41:37,500 --> 00:41:37,510

 

2145
00:41:37,510 --> 00:41:39,970

so the question is here could you use a

2146
00:41:39,970 --> 00:41:39,980
so the question is here could you use a
 

2147
00:41:39,980 --> 00:41:41,620
so the question is here could you use a
buffered channel with a capacity of five

2148
00:41:41,620 --> 00:41:41,630
buffered channel with a capacity of five
 

2149
00:41:41,630 --> 00:41:43,120
buffered channel with a capacity of five
because you're waiting for five receives

2150
00:41:43,120 --> 00:41:43,130
because you're waiting for five receives
 

2151
00:41:43,130 --> 00:41:45,460
because you're waiting for five receives
I think in this particular case yes that

2152
00:41:45,460 --> 00:41:45,470
I think in this particular case yes that
 

2153
00:41:45,470 --> 00:41:47,560
I think in this particular case yes that
would have the equivalent effect but I

2154
00:41:47,560 --> 00:41:47,570
would have the equivalent effect but I
 

2155
00:41:47,570 --> 00:41:49,270
would have the equivalent effect but I
think there's not really a reason to do

2156
00:41:49,270 --> 00:41:49,280
think there's not really a reason to do
 

2157
00:41:49,280 --> 00:41:50,010
think there's not really a reason to do
that

2158
00:41:50,010 --> 00:41:50,020
that
 

2159
00:41:50,020 --> 00:41:52,210
that
and I think at a high level in your code

2160
00:41:52,210 --> 00:41:52,220
and I think at a high level in your code
 

2161
00:41:52,220 --> 00:41:53,650
and I think at a high level in your code
you should avoid buffer channels and

2162
00:41:53,650 --> 00:41:53,660
you should avoid buffer channels and
 

2163
00:41:53,660 --> 00:41:55,480
you should avoid buffer channels and
also maybe even channels unless you

2164
00:41:55,480 --> 00:41:55,490
also maybe even channels unless you
 

2165
00:41:55,490 --> 00:41:57,030
also maybe even channels unless you
think very hard about what you're doing

2166
00:41:57,030 --> 00:41:57,040
think very hard about what you're doing
 

2167
00:41:57,040 --> 00:42:07,990
think very hard about what you're doing
yeah so what is a weight group I think

2168
00:42:07,990 --> 00:42:08,000
yeah so what is a weight group I think
 

2169
00:42:08,000 --> 00:42:09,490
yeah so what is a weight group I think
we covered this in a previous lecture

2170
00:42:09,490 --> 00:42:09,500
we covered this in a previous lecture
 

2171
00:42:09,500 --> 00:42:11,820
we covered this in a previous lecture
and I talked about it very briefly today

2172
00:42:11,820 --> 00:42:11,830
and I talked about it very briefly today
 

2173
00:42:11,830 --> 00:42:14,980
and I talked about it very briefly today
but I do have an example of weight

2174
00:42:14,980 --> 00:42:14,990
but I do have an example of weight
 

2175
00:42:14,990 --> 00:42:18,940
but I do have an example of weight
groups so a weight group is a yet

2176
00:42:18,940 --> 00:42:18,950
groups so a weight group is a yet
 

2177
00:42:18,950 --> 00:42:20,140
groups so a weight group is a yet
another synchronization primitive

2178
00:42:20,140 --> 00:42:20,150
another synchronization primitive
 

2179
00:42:20,150 --> 00:42:21,670
another synchronization primitive
provided by go in the sync package and

2180
00:42:21,670 --> 00:42:21,680
provided by go in the sync package and
 

2181
00:42:21,680 --> 00:42:24,340
provided by go in the sync package and
it kind of does what his name advertises

2182
00:42:24,340 --> 00:42:24,350
it kind of does what his name advertises
 

2183
00:42:24,350 --> 00:42:25,690
it kind of does what his name advertises
like it lets you wait for a certain

2184
00:42:25,690 --> 00:42:25,700
like it lets you wait for a certain
 

2185
00:42:25,700 --> 00:42:27,250
like it lets you wait for a certain
number of threads to be done the way it

2186
00:42:27,250 --> 00:42:27,260
number of threads to be done the way it
 

2187
00:42:27,260 --> 00:42:29,110
number of threads to be done the way it
works is you call weight group dot add

2188
00:42:29,110 --> 00:42:29,120
works is you call weight group dot add
 

2189
00:42:29,120 --> 00:42:31,720
works is you call weight group dot add
and that basically increments some

2190
00:42:31,720 --> 00:42:31,730
and that basically increments some
 

2191
00:42:31,730 --> 00:42:33,460
and that basically increments some
internal counter and then when you call

2192
00:42:33,460 --> 00:42:33,470
internal counter and then when you call
 

2193
00:42:33,470 --> 00:42:35,680
internal counter and then when you call
weight group dot weight it waits till

2194
00:42:35,680 --> 00:42:35,690
weight group dot weight it waits till
 

2195
00:42:35,690 --> 00:42:38,350
weight group dot weight it waits till
done has been called as many times as ad

2196
00:42:38,350 --> 00:42:38,360
done has been called as many times as ad
 

2197
00:42:38,360 --> 00:42:42,520
done has been called as many times as ad
was called so this code is basically the

2198
00:42:42,520 --> 00:42:42,530
was called so this code is basically the
 

2199
00:42:42,530 --> 00:42:43,930
was called so this code is basically the
same as the code I just showed you that

2200
00:42:43,930 --> 00:42:43,940
same as the code I just showed you that
 

2201
00:42:43,940 --> 00:42:45,850
same as the code I just showed you that
was using a channel except this is using

2202
00:42:45,850 --> 00:42:45,860
was using a channel except this is using
 

2203
00:42:45,860 --> 00:42:47,110
was using a channel except this is using
weight group they have the exact same

2204
00:42:47,110 --> 00:42:47,120
weight group they have the exact same
 

2205
00:42:47,120 --> 00:43:01,930
weight group they have the exact same
effect you can use either one yeah

2206
00:43:01,930 --> 00:43:01,940

 

2207
00:43:01,940 --> 00:43:04,700

so the question here is about race

2208
00:43:04,700 --> 00:43:04,710
so the question here is about race
 

2209
00:43:04,710 --> 00:43:06,730
so the question here is about race
conditions I think like what happens if

2210
00:43:06,730 --> 00:43:06,740
conditions I think like what happens if
 

2211
00:43:06,740 --> 00:43:09,770
conditions I think like what happens if
this ad doesn't happen fast enough

2212
00:43:09,770 --> 00:43:09,780
this ad doesn't happen fast enough
 

2213
00:43:09,780 --> 00:43:11,450
this ad doesn't happen fast enough
before this weight happens or something

2214
00:43:11,450 --> 00:43:11,460
before this weight happens or something
 

2215
00:43:11,460 --> 00:43:13,790
before this weight happens or something
like that well so here notice that the

2216
00:43:13,790 --> 00:43:13,800
like that well so here notice that the
 

2217
00:43:13,800 --> 00:43:15,740
like that well so here notice that the
pattern here is we call weight group

2218
00:43:15,740 --> 00:43:15,750
pattern here is we call weight group
 

2219
00:43:15,750 --> 00:43:19,100
pattern here is we call weight group
data outside of this go routine and it's

2220
00:43:19,100 --> 00:43:19,110
data outside of this go routine and it's
 

2221
00:43:19,110 --> 00:43:21,230
data outside of this go routine and it's
called before spawning this go routine

2222
00:43:21,230 --> 00:43:21,240
called before spawning this go routine
 

2223
00:43:21,240 --> 00:43:24,050
called before spawning this go routine
so this happens first this happens next

2224
00:43:24,050 --> 00:43:24,060
so this happens first this happens next
 

2225
00:43:24,060 --> 00:43:26,900
so this happens first this happens next
and so we'll never have the situation

2226
00:43:26,900 --> 00:43:26,910
and so we'll never have the situation
 

2227
00:43:26,910 --> 00:43:29,900
and so we'll never have the situation
we're done happens after this ad happens

2228
00:43:29,900 --> 00:43:29,910
we're done happens after this ad happens
 

2229
00:43:29,910 --> 00:43:51,440
we're done happens after this ad happens
for this particular routine how's this

2230
00:43:51,440 --> 00:43:51,450
for this particular routine how's this
 

2231
00:43:51,450 --> 00:43:54,230
for this particular routine how's this
implemented by the compiler and I will

2232
00:43:54,230 --> 00:43:54,240
implemented by the compiler and I will
 

2233
00:43:54,240 --> 00:43:55,490
implemented by the compiler and I will
not talk about that now but talk to me

2234
00:43:55,490 --> 00:43:55,500
not talk about that now but talk to me
 

2235
00:43:55,500 --> 00:43:57,830
not talk about that now but talk to me
after class or in office hours but I

2236
00:43:57,830 --> 00:43:57,840
after class or in office hours but I
 

2237
00:43:57,840 --> 00:43:59,210
after class or in office hours but I
think for the purposes class like you

2238
00:43:59,210 --> 00:43:59,220
think for the purposes class like you
 

2239
00:43:59,220 --> 00:44:00,560
think for the purposes class like you
need to know the API for these things

2240
00:44:00,560 --> 00:44:00,570
need to know the API for these things
 

2241
00:44:00,570 --> 00:44:04,640
need to know the API for these things
not the implementation all right and so

2242
00:44:04,640 --> 00:44:04,650
not the implementation all right and so
 

2243
00:44:04,650 --> 00:44:07,700
not the implementation all right and so
I think that's basically all I have on

2244
00:44:07,700 --> 00:44:07,710
I think that's basically all I have on
 

2245
00:44:07,710 --> 00:44:12,320
I think that's basically all I have on
go concurrency primitives so one final

2246
00:44:12,320 --> 00:44:12,330
go concurrency primitives so one final
 

2247
00:44:12,330 --> 00:44:13,910
go concurrency primitives so one final
thought is on channels like channels are

2248
00:44:13,910 --> 00:44:13,920
thought is on channels like channels are
 

2249
00:44:13,920 --> 00:44:15,380
thought is on channels like channels are
good for a specific set of things like I

2250
00:44:15,380 --> 00:44:15,390
good for a specific set of things like I
 

2251
00:44:15,390 --> 00:44:16,520
good for a specific set of things like I
just showed you the producer consumer

2252
00:44:16,520 --> 00:44:16,530
just showed you the producer consumer
 

2253
00:44:16,530 --> 00:44:17,900
just showed you the producer consumer
queue or like implementing something

2254
00:44:17,900 --> 00:44:17,910
queue or like implementing something
 

2255
00:44:17,910 --> 00:44:19,340
queue or like implementing something
like weight groups but I think when you

2256
00:44:19,340 --> 00:44:19,350
like weight groups but I think when you
 

2257
00:44:19,350 --> 00:44:21,410
like weight groups but I think when you
try to do fancier things with them like

2258
00:44:21,410 --> 00:44:21,420
try to do fancier things with them like
 

2259
00:44:21,420 --> 00:44:24,320
try to do fancier things with them like
if you want to say like kick another go

2260
00:44:24,320 --> 00:44:24,330
if you want to say like kick another go
 

2261
00:44:24,330 --> 00:44:25,610
if you want to say like kick another go
routine that may or may not be waiting

2262
00:44:25,610 --> 00:44:25,620
routine that may or may not be waiting
 

2263
00:44:25,620 --> 00:44:27,380
routine that may or may not be waiting
for you to be like woken up that's a

2264
00:44:27,380 --> 00:44:27,390
for you to be like woken up that's a
 

2265
00:44:27,390 --> 00:44:28,640
for you to be like woken up that's a
kind of tricky thing to do with channels

2266
00:44:28,640 --> 00:44:28,650
kind of tricky thing to do with channels
 

2267
00:44:28,650 --> 00:44:30,170
kind of tricky thing to do with channels
there's also a bunch of other ways to

2268
00:44:30,170 --> 00:44:30,180
there's also a bunch of other ways to
 

2269
00:44:30,180 --> 00:44:31,550
there's also a bunch of other ways to
shoot yourself in the foot with them I'm

2270
00:44:31,550 --> 00:44:31,560
shoot yourself in the foot with them I'm
 

2271
00:44:31,560 --> 00:44:33,080
shoot yourself in the foot with them I'm
going to avoid showing you examples of

2272
00:44:33,080 --> 00:44:33,090
going to avoid showing you examples of
 

2273
00:44:33,090 --> 00:44:35,180
going to avoid showing you examples of
bad code with channels just because it's

2274
00:44:35,180 --> 00:44:35,190
bad code with channels just because it's
 

2275
00:44:35,190 --> 00:44:37,850
bad code with channels just because it's
not useful to see but I personally avoid

2276
00:44:37,850 --> 00:44:37,860
not useful to see but I personally avoid
 

2277
00:44:37,860 --> 00:44:39,320
not useful to see but I personally avoid
using channels for the most part and

2278
00:44:39,320 --> 00:44:39,330
using channels for the most part and
 

2279
00:44:39,330 --> 00:44:42,050
using channels for the most part and
just use shared memory and mutexes and

2280
00:44:42,050 --> 00:44:42,060
just use shared memory and mutexes and
 

2281
00:44:42,060 --> 00:44:43,370
just use shared memory and mutexes and
condition variables and set and I

2282
00:44:43,370 --> 00:44:43,380
condition variables and set and I
 

2283
00:44:43,380 --> 00:44:44,690
condition variables and set and I
personally find those much easier to

2284
00:44:44,690 --> 00:44:44,700
personally find those much easier to
 

2285
00:44:44,700 --> 00:44:47,990
personally find those much easier to
reason about so feel free to use

2286
00:44:47,990 --> 00:44:48,000
reason about so feel free to use
 

2287
00:44:48,000 --> 00:44:49,580
reason about so feel free to use
channels for when they make sense but if

2288
00:44:49,580 --> 00:44:49,590
channels for when they make sense but if
 

2289
00:44:49,590 --> 00:44:51,020
channels for when they make sense but if
anything looks especially awkward to do

2290
00:44:51,020 --> 00:44:51,030
anything looks especially awkward to do
 

2291
00:44:51,030 --> 00:44:52,670
anything looks especially awkward to do
with channels like just use mutexes and

2292
00:44:52,670 --> 00:44:52,680
with channels like just use mutexes and
 

2293
00:44:52,680 --> 00:44:53,690
with channels like just use mutexes and
condition variables and they're probably

2294
00:44:53,690 --> 00:44:53,700
condition variables and they're probably
 

2295
00:44:53,700 --> 00:45:02,589
condition variables and they're probably
a better tool yeah

2296
00:45:02,589 --> 00:45:02,599

 

2297
00:45:02,599 --> 00:45:04,789

so the question is with the difference

2298
00:45:04,789 --> 00:45:04,799
so the question is with the difference
 

2299
00:45:04,799 --> 00:45:06,079
so the question is with the difference
between this producer-consumer pattern

2300
00:45:06,079 --> 00:45:06,089
between this producer-consumer pattern
 

2301
00:45:06,089 --> 00:45:07,759
between this producer-consumer pattern
here in a thread-safe FIFO I think

2302
00:45:07,759 --> 00:45:07,769
here in a thread-safe FIFO I think
 

2303
00:45:07,769 --> 00:45:09,650
here in a thread-safe FIFO I think
they're kind of equivalent like you

2304
00:45:09,650 --> 00:45:09,660
they're kind of equivalent like you
 

2305
00:45:09,660 --> 00:45:11,329
they're kind of equivalent like you
could do this with the thread-safe FIFO

2306
00:45:11,329 --> 00:45:11,339
could do this with the thread-safe FIFO
 

2307
00:45:11,339 --> 00:45:14,230
could do this with the thread-safe FIFO
and it like that is basically what a

2308
00:45:14,230 --> 00:45:14,240
and it like that is basically what a
 

2309
00:45:14,240 --> 00:45:35,539
and it like that is basically what a
like buffered channel is roughly if

2310
00:45:35,539 --> 00:45:35,549
like buffered channel is roughly if
 

2311
00:45:35,549 --> 00:45:37,130
like buffered channel is roughly if
you're in queueing things in Indy

2312
00:45:37,130 --> 00:45:37,140
you're in queueing things in Indy
 

2313
00:45:37,140 --> 00:45:38,630
you're in queueing things in Indy
queueing things like if you want this

2314
00:45:38,630 --> 00:45:38,640
queueing things like if you want this
 

2315
00:45:38,640 --> 00:45:40,279
queueing things like if you want this
line to finish and have this thread go

2316
00:45:40,279 --> 00:45:40,289
line to finish and have this thread go
 

2317
00:45:40,289 --> 00:45:41,720
line to finish and have this thread go
do something else while that data sits

2318
00:45:41,720 --> 00:45:41,730
do something else while that data sits
 

2319
00:45:41,730 --> 00:45:43,819
do something else while that data sits
there in a queue rather than this girl

2320
00:45:43,819 --> 00:45:43,829
there in a queue rather than this girl
 

2321
00:45:43,829 --> 00:45:45,620
there in a queue rather than this girl
routine waiting to send it then a

2322
00:45:45,620 --> 00:45:45,630
routine waiting to send it then a
 

2323
00:45:45,630 --> 00:45:48,950
routine waiting to send it then a
buffered channel might make sense but I

2324
00:45:48,950 --> 00:45:48,960
buffered channel might make sense but I
 

2325
00:45:48,960 --> 00:45:50,120
buffered channel might make sense but I
think at least in the lives you will not

2326
00:45:50,120 --> 00:45:50,130
think at least in the lives you will not
 

2327
00:45:50,130 --> 00:45:53,839
think at least in the lives you will not
have a pattern like that all right so

2328
00:45:53,839 --> 00:45:53,849
have a pattern like that all right so
 

2329
00:45:53,849 --> 00:45:56,539
have a pattern like that all right so
next Fabian's going to talk about more

2330
00:45:56,539 --> 00:45:56,549
next Fabian's going to talk about more
 

2331
00:45:56,549 --> 00:46:13,620
next Fabian's going to talk about more
rapidly related stuff do you need this

2332
00:46:13,620 --> 00:46:13,630

 

2333
00:46:13,630 --> 00:46:16,629

all right can you all hear me is this

2334
00:46:16,629 --> 00:46:16,639
all right can you all hear me is this
 

2335
00:46:16,639 --> 00:46:24,699
all right can you all hear me is this
working yeah all right so yeah basically

2336
00:46:24,699 --> 00:46:24,709
working yeah all right so yeah basically
 

2337
00:46:24,709 --> 00:46:27,399
working yeah all right so yeah basically
I'm going to show you two bugs that we

2338
00:46:27,399 --> 00:46:27,409
I'm going to show you two bugs that we
 

2339
00:46:27,409 --> 00:46:29,439
I'm going to show you two bugs that we
commonly see in people's raft

2340
00:46:29,439 --> 00:46:29,449
commonly see in people's raft
 

2341
00:46:29,449 --> 00:46:30,819
commonly see in people's raft
implementations there's a lot of bugs

2342
00:46:30,819 --> 00:46:30,829
implementations there's a lot of bugs
 

2343
00:46:30,829 --> 00:46:32,889
implementations there's a lot of bugs
that are pretty common but I'm just

2344
00:46:32,889 --> 00:46:32,899
that are pretty common but I'm just
 

2345
00:46:32,899 --> 00:46:35,979
that are pretty common but I'm just
going to focus on two of them so in this

2346
00:46:35,979 --> 00:46:35,989
going to focus on two of them so in this
 

2347
00:46:35,989 --> 00:46:38,859
going to focus on two of them so in this
first example we sort of have a start of

2348
00:46:38,859 --> 00:46:38,869
first example we sort of have a start of
 

2349
00:46:38,869 --> 00:46:41,259
first example we sort of have a start of
a raft implementation for that's sort of

2350
00:46:41,259 --> 00:46:41,269
a raft implementation for that's sort of
 

2351
00:46:41,269 --> 00:46:43,059
a raft implementation for that's sort of
like what you might see for to a just

2352
00:46:43,059 --> 00:46:43,069
like what you might see for to a just
 

2353
00:46:43,069 --> 00:46:43,959
like what you might see for to a just
the beginnings of one

2354
00:46:43,959 --> 00:46:43,969
the beginnings of one
 

2355
00:46:43,969 --> 00:46:48,009
the beginnings of one
so in our raft state we have primarily

2356
00:46:48,009 --> 00:46:48,019
so in our raft state we have primarily
 

2357
00:46:48,019 --> 00:46:50,229
so in our raft state we have primarily
the current status of the raft pier

2358
00:46:50,229 --> 00:46:50,239
the current status of the raft pier
 

2359
00:46:50,239 --> 00:46:52,209
the current status of the raft pier
either follower candidate or leader and

2360
00:46:52,209 --> 00:46:52,219
either follower candidate or leader and
 

2361
00:46:52,219 --> 00:46:54,189
either follower candidate or leader and
we have these two state variables that

2362
00:46:54,189 --> 00:46:54,199
we have these two state variables that
 

2363
00:46:54,199 --> 00:46:55,509
we have these two state variables that
were keeping track of the current term

2364
00:46:55,509 --> 00:46:55,519
were keeping track of the current term
 

2365
00:46:55,519 --> 00:46:58,169
were keeping track of the current term
and who we voted for in the current term

2366
00:46:58,169 --> 00:46:58,179
and who we voted for in the current term
 

2367
00:46:58,179 --> 00:47:01,149
and who we voted for in the current term
so I'm I want us to focus though on

2368
00:47:01,149 --> 00:47:01,159
so I'm I want us to focus though on
 

2369
00:47:01,159 --> 00:47:04,089
so I'm I want us to focus though on
these two functions attempt election and

2370
00:47:04,089 --> 00:47:04,099
these two functions attempt election and
 

2371
00:47:04,099 --> 00:47:07,689
these two functions attempt election and
call request vote so in a temptin we're

2372
00:47:07,689 --> 00:47:07,699
call request vote so in a temptin we're
 

2373
00:47:07,699 --> 00:47:10,679
call request vote so in a temptin we're
just going to set our state to candidate

2374
00:47:10,679 --> 00:47:10,689
just going to set our state to candidate
 

2375
00:47:10,689 --> 00:47:13,329
just going to set our state to candidate
increment our current term vote for

2376
00:47:13,329 --> 00:47:13,339
increment our current term vote for
 

2377
00:47:13,339 --> 00:47:15,099
increment our current term vote for
ourselves and then start sending out

2378
00:47:15,099 --> 00:47:15,109
ourselves and then start sending out
 

2379
00:47:15,109 --> 00:47:17,439
ourselves and then start sending out
request votes to all of our raft peers

2380
00:47:17,439 --> 00:47:17,449
request votes to all of our raft peers
 

2381
00:47:17,449 --> 00:47:19,989
request votes to all of our raft peers
and so this is similar to some of the

2382
00:47:19,989 --> 00:47:19,999
and so this is similar to some of the
 

2383
00:47:19,999 --> 00:47:23,709
and so this is similar to some of the
patterns that Anish showed where we're

2384
00:47:23,709 --> 00:47:23,719
patterns that Anish showed where we're
 

2385
00:47:23,719 --> 00:47:25,209
patterns that Anish showed where we're
going to loop through our peers and then

2386
00:47:25,209 --> 00:47:25,219
going to loop through our peers and then
 

2387
00:47:25,219 --> 00:47:28,329
going to loop through our peers and then
for each one in a go routines separately

2388
00:47:28,329 --> 00:47:28,339
for each one in a go routines separately
 

2389
00:47:28,339 --> 00:47:30,429
for each one in a go routines separately
call this call request vote function in

2390
00:47:30,429 --> 00:47:30,439
call this call request vote function in
 

2391
00:47:30,439 --> 00:47:32,589
call this call request vote function in
order to actually send an RPC to that

2392
00:47:32,589 --> 00:47:32,599
order to actually send an RPC to that
 

2393
00:47:32,599 --> 00:47:33,509
order to actually send an RPC to that
peer

2394
00:47:33,509 --> 00:47:33,519
peer
 

2395
00:47:33,519 --> 00:47:36,819
peer
alright so in call request vote we're

2396
00:47:36,819 --> 00:47:36,829
alright so in call request vote we're
 

2397
00:47:36,829 --> 00:47:40,269
alright so in call request vote we're
going to acquire the lock prepare

2398
00:47:40,269 --> 00:47:40,279
going to acquire the lock prepare
 

2399
00:47:40,279 --> 00:47:42,639
going to acquire the lock prepare
arguments for our request Ville RPC call

2400
00:47:42,639 --> 00:47:42,649
arguments for our request Ville RPC call
 

2401
00:47:42,649 --> 00:47:44,679
arguments for our request Ville RPC call
based on by setting it to the current

2402
00:47:44,679 --> 00:47:44,689
based on by setting it to the current
 

2403
00:47:44,689 --> 00:47:47,679
based on by setting it to the current
term and then actually perform the RPC

2404
00:47:47,679 --> 00:47:47,689
term and then actually perform the RPC
 

2405
00:47:47,689 --> 00:47:49,959
term and then actually perform the RPC
call over here and finally based on the

2406
00:47:49,959 --> 00:47:49,969
call over here and finally based on the
 

2407
00:47:49,969 --> 00:47:54,069
call over here and finally based on the
response we will reply back to this this

2408
00:47:54,069 --> 00:47:54,079
response we will reply back to this this
 

2409
00:47:54,079 --> 00:47:55,779
response we will reply back to this this
attempt election function and the

2410
00:47:55,779 --> 00:47:55,789
attempt election function and the
 

2411
00:47:55,789 --> 00:47:56,919
attempt election function and the
attempt election function eventually

2412
00:47:56,919 --> 00:47:56,929
attempt election function eventually
 

2413
00:47:56,929 --> 00:47:58,689
attempt election function eventually
should tally up the votes to see if it

2414
00:47:58,689 --> 00:47:58,699
should tally up the votes to see if it
 

2415
00:47:58,699 --> 00:48:00,129
should tally up the votes to see if it
got a majority of the votes and can

2416
00:48:00,129 --> 00:48:00,139
got a majority of the votes and can
 

2417
00:48:00,139 --> 00:48:04,209
got a majority of the votes and can
become leader so what happens when we

2418
00:48:04,209 --> 00:48:04,219
become leader so what happens when we
 

2419
00:48:04,219 --> 00:48:06,429
become leader so what happens when we
run this code so in theory what we might

2420
00:48:06,429 --> 00:48:06,439
run this code so in theory what we might
 

2421
00:48:06,439 --> 00:48:08,829
run this code so in theory what we might
expect to happen is four so there's

2422
00:48:08,829 --> 00:48:08,839
expect to happen is four so there's
 

2423
00:48:08,839 --> 00:48:10,089
expect to happen is four so there's
going to be some code that's going to

2424
00:48:10,089 --> 00:48:10,099
going to be some code that's going to
 

2425
00:48:10,099 --> 00:48:11,769
going to be some code that's going to
spawn a few graph spears and actually

2426
00:48:11,769 --> 00:48:11,779
spawn a few graph spears and actually
 

2427
00:48:11,779 --> 00:48:13,949
spawn a few graph spears and actually
try to attempt elections on them and

2428
00:48:13,949 --> 00:48:13,959
try to attempt elections on them and
 

2429
00:48:13,959 --> 00:48:18,099
try to attempt elections on them and
what should happen are we just start

2430
00:48:18,099 --> 00:48:18,109
what should happen are we just start
 

2431
00:48:18,109 --> 00:48:19,599
what should happen are we just start
collecting votes from other peers and

2432
00:48:19,599 --> 00:48:19,609
collecting votes from other peers and
 

2433
00:48:19,609 --> 00:48:21,129
collecting votes from other peers and
then we're not actually going to tally

2434
00:48:21,129 --> 00:48:21,139
then we're not actually going to tally
 

2435
00:48:21,139 --> 00:48:21,640
then we're not actually going to tally
them up

2436
00:48:21,640 --> 00:48:21,650
them up
 

2437
00:48:21,650 --> 00:48:24,249
them up
but hopefully nothing weird goes wrong

2438
00:48:24,249 --> 00:48:24,259
but hopefully nothing weird goes wrong
 

2439
00:48:24,259 --> 00:48:26,019
but hopefully nothing weird goes wrong
but actually something is going to go

2440
00:48:26,019 --> 00:48:26,029
but actually something is going to go
 

2441
00:48:26,029 --> 00:48:29,289
but actually something is going to go
wrong here and we actually activated

2442
00:48:29,289 --> 00:48:29,299
wrong here and we actually activated
 

2443
00:48:29,299 --> 00:48:31,569
wrong here and we actually activated
goes deadlock detector and somehow we

2444
00:48:31,569 --> 00:48:31,579
goes deadlock detector and somehow we
 

2445
00:48:31,579 --> 00:48:33,849
goes deadlock detector and somehow we
ran into a deadlock so let's see what

2446
00:48:33,849 --> 00:48:33,859
ran into a deadlock so let's see what
 

2447
00:48:33,859 --> 00:48:37,390
ran into a deadlock so let's see what
happened for now let's focus on what's

2448
00:48:37,390 --> 00:48:37,400
happened for now let's focus on what's
 

2449
00:48:37,400 --> 00:48:40,989
happened for now let's focus on what's
going on with the server zero so server

2450
00:48:40,989 --> 00:48:40,999
going on with the server zero so server
 

2451
00:48:40,999 --> 00:48:42,759
going on with the server zero so server
zero it says it starts attempting an

2452
00:48:42,759 --> 00:48:42,769
zero it says it starts attempting an
 

2453
00:48:42,769 --> 00:48:45,460
zero it says it starts attempting an
election at term one that's just

2454
00:48:45,460 --> 00:48:45,470
election at term one that's just
 

2455
00:48:45,470 --> 00:48:47,019
election at term one that's just
starting the attempt election function

2456
00:48:47,019 --> 00:48:47,029
starting the attempt election function
 

2457
00:48:47,029 --> 00:48:49,029
starting the attempt election function
it will acquire the lock set some of the

2458
00:48:49,029 --> 00:48:49,039
it will acquire the lock set some of the
 

2459
00:48:49,039 --> 00:48:50,739
it will acquire the lock set some of the
set some stuff up for performing the

2460
00:48:50,739 --> 00:48:50,749
set some stuff up for performing the
 

2461
00:48:50,749 --> 00:48:57,039
set some stuff up for performing the
election and then unlock then it's going

2462
00:48:57,039 --> 00:48:57,049
election and then unlock then it's going
 

2463
00:48:57,049 --> 00:48:59,589
election and then unlock then it's going
to send out a request vote RPC - server

2464
00:48:59,589 --> 00:48:59,599
to send out a request vote RPC - server
 

2465
00:48:59,599 --> 00:49:03,759
to send out a request vote RPC - server
- it finishes processing that request

2466
00:49:03,759 --> 00:49:03,769
- it finishes processing that request
 

2467
00:49:03,769 --> 00:49:05,140
- it finishes processing that request
vote RPC over here so we're just

2468
00:49:05,140 --> 00:49:05,150
vote RPC over here so we're just
 

2469
00:49:05,150 --> 00:49:06,999
vote RPC over here so we're just
printing right before and after we

2470
00:49:06,999 --> 00:49:07,009
printing right before and after we
 

2471
00:49:07,009 --> 00:49:09,789
printing right before and after we
actually send out the RPC and then it

2472
00:49:09,789 --> 00:49:09,799
actually send out the RPC and then it
 

2473
00:49:09,799 --> 00:49:11,920
actually send out the RPC and then it
sends out a request vote RPC - server

2474
00:49:11,920 --> 00:49:11,930
sends out a request vote RPC - server
 

2475
00:49:11,930 --> 00:49:14,079
sends out a request vote RPC - server
one but after that it never we never

2476
00:49:14,079 --> 00:49:14,089
one but after that it never we never
 

2477
00:49:14,089 --> 00:49:15,670
one but after that it never we never
actually see it finish sending the

2478
00:49:15,670 --> 00:49:15,680
actually see it finish sending the
 

2479
00:49:15,680 --> 00:49:18,839
actually see it finish sending the
request vote RPC so it's actually stuck

2480
00:49:18,839 --> 00:49:18,849
request vote RPC so it's actually stuck
 

2481
00:49:18,849 --> 00:49:21,670
request vote RPC so it's actually stuck
in this function call waiting for the

2482
00:49:21,670 --> 00:49:21,680
in this function call waiting for the
 

2483
00:49:21,680 --> 00:49:24,309
in this function call waiting for the
RPC response from server 1 all right now

2484
00:49:24,309 --> 00:49:24,319
RPC response from server 1 all right now
 

2485
00:49:24,319 --> 00:49:25,839
RPC response from server 1 all right now
let's look at what's everyone's doing so

2486
00:49:25,839 --> 00:49:25,849
let's look at what's everyone's doing so
 

2487
00:49:25,849 --> 00:49:27,910
let's look at what's everyone's doing so
it's it's pretty much the same thing it

2488
00:49:27,910 --> 00:49:27,920
it's it's pretty much the same thing it
 

2489
00:49:27,920 --> 00:49:29,410
it's it's pretty much the same thing it
sends a request vote I received a server

2490
00:49:29,410 --> 00:49:29,420
sends a request vote I received a server
 

2491
00:49:29,420 --> 00:49:32,859
sends a request vote I received a server
to that that succeeds it finishes

2492
00:49:32,859 --> 00:49:32,869
to that that succeeds it finishes
 

2493
00:49:32,869 --> 00:49:34,420
to that that succeeds it finishes
processing that request vote the

2494
00:49:34,420 --> 00:49:34,430
processing that request vote the
 

2495
00:49:34,430 --> 00:49:36,339
processing that request vote the
response from server 2 then it sends

2496
00:49:36,339 --> 00:49:36,349
response from server 2 then it sends
 

2497
00:49:36,349 --> 00:49:39,670
response from server 2 then it sends
this RPC to zero and now what's actually

2498
00:49:39,670 --> 00:49:39,680
this RPC to zero and now what's actually
 

2499
00:49:39,680 --> 00:49:41,979
this RPC to zero and now what's actually
happening is 0 & 1 are sort of waiting

2500
00:49:41,979 --> 00:49:41,989
happening is 0 & 1 are sort of waiting
 

2501
00:49:41,989 --> 00:49:43,690
happening is 0 & 1 are sort of waiting
for the RPC responses from each other

2502
00:49:43,690 --> 00:49:43,700
for the RPC responses from each other
 

2503
00:49:43,700 --> 00:49:45,549
for the RPC responses from each other
they both sent out an RPC call but not

2504
00:49:45,549 --> 00:49:45,559
they both sent out an RPC call but not
 

2505
00:49:45,559 --> 00:49:48,759
they both sent out an RPC call but not
yet got the response yet and that's

2506
00:49:48,759 --> 00:49:48,769
yet got the response yet and that's
 

2507
00:49:48,769 --> 00:49:50,259
yet got the response yet and that's
actually sort of the cause of our

2508
00:49:50,259 --> 00:49:50,269
actually sort of the cause of our
 

2509
00:49:50,269 --> 00:49:53,620
actually sort of the cause of our
deadlock so really what's the reason

2510
00:49:53,620 --> 00:49:53,630
deadlock so really what's the reason
 

2511
00:49:53,630 --> 00:49:54,880
deadlock so really what's the reason
that we're dead locking is because we're

2512
00:49:54,880 --> 00:49:54,890
that we're dead locking is because we're
 

2513
00:49:54,890 --> 00:49:57,720
that we're dead locking is because we're
holding this lock through our RPC calls

2514
00:49:57,720 --> 00:49:57,730
holding this lock through our RPC calls
 

2515
00:49:57,730 --> 00:49:59,799
holding this lock through our RPC calls
over here in the core requests vote

2516
00:49:59,799 --> 00:49:59,809
over here in the core requests vote
 

2517
00:49:59,809 --> 00:50:02,380
over here in the core requests vote
function we acquire our mutex associated

2518
00:50:02,380 --> 00:50:02,390
function we acquire our mutex associated
 

2519
00:50:02,390 --> 00:50:04,989
function we acquire our mutex associated
with our raft peer and we only unlock at

2520
00:50:04,989 --> 00:50:04,999
with our raft peer and we only unlock at
 

2521
00:50:04,999 --> 00:50:06,489
with our raft peer and we only unlock at
the end of this function so throughout

2522
00:50:06,489 --> 00:50:06,499
the end of this function so throughout
 

2523
00:50:06,499 --> 00:50:07,809
the end of this function so throughout
this entire function we're holding the

2524
00:50:07,809 --> 00:50:07,819
this entire function we're holding the
 

2525
00:50:07,819 --> 00:50:10,900
this entire function we're holding the
lock including when we try to contact

2526
00:50:10,900 --> 00:50:10,910
lock including when we try to contact
 

2527
00:50:10,910 --> 00:50:17,229
lock including when we try to contact
our peer to get the vote and later when

2528
00:50:17,229 --> 00:50:17,239
our peer to get the vote and later when
 

2529
00:50:17,239 --> 00:50:22,569
our peer to get the vote and later when
we handle this request vote RPC we

2530
00:50:22,569 --> 00:50:22,579
we handle this request vote RPC we
 

2531
00:50:22,579 --> 00:50:24,489
we handle this request vote RPC we
actually only see it at the beginning of

2532
00:50:24,489 --> 00:50:24,499
actually only see it at the beginning of
 

2533
00:50:24,499 --> 00:50:26,589
actually only see it at the beginning of
this function in the handler we're also

2534
00:50:26,589 --> 00:50:26,599
this function in the handler we're also
 

2535
00:50:26,599 --> 00:50:28,150
this function in the handler we're also
trying to acquire the lock but we never

2536
00:50:28,150 --> 00:50:28,160
trying to acquire the lock but we never
 

2537
00:50:28,160 --> 00:50:29,620
trying to acquire the lock but we never
actually succeed in acquiring the lock

2538
00:50:29,620 --> 00:50:29,630
actually succeed in acquiring the lock
 

2539
00:50:29,630 --> 00:50:31,569
actually succeed in acquiring the lock
so just to make this a little bit more

2540
00:50:31,569 --> 00:50:31,579
so just to make this a little bit more
 

2541
00:50:31,579 --> 00:50:34,269
so just to make this a little bit more
clear the the sort of order of

2542
00:50:34,269 --> 00:50:34,279
clear the the sort of order of
 

2543
00:50:34,279 --> 00:50:35,410
clear the the sort of order of
operations

2544
00:50:35,410 --> 00:50:35,420
operations
 

2545
00:50:35,420 --> 00:50:39,690
operations
is happening is in call request vote

2546
00:50:39,690 --> 00:50:39,700
is happening is in call request vote
 

2547
00:50:39,700 --> 00:50:42,700
is happening is in call request vote
server zero is first going to acquire

2548
00:50:42,700 --> 00:50:42,710
server zero is first going to acquire
 

2549
00:50:42,710 --> 00:50:47,500
server zero is first going to acquire
the lock and send an RPC call to server

2550
00:50:47,500 --> 00:50:47,510
the lock and send an RPC call to server
 

2551
00:50:47,510 --> 00:50:51,030
the lock and send an RPC call to server
one and then simultaneously and

2552
00:50:51,030 --> 00:50:51,040
one and then simultaneously and
 

2553
00:50:51,040 --> 00:50:53,079
one and then simultaneously and
separately server one is going to do the

2554
00:50:53,079 --> 00:50:53,089
separately server one is going to do the
 

2555
00:50:53,089 --> 00:50:54,309
separately server one is going to do the
same thing it's going to enter its call

2556
00:50:54,309 --> 00:50:54,319
same thing it's going to enter its call
 

2557
00:50:54,319 --> 00:50:56,079
same thing it's going to enter its call
request vote function acquire the lock

2558
00:50:56,079 --> 00:50:56,089
request vote function acquire the lock
 

2559
00:50:56,089 --> 00:51:01,799
request vote function acquire the lock
and send this RPC call to server zero

2560
00:51:01,799 --> 00:51:01,809
and send this RPC call to server zero
 

2561
00:51:01,809 --> 00:51:05,200
and send this RPC call to server zero
now in server zeros handler and server

2562
00:51:05,200 --> 00:51:05,210
now in server zeros handler and server
 

2563
00:51:05,210 --> 00:51:07,210
now in server zeros handler and server
ones handler they're trying to acquire

2564
00:51:07,210 --> 00:51:07,220
ones handler they're trying to acquire
 

2565
00:51:07,220 --> 00:51:10,690
ones handler they're trying to acquire
the lock but they can't because they

2566
00:51:10,690 --> 00:51:10,700
the lock but they can't because they
 

2567
00:51:10,700 --> 00:51:11,980
the lock but they can't because they
already are acquiring the lock and

2568
00:51:11,980 --> 00:51:11,990
already are acquiring the lock and
 

2569
00:51:11,990 --> 00:51:13,210
already are acquiring the lock and
trying to send the RPC call to each

2570
00:51:13,210 --> 00:51:13,220
trying to send the RPC call to each
 

2571
00:51:13,220 --> 00:51:15,309
trying to send the RPC call to each
other and that that's actually what's

2572
00:51:15,309 --> 00:51:15,319
other and that that's actually what's
 

2573
00:51:15,319 --> 00:51:18,910
other and that that's actually what's
leading to the deadlock situation so to

2574
00:51:18,910 --> 00:51:18,920
leading to the deadlock situation so to
 

2575
00:51:18,920 --> 00:51:21,430
leading to the deadlock situation so to
solve this basically we want you to not

2576
00:51:21,430 --> 00:51:21,440
solve this basically we want you to not
 

2577
00:51:21,440 --> 00:51:23,470
solve this basically we want you to not
hold locks through RPC calls and that's

2578
00:51:23,470 --> 00:51:23,480
hold locks through RPC calls and that's
 

2579
00:51:23,480 --> 00:51:27,700
hold locks through RPC calls and that's
the solution to this problem in fact we

2580
00:51:27,700 --> 00:51:27,710
the solution to this problem in fact we
 

2581
00:51:27,710 --> 00:51:29,410
the solution to this problem in fact we
don't need the lock here at all instead

2582
00:51:29,410 --> 00:51:29,420
don't need the lock here at all instead
 

2583
00:51:29,420 --> 00:51:32,200
don't need the lock here at all instead
of trying to read the current term when

2584
00:51:32,200 --> 00:51:32,210
of trying to read the current term when
 

2585
00:51:32,210 --> 00:51:34,859
of trying to read the current term when
we enter this call request vote function

2586
00:51:34,859 --> 00:51:34,869
we enter this call request vote function
 

2587
00:51:34,869 --> 00:51:38,309
we enter this call request vote function
we can pass this as an argument here

2588
00:51:38,309 --> 00:51:38,319
we can pass this as an argument here
 

2589
00:51:38,319 --> 00:51:42,760
we can pass this as an argument here
save the term when we had acquired the

2590
00:51:42,760 --> 00:51:42,770
save the term when we had acquired the
 

2591
00:51:42,770 --> 00:51:44,710
save the term when we had acquired the
lock earlier in this attempt election

2592
00:51:44,710 --> 00:51:44,720
lock earlier in this attempt election
 

2593
00:51:44,720 --> 00:51:47,440
lock earlier in this attempt election
and just passed this as a as a variable

2594
00:51:47,440 --> 00:51:47,450
and just passed this as a as a variable
 

2595
00:51:47,450 --> 00:51:48,880
and just passed this as a as a variable
to call request vote so that actually

2596
00:51:48,880 --> 00:51:48,890
to call request vote so that actually
 

2597
00:51:48,890 --> 00:51:51,940
to call request vote so that actually
removes the need to acquire the lock at

2598
00:51:51,940 --> 00:51:51,950
removes the need to acquire the lock at
 

2599
00:51:51,950 --> 00:51:55,720
removes the need to acquire the lock at
all in call request vote alternatively

2600
00:51:55,720 --> 00:51:55,730
all in call request vote alternatively
 

2601
00:51:55,730 --> 00:51:58,000
all in call request vote alternatively
we could lock while we're preparing the

2602
00:51:58,000 --> 00:51:58,010
we could lock while we're preparing the
 

2603
00:51:58,010 --> 00:51:59,559
we could lock while we're preparing the
arguments and then unlock before

2604
00:51:59,559 --> 00:51:59,569
arguments and then unlock before
 

2605
00:51:59,569 --> 00:52:01,839
arguments and then unlock before
actually performing the call and then if

2606
00:52:01,839 --> 00:52:01,849
actually performing the call and then if
 

2607
00:52:01,849 --> 00:52:04,240
actually performing the call and then if
we need to to process the reply we could

2608
00:52:04,240 --> 00:52:04,250
we need to to process the reply we could
 

2609
00:52:04,250 --> 00:52:05,829
we need to to process the reply we could
lock again afterwards so it's just make

2610
00:52:05,829 --> 00:52:05,839
lock again afterwards so it's just make
 

2611
00:52:05,839 --> 00:52:08,049
lock again afterwards so it's just make
sure to unlock before making it

2612
00:52:08,049 --> 00:52:08,059
sure to unlock before making it
 

2613
00:52:08,059 --> 00:52:10,510
sure to unlock before making it
obviously call and then if you need to

2614
00:52:10,510 --> 00:52:10,520
obviously call and then if you need to
 

2615
00:52:10,520 --> 00:52:14,740
obviously call and then if you need to
you can acquire the lock again so now if

2616
00:52:14,740 --> 00:52:14,750
you can acquire the lock again so now if
 

2617
00:52:14,750 --> 00:52:20,319
you can acquire the lock again so now if
I save this then so it's still

2618
00:52:20,319 --> 00:52:20,329
I save this then so it's still
 

2619
00:52:20,329 --> 00:52:21,549
I save this then so it's still
activating the deadlock detector but

2620
00:52:21,549 --> 00:52:21,559
activating the deadlock detector but
 

2621
00:52:21,559 --> 00:52:23,109
activating the deadlock detector but
that's actually just because we're not

2622
00:52:23,109 --> 00:52:23,119
that's actually just because we're not
 

2623
00:52:23,119 --> 00:52:25,480
that's actually just because we're not
doing anything at the end but now it's

2624
00:52:25,480 --> 00:52:25,490
doing anything at the end but now it's
 

2625
00:52:25,490 --> 00:52:26,140
doing anything at the end but now it's
actually working

2626
00:52:26,140 --> 00:52:26,150
actually working
 

2627
00:52:26,150 --> 00:52:28,299
actually working
we finished sending the request votes on

2628
00:52:28,299 --> 00:52:28,309
we finished sending the request votes on
 

2629
00:52:28,309 --> 00:52:29,589
we finished sending the request votes on
both sides and all the operations that

2630
00:52:29,589 --> 00:52:29,599
both sides and all the operations that
 

2631
00:52:29,599 --> 00:52:32,680
both sides and all the operations that
we wanted to complete are complete all

2632
00:52:32,680 --> 00:52:32,690
we wanted to complete are complete all
 

2633
00:52:32,690 --> 00:52:42,170
we wanted to complete are complete all
right any questions about this example

2634
00:52:42,170 --> 00:52:42,180

 

2635
00:52:42,180 --> 00:52:45,559

yeah so not it's sort of so you might

2636
00:52:45,559 --> 00:52:45,569
yeah so not it's sort of so you might
 

2637
00:52:45,569 --> 00:52:47,569
yeah so not it's sort of so you might
need to use locks when you are preparing

2638
00:52:47,569 --> 00:52:47,579
need to use locks when you are preparing
 

2639
00:52:47,579 --> 00:52:49,130
need to use locks when you are preparing
the arguments or processing the response

2640
00:52:49,130 --> 00:52:49,140
the arguments or processing the response
 

2641
00:52:49,140 --> 00:52:50,620
the arguments or processing the response
but yeah you shouldn't hold a lock

2642
00:52:50,620 --> 00:52:50,630
but yeah you shouldn't hold a lock
 

2643
00:52:50,630 --> 00:52:52,880
but yeah you shouldn't hold a lock
through the RPC call while you're

2644
00:52:52,880 --> 00:52:52,890
through the RPC call while you're
 

2645
00:52:52,890 --> 00:52:54,410
through the RPC call while you're
waiting for the other peer to respond

2646
00:52:54,410 --> 00:52:54,420
waiting for the other peer to respond
 

2647
00:52:54,420 --> 00:52:56,480
waiting for the other peer to respond
and there's actually another reason to

2648
00:52:56,480 --> 00:52:56,490
and there's actually another reason to
 

2649
00:52:56,490 --> 00:52:58,160
and there's actually another reason to
that in addition to deadlock the other

2650
00:52:58,160 --> 00:52:58,170
that in addition to deadlock the other
 

2651
00:52:58,170 --> 00:53:00,559
that in addition to deadlock the other
problem is that in some tests we're

2652
00:53:00,559 --> 00:53:00,569
problem is that in some tests we're
 

2653
00:53:00,569 --> 00:53:03,470
problem is that in some tests we're
going to sort of have this unreliable

2654
00:53:03,470 --> 00:53:03,480
going to sort of have this unreliable
 

2655
00:53:03,480 --> 00:53:05,120
going to sort of have this unreliable
network that could delay some of your

2656
00:53:05,120 --> 00:53:05,130
network that could delay some of your
 

2657
00:53:05,130 --> 00:53:08,089
network that could delay some of your
RPC messages potentially by like 50

2658
00:53:08,089 --> 00:53:08,099
RPC messages potentially by like 50
 

2659
00:53:08,099 --> 00:53:11,049
RPC messages potentially by like 50
milliseconds and in that case if you

2660
00:53:11,049 --> 00:53:11,059
milliseconds and in that case if you
 

2661
00:53:11,059 --> 00:53:13,940
milliseconds and in that case if you
hold the lock through an RPC call then

2662
00:53:13,940 --> 00:53:13,950
hold the lock through an RPC call then
 

2663
00:53:13,950 --> 00:53:15,589
hold the lock through an RPC call then
any other operation that you try to do

2664
00:53:15,589 --> 00:53:15,599
any other operation that you try to do
 

2665
00:53:15,599 --> 00:53:17,720
any other operation that you try to do
during that 50 milliseconds won't be

2666
00:53:17,720 --> 00:53:17,730
during that 50 milliseconds won't be
 

2667
00:53:17,730 --> 00:53:19,400
during that 50 milliseconds won't be
able to complete until that RPC response

2668
00:53:19,400 --> 00:53:19,410
able to complete until that RPC response
 

2669
00:53:19,410 --> 00:53:22,220
able to complete until that RPC response
is received so that that's another issue

2670
00:53:22,220 --> 00:53:22,230
is received so that that's another issue
 

2671
00:53:22,230 --> 00:53:23,660
is received so that that's another issue
that you might run into if you hold the

2672
00:53:23,660 --> 00:53:23,670
that you might run into if you hold the
 

2673
00:53:23,670 --> 00:53:25,760
that you might run into if you hold the
long so it's both to make things more

2674
00:53:25,760 --> 00:53:25,770
long so it's both to make things more
 

2675
00:53:25,770 --> 00:53:27,410
long so it's both to make things more
efficient and to avoid these potential

2676
00:53:27,410 --> 00:53:27,420
efficient and to avoid these potential
 

2677
00:53:27,420 --> 00:53:37,390
efficient and to avoid these potential
deadlock situations

2678
00:53:37,390 --> 00:53:37,400

 

2679
00:53:37,400 --> 00:53:41,980

all right so just one more example this

2680
00:53:41,980 --> 00:53:41,990
all right so just one more example this
 

2681
00:53:41,990 --> 00:53:45,280
all right so just one more example this
is again using a similar draft

2682
00:53:45,280 --> 00:53:45,290
is again using a similar draft
 

2683
00:53:45,290 --> 00:53:46,990
is again using a similar draft
implementation so again in our raft

2684
00:53:46,990 --> 00:53:47,000
implementation so again in our raft
 

2685
00:53:47,000 --> 00:53:48,310
implementation so again in our raft
state we're going to be keeping track of

2686
00:53:48,310 --> 00:53:48,320
state we're going to be keeping track of
 

2687
00:53:48,320 --> 00:53:49,720
state we're going to be keeping track of
whether a fuller candidate leader and

2688
00:53:49,720 --> 00:53:49,730
whether a fuller candidate leader and
 

2689
00:53:49,730 --> 00:53:52,810
whether a fuller candidate leader and
then also these two state variables in

2690
00:53:52,810 --> 00:53:52,820
then also these two state variables in
 

2691
00:53:52,820 --> 00:53:54,670
then also these two state variables in
this example I want you to focus on this

2692
00:53:54,670 --> 00:53:54,680
this example I want you to focus on this
 

2693
00:53:54,680 --> 00:53:57,580
this example I want you to focus on this
attempt election function so now we've

2694
00:53:57,580 --> 00:53:57,590
attempt election function so now we've
 

2695
00:53:57,590 --> 00:53:59,350
attempt election function so now we've
first implemented the change that I just

2696
00:53:59,350 --> 00:53:59,360
first implemented the change that I just
 

2697
00:53:59,360 --> 00:54:01,990
first implemented the change that I just
showed you to store the term here and

2698
00:54:01,990 --> 00:54:02,000
showed you to store the term here and
 

2699
00:54:02,000 --> 00:54:04,540
showed you to store the term here and
pass it as a variable to our function

2700
00:54:04,540 --> 00:54:04,550
pass it as a variable to our function
 

2701
00:54:04,550 --> 00:54:06,790
pass it as a variable to our function
that collects the request votes but

2702
00:54:06,790 --> 00:54:06,800
that collects the request votes but
 

2703
00:54:06,800 --> 00:54:07,900
that collects the request votes but
additionally we've implemented some

2704
00:54:07,900 --> 00:54:07,910
additionally we've implemented some
 

2705
00:54:07,910 --> 00:54:10,840
additionally we've implemented some
functionality to add up the votes so

2706
00:54:10,840 --> 00:54:10,850
functionality to add up the votes so
 

2707
00:54:10,850 --> 00:54:12,940
functionality to add up the votes so
what we'll do is we'll create a local

2708
00:54:12,940 --> 00:54:12,950
what we'll do is we'll create a local
 

2709
00:54:12,950 --> 00:54:16,240
what we'll do is we'll create a local
variable to count the votes and whenever

2710
00:54:16,240 --> 00:54:16,250
variable to count the votes and whenever
 

2711
00:54:16,250 --> 00:54:18,490
variable to count the votes and whenever
we get a vote if the vote was not

2712
00:54:18,490 --> 00:54:18,500
we get a vote if the vote was not
 

2713
00:54:18,500 --> 00:54:19,030
we get a vote if the vote was not
granted

2714
00:54:19,030 --> 00:54:19,040
granted
 

2715
00:54:19,040 --> 00:54:20,830
granted
we'll return immediately from this go

2716
00:54:20,830 --> 00:54:20,840
we'll return immediately from this go
 

2717
00:54:20,840 --> 00:54:22,810
we'll return immediately from this go
routine where we're processing the boat

2718
00:54:22,810 --> 00:54:22,820
routine where we're processing the boat
 

2719
00:54:22,820 --> 00:54:25,930
routine where we're processing the boat
otherwise we'll acquire the lock before

2720
00:54:25,930 --> 00:54:25,940
otherwise we'll acquire the lock before
 

2721
00:54:25,940 --> 00:54:28,510
otherwise we'll acquire the lock before
editing this shared local variable to

2722
00:54:28,510 --> 00:54:28,520
editing this shared local variable to
 

2723
00:54:28,520 --> 00:54:31,090
editing this shared local variable to
count up the votes and then if we did

2724
00:54:31,090 --> 00:54:31,100
count up the votes and then if we did
 

2725
00:54:31,100 --> 00:54:32,470
count up the votes and then if we did
not get a majority of the votes will

2726
00:54:32,470 --> 00:54:32,480
not get a majority of the votes will
 

2727
00:54:32,480 --> 00:54:34,780
not get a majority of the votes will
return immediately otherwise we'll make

2728
00:54:34,780 --> 00:54:34,790
return immediately otherwise we'll make
 

2729
00:54:34,790 --> 00:54:38,980
return immediately otherwise we'll make
ourselves the leader so as with the

2730
00:54:38,980 --> 00:54:38,990
ourselves the leader so as with the
 

2731
00:54:38,990 --> 00:54:42,430
ourselves the leader so as with the
other example I mean initially if you

2732
00:54:42,430 --> 00:54:42,440
other example I mean initially if you
 

2733
00:54:42,440 --> 00:54:43,870
other example I mean initially if you
look at this if I look at this like it

2734
00:54:43,870 --> 00:54:43,880
look at this if I look at this like it
 

2735
00:54:43,880 --> 00:54:45,790
look at this if I look at this like it
seems reasonable but let's see if

2736
00:54:45,790 --> 00:54:45,800
seems reasonable but let's see if
 

2737
00:54:45,800 --> 00:54:50,530
seems reasonable but let's see if
anything can go wrong all right so this

2738
00:54:50,530 --> 00:54:50,540
anything can go wrong all right so this
 

2739
00:54:50,540 --> 00:54:53,350
anything can go wrong all right so this
is the log output from one run and one

2740
00:54:53,350 --> 00:54:53,360
is the log output from one run and one
 

2741
00:54:53,360 --> 00:54:54,850
is the log output from one run and one
thing you might notice is that we've

2742
00:54:54,850 --> 00:54:54,860
thing you might notice is that we've
 

2743
00:54:54,860 --> 00:54:57,280
thing you might notice is that we've
actually elected two leaders on the same

2744
00:54:57,280 --> 00:54:57,290
actually elected two leaders on the same
 

2745
00:54:57,290 --> 00:54:59,650
actually elected two leaders on the same
term so server zero

2746
00:54:59,650 --> 00:54:59,660
term so server zero
 

2747
00:54:59,660 --> 00:55:03,610
term so server zero
it was elected made itself a leader on

2748
00:55:03,610 --> 00:55:03,620
it was elected made itself a leader on
 

2749
00:55:03,620 --> 00:55:06,850
it was elected made itself a leader on
term two and server one did as well it's

2750
00:55:06,850 --> 00:55:06,860
term two and server one did as well it's
 

2751
00:55:06,860 --> 00:55:08,470
term two and server one did as well it's
okay to have a leader elected on

2752
00:55:08,470 --> 00:55:08,480
okay to have a leader elected on
 

2753
00:55:08,480 --> 00:55:09,730
okay to have a leader elected on
different terms but here where we have

2754
00:55:09,730 --> 00:55:09,740
different terms but here where we have
 

2755
00:55:09,740 --> 00:55:11,080
different terms but here where we have
one on the same term that that should

2756
00:55:11,080 --> 00:55:11,090
one on the same term that that should
 

2757
00:55:11,090 --> 00:55:13,240
one on the same term that that should
never happen alright so how did this

2758
00:55:13,240 --> 00:55:13,250
never happen alright so how did this
 

2759
00:55:13,250 --> 00:55:15,940
never happen alright so how did this
actually come up so let's start from the

2760
00:55:15,940 --> 00:55:15,950
actually come up so let's start from the
 

2761
00:55:15,950 --> 00:55:18,700
actually come up so let's start from the
top so at the beginning server zero

2762
00:55:18,700 --> 00:55:18,710
top so at the beginning server zero
 

2763
00:55:18,710 --> 00:55:20,200
top so at the beginning server zero
actually attempted an election at term

2764
00:55:20,200 --> 00:55:20,210
actually attempted an election at term
 

2765
00:55:20,210 --> 00:55:23,590
actually attempted an election at term
one not turn two and it got its votes

2766
00:55:23,590 --> 00:55:23,600
one not turn two and it got its votes
 

2767
00:55:23,600 --> 00:55:27,010
one not turn two and it got its votes
from both of the other peers but for

2768
00:55:27,010 --> 00:55:27,020
from both of the other peers but for
 

2769
00:55:27,020 --> 00:55:28,390
from both of the other peers but for
whatever reason perhaps because those

2770
00:55:28,390 --> 00:55:28,400
whatever reason perhaps because those
 

2771
00:55:28,400 --> 00:55:30,670
whatever reason perhaps because those
reply messages from those peers were

2772
00:55:30,670 --> 00:55:30,680
reply messages from those peers were
 

2773
00:55:30,680 --> 00:55:34,650
reply messages from those peers were
delayed it didn't actually process its

2774
00:55:34,650 --> 00:55:34,660
delayed it didn't actually process its
 

2775
00:55:34,660 --> 00:55:38,140
delayed it didn't actually process its
process those votes until later and in

2776
00:55:38,140 --> 00:55:38,150
process those votes until later and in
 

2777
00:55:38,150 --> 00:55:40,390
process those votes until later and in
between receiving it like in between

2778
00:55:40,390 --> 00:55:40,400
between receiving it like in between
 

2779
00:55:40,400 --> 00:55:42,820
between receiving it like in between
attempting the election and finishing

2780
00:55:42,820 --> 00:55:42,830
attempting the election and finishing
 

2781
00:55:42,830 --> 00:55:45,220
attempting the election and finishing
the election server one also decided to

2782
00:55:45,220 --> 00:55:45,230
the election server one also decided to
 

2783
00:55:45,230 --> 00:55:47,010
the election server one also decided to
attempt an election perhaps because

2784
00:55:47,010 --> 00:55:47,020
attempt an election perhaps because
 

2785
00:55:47,020 --> 00:55:49,870
attempt an election perhaps because
because of server zero was delayed so

2786
00:55:49,870 --> 00:55:49,880
because of server zero was delayed so
 

2787
00:55:49,880 --> 00:55:50,800
because of server zero was delayed so
much server one might

2788
00:55:50,800 --> 00:55:50,810
much server one might
 

2789
00:55:50,810 --> 00:55:52,720
much server one might
actually ran into the election timeout

2790
00:55:52,720 --> 00:55:52,730
actually ran into the election timeout
 

2791
00:55:52,730 --> 00:55:54,520
actually ran into the election timeout
and then started its own election and it

2792
00:55:54,520 --> 00:55:54,530
and then started its own election and it
 

2793
00:55:54,530 --> 00:55:57,700
and then started its own election and it
started it on term 2 because it couldn't

2794
00:55:57,700 --> 00:55:57,710
started it on term 2 because it couldn't
 

2795
00:55:57,710 --> 00:55:59,080
started it on term 2 because it couldn't
have been termed 1 because it already

2796
00:55:59,080 --> 00:55:59,090
have been termed 1 because it already
 

2797
00:55:59,090 --> 00:56:01,810
have been termed 1 because it already
voted for server 0 on on term 1 over

2798
00:56:01,810 --> 00:56:01,820
voted for server 0 on on term 1 over
 

2799
00:56:01,820 --> 00:56:03,540
voted for server 0 on on term 1 over
here

2800
00:56:03,540 --> 00:56:03,550
here
 

2801
00:56:03,550 --> 00:56:08,170
here
okay so then server 1 sends out its own

2802
00:56:08,170 --> 00:56:08,180
okay so then server 1 sends out its own
 

2803
00:56:08,180 --> 00:56:11,380
okay so then server 1 sends out its own
request votes 2 servers 2 and 0 at term

2804
00:56:11,380 --> 00:56:11,390
request votes 2 servers 2 and 0 at term
 

2805
00:56:11,390 --> 00:56:14,110
request votes 2 servers 2 and 0 at term
2 and now we see that server two votes

2806
00:56:14,110 --> 00:56:14,120
2 and now we see that server two votes
 

2807
00:56:14,120 --> 00:56:16,090
2 and now we see that server two votes
for server 1 that's fine but server 0

2808
00:56:16,090 --> 00:56:16,100
for server 1 that's fine but server 0
 

2809
00:56:16,100 --> 00:56:18,040
for server 1 that's fine but server 0
also votes for server 1 this is actually

2810
00:56:18,040 --> 00:56:18,050
also votes for server 1 this is actually
 

2811
00:56:18,050 --> 00:56:21,610
also votes for server 1 this is actually
also fine because server one is asking

2812
00:56:21,610 --> 00:56:21,620
also fine because server one is asking
 

2813
00:56:21,620 --> 00:56:25,840
also fine because server one is asking
server 0 for a vote on a higher term and

2814
00:56:25,840 --> 00:56:25,850
server 0 for a vote on a higher term and
 

2815
00:56:25,850 --> 00:56:28,540
server 0 for a vote on a higher term and
so what server 0 should do is if you

2816
00:56:28,540 --> 00:56:28,550
so what server 0 should do is if you
 

2817
00:56:28,550 --> 00:56:33,340
so what server 0 should do is if you
remember from the spec it should set its

2818
00:56:33,340 --> 00:56:33,350
remember from the spec it should set its
 

2819
00:56:33,350 --> 00:56:35,320
remember from the spec it should set its
current term to that term in the request

2820
00:56:35,320 --> 00:56:35,330
current term to that term in the request
 

2821
00:56:35,330 --> 00:56:37,390
current term to that term in the request
for RPC message to term 2 and also

2822
00:56:37,390 --> 00:56:37,400
for RPC message to term 2 and also
 

2823
00:56:37,400 --> 00:56:39,370
for RPC message to term 2 and also
revert itself to a follower instead of a

2824
00:56:39,370 --> 00:56:39,380
revert itself to a follower instead of a
 

2825
00:56:39,380 --> 00:56:43,090
revert itself to a follower instead of a
candidate alright finally so the real

2826
00:56:43,090 --> 00:56:43,100
candidate alright finally so the real
 

2827
00:56:43,100 --> 00:56:44,530
candidate alright finally so the real
problem is that on this line where

2828
00:56:44,530 --> 00:56:44,540
problem is that on this line where
 

2829
00:56:44,540 --> 00:56:47,440
problem is that on this line where
server 0 although it really got enough

2830
00:56:47,440 --> 00:56:47,450
server 0 although it really got enough
 

2831
00:56:47,450 --> 00:56:49,330
server 0 although it really got enough
votes on term 1 it made itself a leader

2832
00:56:49,330 --> 00:56:49,340
votes on term 1 it made itself a leader
 

2833
00:56:49,340 --> 00:56:53,230
votes on term 1 it made itself a leader
on term - so the reason so one

2834
00:56:53,230 --> 00:56:53,240
on term - so the reason so one
 

2835
00:56:53,240 --> 00:56:55,240
on term - so the reason so one
explanation for why this is happening is

2836
00:56:55,240 --> 00:56:55,250
explanation for why this is happening is
 

2837
00:56:55,250 --> 00:56:57,820
explanation for why this is happening is
because in between where we set up the

2838
00:56:57,820 --> 00:56:57,830
because in between where we set up the
 

2839
00:56:57,830 --> 00:57:00,010
because in between where we set up the
election our attempt for the election

2840
00:57:00,010 --> 00:57:00,020
election our attempt for the election
 

2841
00:57:00,020 --> 00:57:02,940
election our attempt for the election
and where we actually process the votes

2842
00:57:02,940 --> 00:57:02,950
and where we actually process the votes
 

2843
00:57:02,950 --> 00:57:05,500
and where we actually process the votes
some other things are happening input in

2844
00:57:05,500 --> 00:57:05,510
some other things are happening input in
 

2845
00:57:05,510 --> 00:57:07,210
some other things are happening input in
this case we're actually voting for

2846
00:57:07,210 --> 00:57:07,220
this case we're actually voting for
 

2847
00:57:07,220 --> 00:57:10,990
this case we're actually voting for
someone else in between and so we're no

2848
00:57:10,990 --> 00:57:11,000
someone else in between and so we're no
 

2849
00:57:11,000 --> 00:57:12,670
someone else in between and so we're no
longer on term 1 where we thought we

2850
00:57:12,670 --> 00:57:12,680
longer on term 1 where we thought we
 

2851
00:57:12,680 --> 00:57:14,620
longer on term 1 where we thought we
started the election we're now on term 2

2852
00:57:14,620 --> 00:57:14,630
started the election we're now on term 2
 

2853
00:57:14,630 --> 00:57:17,340
started the election we're now on term 2
and so we just need a double check that

2854
00:57:17,340 --> 00:57:17,350
and so we just need a double check that
 

2855
00:57:17,350 --> 00:57:19,600
and so we just need a double check that
because we don't have the lock while

2856
00:57:19,600 --> 00:57:19,610
because we don't have the lock while
 

2857
00:57:19,610 --> 00:57:21,340
because we don't have the lock while
we're performing the RPC calls which is

2858
00:57:21,340 --> 00:57:21,350
we're performing the RPC calls which is
 

2859
00:57:21,350 --> 00:57:23,290
we're performing the RPC calls which is
important for its own reasons now some

2860
00:57:23,290 --> 00:57:23,300
important for its own reasons now some
 

2861
00:57:23,300 --> 00:57:24,730
important for its own reasons now some
things might have changed and we need to

2862
00:57:24,730 --> 00:57:24,740
things might have changed and we need to
 

2863
00:57:24,740 --> 00:57:26,820
things might have changed and we need to
double check that what we assume is true

2864
00:57:26,820 --> 00:57:26,830
double check that what we assume is true
 

2865
00:57:26,830 --> 00:57:28,870
double check that what we assume is true
when we're setting ourselves to the

2866
00:57:28,870 --> 00:57:28,880
when we're setting ourselves to the
 

2867
00:57:28,880 --> 00:57:32,380
when we're setting ourselves to the
leader is still true so one way to solve

2868
00:57:32,380 --> 00:57:32,390
leader is still true so one way to solve
 

2869
00:57:32,390 --> 00:57:34,000
leader is still true so one way to solve
this that there's a few different ways

2870
00:57:34,000 --> 00:57:34,010
this that there's a few different ways
 

2871
00:57:34,010 --> 00:57:35,200
this that there's a few different ways
like to solve this like you could

2872
00:57:35,200 --> 00:57:35,210
like to solve this like you could
 

2873
00:57:35,210 --> 00:57:36,820
like to solve this like you could
imagine not voting for others while

2874
00:57:36,820 --> 00:57:36,830
imagine not voting for others while
 

2875
00:57:36,830 --> 00:57:38,140
imagine not voting for others while
we're in the middle of attempting an

2876
00:57:38,140 --> 00:57:38,150
we're in the middle of attempting an
 

2877
00:57:38,150 --> 00:57:39,940
we're in the middle of attempting an
election but in this case the simplest

2878
00:57:39,940 --> 00:57:39,950
election but in this case the simplest
 

2879
00:57:39,950 --> 00:57:42,970
election but in this case the simplest
way to solve this at least in this

2880
00:57:42,970 --> 00:57:42,980
way to solve this at least in this
 

2881
00:57:42,980 --> 00:57:45,160
way to solve this at least in this
implementation is to just double check

2882
00:57:45,160 --> 00:57:45,170
implementation is to just double check
 

2883
00:57:45,170 --> 00:57:46,720
implementation is to just double check
that we're still on the same term and

2884
00:57:46,720 --> 00:57:46,730
that we're still on the same term and
 

2885
00:57:46,730 --> 00:57:48,010
that we're still on the same term and
we're still a candidate we haven't

2886
00:57:48,010 --> 00:57:48,020
we're still a candidate we haven't
 

2887
00:57:48,020 --> 00:57:50,290
we're still a candidate we haven't
reverted to a follower so actually one

2888
00:57:50,290 --> 00:57:50,300
reverted to a follower so actually one
 

2889
00:57:50,300 --> 00:57:52,240
reverted to a follower so actually one
thing I want to show you is if we do

2890
00:57:52,240 --> 00:57:52,250
thing I want to show you is if we do
 

2891
00:57:52,250 --> 00:57:57,940
thing I want to show you is if we do
print out our state over here then we do

2892
00:57:57,940 --> 00:57:57,950
print out our state over here then we do
 

2893
00:57:57,950 --> 00:58:00,520
print out our state over here then we do
see that server 0 became a follower but

2894
00:58:00,520 --> 00:58:00,530
see that server 0 became a follower but
 

2895
00:58:00,530 --> 00:58:02,320
see that server 0 became a follower but
it's still setting itself to a leader on

2896
00:58:02,320 --> 00:58:02,330
it's still setting itself to a leader on
 

2897
00:58:02,330 --> 00:58:04,240
it's still setting itself to a leader on
this line

2898
00:58:04,240 --> 00:58:04,250
this line
 

2899
00:58:04,250 --> 00:58:07,030
this line
so yeah we can just check for that if

2900
00:58:07,030 --> 00:58:07,040
so yeah we can just check for that if
 

2901
00:58:07,040 --> 00:58:10,630
so yeah we can just check for that if
we're not a candidate or the current

2902
00:58:10,630 --> 00:58:10,640
we're not a candidate or the current
 

2903
00:58:10,640 --> 00:58:12,460
we're not a candidate or the current
term doesn't match the term which we

2904
00:58:12,460 --> 00:58:12,470
term doesn't match the term which we
 

2905
00:58:12,470 --> 00:58:14,650
term doesn't match the term which we
started the election then let's just

2906
00:58:14,650 --> 00:58:14,660
started the election then let's just
 

2907
00:58:14,660 --> 00:58:18,490
started the election then let's just
quit and if we do that then

2908
00:58:18,490 --> 00:58:18,500
quit and if we do that then
 

2909
00:58:18,500 --> 00:58:20,590
quit and if we do that then
so everyone becomes a leader and we

2910
00:58:20,590 --> 00:58:20,600
so everyone becomes a leader and we
 

2911
00:58:20,600 --> 00:58:22,030
so everyone becomes a leader and we
never cease over zero become leader so

2912
00:58:22,030 --> 00:58:22,040
never cease over zero become leader so
 

2913
00:58:22,040 --> 00:58:28,620
never cease over zero become leader so
the problem solved any question yeah

2914
00:58:28,620 --> 00:58:28,630

 

2915
00:58:28,630 --> 00:58:30,820

yeah I think I think that would I

2916
00:58:30,820 --> 00:58:30,830
yeah I think I think that would I
 

2917
00:58:30,830 --> 00:58:35,230
yeah I think I think that would I
because we would not if the term is

2918
00:58:35,230 --> 00:58:35,240
because we would not if the term is
 

2919
00:58:35,240 --> 00:58:38,980
because we would not if the term is
higher now than actually no it would it

2920
00:58:38,980 --> 00:58:38,990
higher now than actually no it would it
 

2921
00:58:38,990 --> 00:58:40,300
higher now than actually no it would it
might not be sufficient because we might

2922
00:58:40,300 --> 00:58:40,310
might not be sufficient because we might
 

2923
00:58:40,310 --> 00:58:42,790
might not be sufficient because we might
have attempted another election it

2924
00:58:42,790 --> 00:58:42,800
have attempted another election it
 

2925
00:58:42,800 --> 00:58:44,770
have attempted another election it
depends on your implementation but it's

2926
00:58:44,770 --> 00:58:44,780
depends on your implementation but it's
 

2927
00:58:44,780 --> 00:58:47,440
depends on your implementation but it's
possible that you could have attempted

2928
00:58:47,440 --> 00:58:47,450
possible that you could have attempted
 

2929
00:58:47,450 --> 00:58:49,620
possible that you could have attempted
another election on a higher term

2930
00:58:49,620 --> 00:58:49,630
another election on a higher term
 

2931
00:58:49,630 --> 00:58:51,550
another election on a higher term
afterwards all we know that's the same

2932
00:58:51,550 --> 00:58:51,560
afterwards all we know that's the same
 

2933
00:58:51,560 --> 00:58:52,900
afterwards all we know that's the same
thing right yeah it would not be

2934
00:58:52,900 --> 00:58:52,910
thing right yeah it would not be
 

2935
00:58:52,910 --> 00:58:54,670
thing right yeah it would not be
sufficient to only check the state but I

2936
00:58:54,670 --> 00:58:54,680
sufficient to only check the state but I
 

2937
00:58:54,680 --> 00:58:56,560
sufficient to only check the state but I
think you're right if you only check the

2938
00:58:56,560 --> 00:58:56,570
think you're right if you only check the
 

2939
00:58:56,570 --> 00:59:01,150
think you're right if you only check the
term then it is sufficient all right any

2940
00:59:01,150 --> 00:59:01,160
term then it is sufficient all right any
 

2941
00:59:01,160 --> 00:59:09,880
term then it is sufficient all right any
other questions all right so yeah that's

2942
00:59:09,880 --> 00:59:09,890
other questions all right so yeah that's
 

2943
00:59:09,890 --> 00:59:11,590
other questions all right so yeah that's
it for this part she's going to show you

2944
00:59:11,590 --> 00:59:11,600
it for this part she's going to show you
 

2945
00:59:11,600 --> 00:59:14,200
it for this part she's going to show you
some more examples of actually debugging

2946
00:59:14,200 --> 00:59:14,210
some more examples of actually debugging
 

2947
00:59:14,210 --> 00:59:34,029
some more examples of actually debugging
some of these draft implementations

2948
00:59:34,029 --> 00:59:34,039

 

2949
00:59:34,039 --> 00:59:52,860

hi can you all hear me yeah

2950
00:59:52,860 --> 00:59:52,870

 

2951
00:59:52,870 --> 01:00:06,790

is it not

2952
01:00:06,790 --> 01:00:06,800

 

2953
01:00:06,800 --> 01:00:14,930

okay so in my section I'm gonna walk you

2954
01:00:14,930 --> 01:00:14,940
okay so in my section I'm gonna walk you
 

2955
01:00:14,940 --> 01:00:17,750
okay so in my section I'm gonna walk you
through how I would be but if you have

2956
01:00:17,750 --> 01:00:17,760
through how I would be but if you have
 

2957
01:00:17,760 --> 01:00:20,300
through how I would be but if you have
like a bug in your rough implementation

2958
01:00:20,300 --> 01:00:20,310
like a bug in your rough implementation
 

2959
01:00:20,310 --> 01:00:24,140
like a bug in your rough implementation
so I prepare a couple of baccara good

2960
01:00:24,140 --> 01:00:24,150
so I prepare a couple of baccara good
 

2961
01:00:24,150 --> 01:00:30,020
so I prepare a couple of baccara good
and I just try to walk you through it so

2962
01:00:30,020 --> 01:00:30,030
and I just try to walk you through it so
 

2963
01:00:30,030 --> 01:00:33,040
and I just try to walk you through it so
first I'm gonna go into my face

2964
01:00:33,040 --> 01:00:33,050
first I'm gonna go into my face
 

2965
01:00:33,050 --> 01:00:41,000
first I'm gonna go into my face
Bucky implementation and if I run the

2966
01:00:41,000 --> 01:00:41,010
Bucky implementation and if I run the
 

2967
01:00:41,010 --> 01:00:52,340
Bucky implementation and if I run the
test here so for this one it doesn't

2968
01:00:52,340 --> 01:00:52,350
test here so for this one it doesn't
 

2969
01:00:52,350 --> 01:00:55,250
test here so for this one it doesn't
print anything it just gets started and

2970
01:00:55,250 --> 01:00:55,260
print anything it just gets started and
 

2971
01:00:55,260 --> 01:01:00,380
print anything it just gets started and
it's gonna be here forever and let's

2972
01:01:00,380 --> 01:01:00,390
it's gonna be here forever and let's
 

2973
01:01:00,390 --> 01:01:02,390
it's gonna be here forever and let's
assume that I have no idea why there's

2974
01:01:02,390 --> 01:01:02,400
assume that I have no idea why there's
 

2975
01:01:02,400 --> 01:01:03,110
assume that I have no idea why there's
happening

2976
01:01:03,110 --> 01:01:03,120
happening
 

2977
01:01:03,120 --> 01:01:07,280
happening
the first thing that I want to find out

2978
01:01:07,280 --> 01:01:07,290
the first thing that I want to find out
 

2979
01:01:07,290 --> 01:01:13,130
the first thing that I want to find out
is where it gets started and we we do

2980
01:01:13,130 --> 01:01:13,140
is where it gets started and we we do
 

2981
01:01:13,140 --> 01:01:16,900
is where it gets started and we we do
have a good tool for that which printf

2982
01:01:16,900 --> 01:01:16,910
have a good tool for that which printf
 

2983
01:01:16,910 --> 01:01:21,320
have a good tool for that which printf
but in the stop code if you go to

2984
01:01:21,320 --> 01:01:21,330
but in the stop code if you go to
 

2985
01:01:21,330 --> 01:01:25,280
but in the stop code if you go to
youtube go we have a function called the

2986
01:01:25,280 --> 01:01:25,290
youtube go we have a function called the
 

2987
01:01:25,290 --> 01:01:28,460
youtube go we have a function called the
printf this is just a nice wrapper

2988
01:01:28,460 --> 01:01:28,470
printf this is just a nice wrapper
 

2989
01:01:28,470 --> 01:01:32,950
printf this is just a nice wrapper
around the block cleaners with the

2990
01:01:32,950 --> 01:01:32,960
around the block cleaners with the
 

2991
01:01:32,960 --> 01:01:36,590
around the block cleaners with the
debugger able to enable or disable the

2992
01:01:36,590 --> 01:01:36,600
debugger able to enable or disable the
 

2993
01:01:36,600 --> 01:01:40,280
debugger able to enable or disable the
locking messages so I'm gonna enable

2994
01:01:40,280 --> 01:01:40,290
locking messages so I'm gonna enable
 

2995
01:01:40,290 --> 01:01:46,970
locking messages so I'm gonna enable
that and go back to my graph okay so

2996
01:01:46,970 --> 01:01:46,980
that and go back to my graph okay so
 

2997
01:01:46,980 --> 01:01:50,420
that and go back to my graph okay so
first of all when i when when there

2998
01:01:50,420 --> 01:01:50,430
first of all when i when when there
 

2999
01:01:50,430 --> 01:01:54,790
first of all when i when when there
there's something that's but happening I

3000
01:01:54,790 --> 01:01:54,800
there's something that's but happening I
 

3001
01:01:54,800 --> 01:02:02,530
there's something that's but happening I
always go check if the code actually

3002
01:02:02,530 --> 01:02:02,540
always go check if the code actually
 

3003
01:02:02,540 --> 01:02:08,210
always go check if the code actually
actually initialize graph server so here

3004
01:02:08,210 --> 01:02:08,220
actually initialize graph server so here
 

3005
01:02:08,220 --> 01:02:20,720
actually initialize graph server so here
I'll just clean

3006
01:02:20,720 --> 01:02:20,730

 

3007
01:02:20,730 --> 01:02:27,630

okay so here if I run the test again

3008
01:02:27,630 --> 01:02:27,640
okay so here if I run the test again
 

3009
01:02:27,640 --> 01:02:31,410
okay so here if I run the test again
then now I know that there are three

3010
01:02:31,410 --> 01:02:31,420
then now I know that there are three
 

3011
01:02:31,420 --> 01:02:36,930
then now I know that there are three
servers that God he initialized so this

3012
01:02:36,930 --> 01:02:36,940
servers that God he initialized so this
 

3013
01:02:36,940 --> 01:02:43,170
servers that God he initialized so this
files is okay but like there's nowhere

3014
01:02:43,170 --> 01:02:43,180
files is okay but like there's nowhere
 

3015
01:02:43,180 --> 01:02:45,720
files is okay but like there's nowhere
where the bow is happening so I'll just

3016
01:02:45,720 --> 01:02:45,730
where the bow is happening so I'll just
 

3017
01:02:45,730 --> 01:02:48,569
where the bow is happening so I'll just
go deeper into the hood just to find

3018
01:02:48,569 --> 01:02:48,579
go deeper into the hood just to find
 

3019
01:02:48,579 --> 01:02:50,730
go deeper into the hood just to find
where it gets stuck so now if you see

3020
01:02:50,730 --> 01:02:50,740
where it gets stuck so now if you see
 

3021
01:02:50,740 --> 01:02:55,680
where it gets stuck so now if you see
the code we are calling the leader a

3022
01:02:55,680 --> 01:02:55,690
the code we are calling the leader a
 

3023
01:02:55,690 --> 01:02:58,829
the code we are calling the leader a
tech election so I'm gonna go to that

3024
01:02:58,829 --> 01:02:58,839
tech election so I'm gonna go to that
 

3025
01:02:58,839 --> 01:03:06,089
tech election so I'm gonna go to that
function and just to make faster I'll

3026
01:03:06,089 --> 01:03:06,099
function and just to make faster I'll
 

3027
01:03:06,099 --> 01:03:08,309
function and just to make faster I'll
try to check if it kicks off some

3028
01:03:08,309 --> 01:03:08,319
try to check if it kicks off some
 

3029
01:03:08,319 --> 01:03:21,760
try to check if it kicks off some
iteration

3030
01:03:21,760 --> 01:03:21,770

 

3031
01:03:21,770 --> 01:03:25,630

that part still fine so we we try to go

3032
01:03:25,630 --> 01:03:25,640
that part still fine so we we try to go
 

3033
01:03:25,640 --> 01:03:31,330
that part still fine so we we try to go
for now here we are in the election I'll

3034
01:03:31,330 --> 01:03:31,340
for now here we are in the election I'll
 

3035
01:03:31,340 --> 01:03:37,180
for now here we are in the election I'll
see if there's so we actually send the

3036
01:03:37,180 --> 01:03:37,190
see if there's so we actually send the
 

3037
01:03:37,190 --> 01:04:00,310
see if there's so we actually send the
request voice to some other servers

3038
01:04:00,310 --> 01:04:00,320

 

3039
01:04:00,320 --> 01:04:02,740

now we kind of have like more idea of

3040
01:04:02,740 --> 01:04:02,750
now we kind of have like more idea of
 

3041
01:04:02,750 --> 01:04:04,660
now we kind of have like more idea of
where guests are because it's not

3042
01:04:04,660 --> 01:04:04,670
where guests are because it's not
 

3043
01:04:04,670 --> 01:04:08,500
where guests are because it's not
printing that some sorry that kicks off

3044
01:04:08,500 --> 01:04:08,510
printing that some sorry that kicks off
 

3045
01:04:08,510 --> 01:04:11,350
printing that some sorry that kicks off
the election are not sending the request

3046
01:04:11,350 --> 01:04:11,360
the election are not sending the request
 

3047
01:04:11,360 --> 01:04:17,410
the election are not sending the request
words so I would go back for her just to

3048
01:04:17,410 --> 01:04:17,420
words so I would go back for her just to
 

3049
01:04:17,420 --> 01:04:21,490
words so I would go back for her just to
see where customers like I always tried

3050
01:04:21,490 --> 01:04:21,500
see where customers like I always tried
 

3051
01:04:21,500 --> 01:04:27,360
see where customers like I always tried
here prin if if we call some function

3052
01:04:27,360 --> 01:04:27,370
here prin if if we call some function
 

3053
01:04:27,370 --> 01:04:29,260
here prin if if we call some function
aye-aye

3054
01:04:29,260 --> 01:04:29,270
aye-aye
 

3055
01:04:29,270 --> 01:04:31,960
aye-aye
I was always double shake if it actually

3056
01:04:31,960 --> 01:04:31,970
I was always double shake if it actually
 

3057
01:04:31,970 --> 01:04:37,650
I was always double shake if it actually
go into the function so now I'm going to

3058
01:04:37,650 --> 01:04:37,660
go into the function so now I'm going to
 

3059
01:04:37,660 --> 01:04:42,490
go into the function so now I'm going to
say that this service is at the start of

3060
01:04:42,490 --> 01:04:42,500
say that this service is at the start of
 

3061
01:04:42,500 --> 01:04:50,190
say that this service is at the start of
the election

3062
01:04:50,190 --> 01:04:50,200

 

3063
01:04:50,200 --> 01:04:56,799

and that works so now we have an idea of

3064
01:04:56,799 --> 01:04:56,809
and that works so now we have an idea of
 

3065
01:04:56,809 --> 01:05:02,819
and that works so now we have an idea of
like the box should be between here and

3066
01:05:02,819 --> 01:05:02,829
like the box should be between here and
 

3067
01:05:02,829 --> 01:05:06,660
like the box should be between here and
here so we are trying to minimize the

3068
01:05:06,660 --> 01:05:06,670
here so we are trying to minimize the
 

3069
01:05:06,670 --> 01:05:14,400
here so we are trying to minimize the
scope of the code that's causing the bug

3070
01:05:14,400 --> 01:05:14,410

 

3071
01:05:14,410 --> 01:05:28,290

let's say if I pin something here

3072
01:05:28,290 --> 01:05:28,300

 

3073
01:05:28,300 --> 01:05:33,950

and it does it doesn't get there so I

3074
01:05:33,950 --> 01:05:33,960
and it does it doesn't get there so I
 

3075
01:05:33,960 --> 01:05:41,370
and it does it doesn't get there so I
move it up let's say here still not

3076
01:05:41,370 --> 01:05:41,380
move it up let's say here still not
 

3077
01:05:41,380 --> 01:05:48,530
move it up let's say here still not
there

3078
01:05:48,530 --> 01:05:48,540

 

3079
01:05:48,540 --> 01:05:55,460

now it's there so the bug is probably in

3080
01:05:55,460 --> 01:05:55,470
now it's there so the bug is probably in
 

3081
01:05:55,470 --> 01:06:02,080
now it's there so the bug is probably in
this function and I just go check so

3082
01:06:02,080 --> 01:06:02,090
this function and I just go check so
 

3083
01:06:02,090 --> 01:06:05,390
this function and I just go check so
here the problem is that I'm trying to

3084
01:06:05,390 --> 01:06:05,400
here the problem is that I'm trying to
 

3085
01:06:05,400 --> 01:06:08,590
here the problem is that I'm trying to
acquire a lock where I actually do have

3086
01:06:08,590 --> 01:06:08,600
acquire a lock where I actually do have
 

3087
01:06:08,600 --> 01:06:13,610
acquire a lock where I actually do have
the lock so it's gonna be a day long so

3088
01:06:13,610 --> 01:06:13,620
the lock so it's gonna be a day long so
 

3089
01:06:13,620 --> 01:06:16,450
the lock so it's gonna be a day long so
that's how I will find their first bug

3090
01:06:16,450 --> 01:06:16,460
that's how I will find their first bug
 

3091
01:06:16,460 --> 01:06:22,900
that's how I will find their first bug
using the D printers and it's it's nice

3092
01:06:22,900 --> 01:06:22,910
using the D printers and it's it's nice
 

3093
01:06:22,910 --> 01:06:28,990
using the D printers and it's it's nice
to use the printf because you can like

3094
01:06:28,990 --> 01:06:29,000

 

3095
01:06:29,000 --> 01:06:33,680

just turn off the debugging print and

3096
01:06:33,680 --> 01:06:33,690
just turn off the debugging print and
 

3097
01:06:33,690 --> 01:06:38,960
just turn off the debugging print and
have a nice test output with our audit

3098
01:06:38,960 --> 01:06:38,970
have a nice test output with our audit
 

3099
01:06:38,970 --> 01:06:43,730
have a nice test output with our audit
debugging if you want it so that's how I

3100
01:06:43,730 --> 01:06:43,740
debugging if you want it so that's how I
 

3101
01:06:43,740 --> 01:06:47,240
debugging if you want it so that's how I
would use it deep enough to try to like

3102
01:06:47,240 --> 01:06:47,250
would use it deep enough to try to like
 

3103
01:06:47,250 --> 01:06:51,740
would use it deep enough to try to like
handle a bug in your code and for this

3104
01:06:51,740 --> 01:06:51,750
handle a bug in your code and for this
 

3105
01:06:51,750 --> 01:06:54,800
handle a bug in your code and for this
example there's actually another trick

3106
01:06:54,800 --> 01:06:54,810
example there's actually another trick
 

3107
01:06:54,810 --> 01:06:59,420
example there's actually another trick
to help you find this kind of deadlock

3108
01:06:59,420 --> 01:06:59,430
to help you find this kind of deadlock
 

3109
01:06:59,430 --> 01:07:04,700
to help you find this kind of deadlock
so if you press ctrl + backslash you can

3110
01:07:04,700 --> 01:07:04,710
so if you press ctrl + backslash you can
 

3111
01:07:04,710 --> 01:07:08,990
so if you press ctrl + backslash you can
see in the bottle but bottom left that I

3112
01:07:08,990 --> 01:07:09,000
see in the bottle but bottom left that I
 

3113
01:07:09,000 --> 01:07:13,130
see in the bottle but bottom left that I
press like control and backslash this

3114
01:07:13,130 --> 01:07:13,140
press like control and backslash this
 

3115
01:07:13,140 --> 01:07:16,730
press like control and backslash this
this command will send a signal quit

3116
01:07:16,730 --> 01:07:16,740
this command will send a signal quit
 

3117
01:07:16,740 --> 01:07:17,620
this command will send a signal quit
today

3118
01:07:17,620 --> 01:07:17,630
today
 

3119
01:07:17,630 --> 01:07:21,980
today
go program and by default it will

3120
01:07:21,980 --> 01:07:21,990
go program and by default it will
 

3121
01:07:21,990 --> 01:07:26,360
go program and by default it will
handles the the quiz signal and quit all

3122
01:07:26,360 --> 01:07:26,370
handles the the quiz signal and quit all
 

3123
01:07:26,370 --> 01:07:29,120
handles the the quiz signal and quit all
the go routines and print audio strike

3124
01:07:29,120 --> 01:07:29,130
the go routines and print audio strike
 

3125
01:07:29,130 --> 01:07:41,360
the go routines and print audio strike
the stack rates so now this like Chico

3126
01:07:41,360 --> 01:07:41,370
the stack rates so now this like Chico
 

3127
01:07:41,370 --> 01:07:43,640
the stack rates so now this like Chico
up here like this way it gets touched

3128
01:07:43,640 --> 01:07:43,650
up here like this way it gets touched
 

3129
01:07:43,650 --> 01:07:47,510
up here like this way it gets touched
and then there are gonna be a couple

3130
01:07:47,510 --> 01:07:47,520
and then there are gonna be a couple
 

3131
01:07:47,520 --> 01:07:55,770
and then there are gonna be a couple
functions printing here

3132
01:07:55,770 --> 01:07:55,780

 

3133
01:07:55,780 --> 01:08:07,470

just trying to go through all the traces

3134
01:08:07,470 --> 01:08:07,480

 

3135
01:08:07,480 --> 01:08:11,190

yes so it's actually showing that the

3136
01:08:11,190 --> 01:08:11,200
yes so it's actually showing that the
 

3137
01:08:11,200 --> 01:08:14,070
yes so it's actually showing that the
function that's causing the problem is

3138
01:08:14,070 --> 01:08:14,080
function that's causing the problem is
 

3139
01:08:14,080 --> 01:08:17,760
function that's causing the problem is
the cover to candidate so that's another

3140
01:08:17,760 --> 01:08:17,770
the cover to candidate so that's another
 

3141
01:08:17,770 --> 01:08:20,430
the cover to candidate so that's another
weight you've to find out where the day

3142
01:08:20,430 --> 01:08:20,440
weight you've to find out where the day
 

3143
01:08:20,440 --> 01:08:43,099
weight you've to find out where the day
locks are I can remove all this

3144
01:08:43,099 --> 01:08:43,109

 

3145
01:08:43,109 --> 01:08:47,030

and now it works so that's the first

3146
01:08:47,030 --> 01:08:47,040
and now it works so that's the first
 

3147
01:08:47,040 --> 01:08:51,559
and now it works so that's the first
example that I want to go through second

3148
01:08:51,559 --> 01:08:51,569
example that I want to go through second
 

3149
01:08:51,569 --> 01:08:54,079
example that I want to go through second
thing that you want it you want to do

3150
01:08:54,079 --> 01:08:54,089
thing that you want it you want to do
 

3151
01:08:54,089 --> 01:08:56,990
thing that you want it you want to do
before you submit your labs is to turn

3152
01:08:56,990 --> 01:08:57,000
before you submit your labs is to turn
 

3153
01:08:57,000 --> 01:08:58,459
before you submit your labs is to turn
the race

3154
01:08:58,459 --> 01:08:58,469
the race
 

3155
01:08:58,469 --> 01:09:03,260
the race
flag on when you do the test the way to

3156
01:09:03,260 --> 01:09:03,270
flag on when you do the test the way to
 

3157
01:09:03,270 --> 01:09:07,070
flag on when you do the test the way to
do that is just to add - race before

3158
01:09:07,070 --> 01:09:07,080
do that is just to add - race before
 

3159
01:09:07,080 --> 01:09:18,129
do that is just to add - race before
- groin and here because my implement

3160
01:09:18,129 --> 01:09:18,139
- groin and here because my implement
 

3161
01:09:18,139 --> 01:09:20,390
- groin and here because my implement
implementation doesn't have any research

3162
01:09:20,390 --> 01:09:20,400
implementation doesn't have any research
 

3163
01:09:20,400 --> 01:09:22,519
implementation doesn't have any research
so it's not going to tell you anything

3164
01:09:22,519 --> 01:09:22,529
so it's not going to tell you anything
 

3165
01:09:22,529 --> 01:09:25,280
so it's not going to tell you anything
but this just be careful about this

3166
01:09:25,280 --> 01:09:25,290
but this just be careful about this
 

3167
01:09:25,290 --> 01:09:29,599
but this just be careful about this
because it's not a proof that you don't

3168
01:09:29,599 --> 01:09:29,609
because it's not a proof that you don't
 

3169
01:09:29,609 --> 01:09:33,439
because it's not a proof that you don't
have any really it's just that it cannot

3170
01:09:33,439 --> 01:09:33,449
have any really it's just that it cannot
 

3171
01:09:33,449 --> 01:09:42,680
have any really it's just that it cannot
detect races for you I'm going to run

3172
01:09:42,680 --> 01:09:42,690
detect races for you I'm going to run
 

3173
01:09:42,690 --> 01:09:45,559
detect races for you I'm going to run
the same command again with the red flag

3174
01:09:45,559 --> 01:09:45,569
the same command again with the red flag
 

3175
01:09:45,569 --> 01:09:47,990
the same command again with the red flag
but now this time that's actually risk

3176
01:09:47,990 --> 01:09:48,000
but now this time that's actually risk
 

3177
01:09:48,000 --> 01:09:56,810
but now this time that's actually risk
going on in my implementation so it's

3178
01:09:56,810 --> 01:09:56,820
going on in my implementation so it's
 

3179
01:09:56,820 --> 01:10:00,379
going on in my implementation so it's
gonna yell at you that there's some

3180
01:10:00,379 --> 01:10:00,389
gonna yell at you that there's some
 

3181
01:10:00,389 --> 01:10:07,990
gonna yell at you that there's some
deliveries going on in your code

3182
01:10:07,990 --> 01:10:08,000

 

3183
01:10:08,000 --> 01:10:13,820

I'm quitting that and let's see like how

3184
01:10:13,820 --> 01:10:13,830
I'm quitting that and let's see like how
 

3185
01:10:13,830 --> 01:10:20,120
I'm quitting that and let's see like how
useful is the warning are so I'm gonna

3186
01:10:20,120 --> 01:10:20,130
useful is the warning are so I'm gonna
 

3187
01:10:20,130 --> 01:10:27,820
useful is the warning are so I'm gonna
go to my second implementation with

3188
01:10:27,820 --> 01:10:27,830

 

3189
01:10:27,830 --> 01:10:37,020

Rothko and here

3190
01:10:37,020 --> 01:10:37,030

 

3191
01:10:37,030 --> 01:10:45,400

let's look at this race so it's telling

3192
01:10:45,400 --> 01:10:45,410
let's look at this race so it's telling
 

3193
01:10:45,410 --> 01:10:48,010
let's look at this race so it's telling
us that there's a wheat going on at the

3194
01:10:48,010 --> 01:10:48,020
us that there's a wheat going on at the
 

3195
01:10:48,020 --> 01:10:49,800
us that there's a wheat going on at the
line

3196
01:10:49,800 --> 01:10:49,810
line
 

3197
01:10:49,810 --> 01:10:54,670
line
103 I'm going to that line so this the

3198
01:10:54,670 --> 01:10:54,680
103 I'm going to that line so this the
 

3199
01:10:54,680 --> 01:11:08,010
103 I'm going to that line so this the
wheat on probably Thursday here and

3200
01:11:08,010 --> 01:11:08,020
wheat on probably Thursday here and
 

3201
01:11:08,020 --> 01:11:20,320
wheat on probably Thursday here and
there's also a right line for 12 which

3202
01:11:20,320 --> 01:11:20,330
there's also a right line for 12 which
 

3203
01:11:20,330 --> 01:11:38,300
there's also a right line for 12 which
is Thursday so

3204
01:11:38,300 --> 01:11:38,310

 

3205
01:11:38,310 --> 01:11:45,490

I'm going to this line again

3206
01:11:45,490 --> 01:11:45,500
I'm going to this line again
 

3207
01:11:45,500 --> 01:11:48,890
I'm going to this line again
and now we kind of know that this this

3208
01:11:48,890 --> 01:11:48,900
and now we kind of know that this this
 

3209
01:11:48,900 --> 01:11:53,270
and now we kind of know that this this
radiation is protected by a lock so the

3210
01:11:53,270 --> 01:11:53,280
radiation is protected by a lock so the
 

3211
01:11:53,280 --> 01:11:56,210
radiation is protected by a lock so the
risk flies actually wanting us and

3212
01:11:56,210 --> 01:11:56,220
risk flies actually wanting us and
 

3213
01:11:56,220 --> 01:12:00,890
risk flies actually wanting us and
helping us to find out but on on this

3214
01:12:00,890 --> 01:12:00,900
helping us to find out but on on this
 

3215
01:12:00,900 --> 01:12:05,090
helping us to find out but on on this
database that we have so the fake it's

3216
01:12:05,090 --> 01:12:05,100
database that we have so the fake it's
 

3217
01:12:05,100 --> 01:12:15,230
database that we have so the fake it's
gonna be just you lock this and unlock

3218
01:12:15,230 --> 01:12:15,240
gonna be just you lock this and unlock
 

3219
01:12:15,240 --> 01:12:28,040
gonna be just you lock this and unlock
it and that should solve the problem

3220
01:12:28,040 --> 01:12:28,050

 

3221
01:12:28,050 --> 01:12:31,730

so at this place we kind of know how to

3222
01:12:31,730 --> 01:12:31,740
so at this place we kind of know how to
 

3223
01:12:31,740 --> 01:12:35,210
so at this place we kind of know how to
basic like do some basic debugging does

3224
01:12:35,210 --> 01:12:35,220
basic like do some basic debugging does
 

3225
01:12:35,220 --> 01:12:42,640
basic like do some basic debugging does
anyone have any question no okay yeah so

3226
01:12:42,640 --> 01:12:42,650
anyone have any question no okay yeah so
 

3227
01:12:42,650 --> 01:12:46,040
anyone have any question no okay yeah so
I'm going to go to the third one which

3228
01:12:46,040 --> 01:12:46,050
I'm going to go to the third one which
 

3229
01:12:46,050 --> 01:12:50,510
I'm going to go to the third one which
is going to be more difficult to find

3230
01:12:50,510 --> 01:12:50,520
is going to be more difficult to find
 

3231
01:12:50,520 --> 01:13:01,430
is going to be more difficult to find
about I'm going to test the run the

3232
01:13:01,430 --> 01:13:01,440
about I'm going to test the run the
 

3233
01:13:01,440 --> 01:13:04,970
about I'm going to test the run the
centers and now I am I actually have

3234
01:13:04,970 --> 01:13:04,980
centers and now I am I actually have
 

3235
01:13:04,980 --> 01:13:10,160
centers and now I am I actually have
some debugging messages in there already

3236
01:13:10,160 --> 01:13:10,170
some debugging messages in there already
 

3237
01:13:10,170 --> 01:13:17,600
some debugging messages in there already
and just see that I also have a

3238
01:13:17,600 --> 01:13:17,610
and just see that I also have a
 

3239
01:13:17,610 --> 01:13:20,090
and just see that I also have a
debugging message with the test action

3240
01:13:20,090 --> 01:13:20,100
debugging message with the test action
 

3241
01:13:20,100 --> 01:13:22,840
debugging message with the test action
there's something you might want to

3242
01:13:22,840 --> 01:13:22,850
there's something you might want to
 

3243
01:13:22,850 --> 01:13:34,130
there's something you might want to
consider doing if you go into the test

3244
01:13:34,130 --> 01:13:34,140
consider doing if you go into the test
 

3245
01:13:34,140 --> 01:13:42,979
consider doing if you go into the test
clip here

3246
01:13:42,979 --> 01:13:42,989

 

3247
01:13:42,989 --> 01:13:46,340

you can just see how the test would run

3248
01:13:46,340 --> 01:13:46,350
you can just see how the test would run
 

3249
01:13:46,350 --> 01:13:49,910
you can just see how the test would run
and then there are some actions that the

3250
01:13:49,910 --> 01:13:49,920
and then there are some actions that the
 

3251
01:13:49,920 --> 01:13:52,130
and then there are some actions that the
test clip is gonna do to make your code

3252
01:13:52,130 --> 01:13:52,140
test clip is gonna do to make your code
 

3253
01:13:52,140 --> 01:13:58,150
test clip is gonna do to make your code
fail and it's usually a good idea to

3254
01:13:58,150 --> 01:13:58,160
fail and it's usually a good idea to
 

3255
01:13:58,160 --> 01:14:02,410
fail and it's usually a good idea to
print out where that action is happening

3256
01:14:02,410 --> 01:14:02,420
print out where that action is happening
 

3257
01:14:02,420 --> 01:14:07,400
print out where that action is happening
in your actual debugging message so you

3258
01:14:07,400 --> 01:14:07,410
in your actual debugging message so you
 

3259
01:14:07,410 --> 01:14:13,400
in your actual debugging message so you
can guess what is happening like where

3260
01:14:13,400 --> 01:14:13,410
can guess what is happening like where
 

3261
01:14:13,410 --> 01:14:18,200
can guess what is happening like where
the bug is happening in which phase of

3262
01:14:18,200 --> 01:14:18,210
the bug is happening in which phase of
 

3263
01:14:18,210 --> 01:14:22,100
the bug is happening in which phase of
the test if that make sense so now it's

3264
01:14:22,100 --> 01:14:22,110
the test if that make sense so now it's
 

3265
01:14:22,110 --> 01:14:27,320
the test if that make sense so now it's
like I was doing fine in the first case

3266
01:14:27,320 --> 01:14:27,330
like I was doing fine in the first case
 

3267
01:14:27,330 --> 01:14:30,709
like I was doing fine in the first case
I passed I passed the fail but I'm

3268
01:14:30,709 --> 01:14:30,719
I passed I passed the fail but I'm
 

3269
01:14:30,719 --> 01:14:37,250
I passed I passed the fail but I'm
failing their second tiers and here the

3270
01:14:37,250 --> 01:14:37,260
failing their second tiers and here the
 

3271
01:14:37,260 --> 01:14:40,790
failing their second tiers and here the
Test section is to found one as a little

3272
01:14:40,790 --> 01:14:40,800
Test section is to found one as a little
 

3273
01:14:40,800 --> 01:14:46,940
Test section is to found one as a little
one so I'm passing this the test until

3274
01:14:46,940 --> 01:14:46,950
one so I'm passing this the test until
 

3275
01:14:46,950 --> 01:14:51,520
one so I'm passing this the test until
this and if you go to I'm actually

3276
01:14:51,520 --> 01:14:51,530
this and if you go to I'm actually
 

3277
01:14:51,530 --> 01:14:57,020
this and if you go to I'm actually
passing until the leader two rejoins so

3278
01:14:57,020 --> 01:14:57,030
passing until the leader two rejoins so
 

3279
01:14:57,030 --> 01:14:59,810
passing until the leader two rejoins so
this can give you a nice idea of how the

3280
01:14:59,810 --> 01:14:59,820
this can give you a nice idea of how the
 

3281
01:14:59,820 --> 01:15:09,850
this can give you a nice idea of how the
test is working and just to help you

3282
01:15:09,850 --> 01:15:09,860
test is working and just to help you
 

3283
01:15:09,860 --> 01:15:13,820
test is working and just to help you
have a better case as where the bondage

3284
01:15:13,820 --> 01:15:13,830
have a better case as where the bondage
 

3285
01:15:13,830 --> 01:15:21,080
have a better case as where the bondage
is in your code so now let's look at the

3286
01:15:21,080 --> 01:15:21,090
is in your code so now let's look at the
 

3287
01:15:21,090 --> 01:15:32,169
is in your code so now let's look at the
debugging messages

3288
01:15:32,169 --> 01:15:32,179

 

3289
01:15:32,179 --> 01:15:35,470

so it's least it seems like when liturgy

3290
01:15:35,470 --> 01:15:35,480
so it's least it seems like when liturgy
 

3291
01:15:35,480 --> 01:15:40,479
so it's least it seems like when liturgy
we joined it becomes a follower and we

3292
01:15:40,479 --> 01:15:40,489
we joined it becomes a follower and we
 

3293
01:15:40,489 --> 01:15:41,800
we joined it becomes a follower and we
have a new leader

3294
01:15:41,800 --> 01:15:41,810
have a new leader
 

3295
01:15:41,810 --> 01:15:46,870
have a new leader
so that looks fine to me and we probably

3296
01:15:46,870 --> 01:15:46,880
so that looks fine to me and we probably
 

3297
01:15:46,880 --> 01:15:50,620
so that looks fine to me and we probably
need more debugging messages instead of

3298
01:15:50,620 --> 01:15:50,630
need more debugging messages instead of
 

3299
01:15:50,630 --> 01:16:00,910
need more debugging messages instead of
just their state changes so I am going

3300
01:16:00,910 --> 01:16:00,920
just their state changes so I am going
 

3301
01:16:00,920 --> 01:16:05,770
just their state changes so I am going
to add some more my first case that when

3302
01:16:05,770 --> 01:16:05,780
to add some more my first case that when
 

3303
01:16:05,780 --> 01:16:08,530
to add some more my first case that when
one becomes a leader it might not be

3304
01:16:08,530 --> 01:16:08,540
one becomes a leader it might not be
 

3305
01:16:08,540 --> 01:16:13,180
one becomes a leader it might not be
doing what a leader should you correctly

3306
01:16:13,180 --> 01:16:13,190
doing what a leader should you correctly
 

3307
01:16:13,190 --> 01:16:23,759
doing what a leader should you correctly
so we got stuck

3308
01:16:23,759 --> 01:16:23,769

 

3309
01:16:23,769 --> 01:16:26,359

so you might could after we cover it as

3310
01:16:26,359 --> 01:16:26,369
so you might could after we cover it as
 

3311
01:16:26,369 --> 01:16:30,000
so you might could after we cover it as
eventually there I have a go routine

3312
01:16:30,000 --> 01:16:30,010
eventually there I have a go routine
 

3313
01:16:30,010 --> 01:16:32,250
eventually there I have a go routine
call operate leader

3314
01:16:32,250 --> 01:16:32,260
call operate leader
 

3315
01:16:32,260 --> 01:16:34,979
call operate leader
there's just standing habit CD all set

3316
01:16:34,979 --> 01:16:34,989
there's just standing habit CD all set
 

3317
01:16:34,989 --> 01:16:41,430
there's just standing habit CD all set
to the audio servers so I'm gonna print

3318
01:16:41,430 --> 01:16:41,440
to the audio servers so I'm gonna print
 

3319
01:16:41,440 --> 01:16:54,209
to the audio servers so I'm gonna print
some stuff here saying happy - cheers

3320
01:16:54,209 --> 01:16:54,219
some stuff here saying happy - cheers
 

3321
01:16:54,219 --> 01:17:20,840
some stuff here saying happy - cheers
away

3322
01:17:20,840 --> 01:17:20,850

 

3323
01:17:20,850 --> 01:17:25,100

so to become solidary it sends the the

3324
01:17:25,100 --> 01:17:25,110
so to become solidary it sends the the
 

3325
01:17:25,110 --> 01:17:33,110
so to become solidary it sends the the
first happy to each server and one still

3326
01:17:33,110 --> 01:17:33,120
first happy to each server and one still
 

3327
01:17:33,120 --> 01:17:40,990
first happy to each server and one still
tries to send happy to the new leader

3328
01:17:40,990 --> 01:17:41,000

 

3329
01:17:41,000 --> 01:17:46,930

and then one becomes a follower so this

3330
01:17:46,930 --> 01:17:46,940
and then one becomes a follower so this
 

3331
01:17:46,940 --> 01:17:54,710
and then one becomes a follower so this
doesn't look like to be a problem now

3332
01:17:54,710 --> 01:17:54,720
doesn't look like to be a problem now
 

3333
01:17:54,720 --> 01:17:56,900
doesn't look like to be a problem now
I'm gonna check if the other service

3334
01:17:56,900 --> 01:17:56,910
I'm gonna check if the other service
 

3335
01:17:56,910 --> 01:19:25,649
I'm gonna check if the other service
receive habit correctly

3336
01:19:25,649 --> 01:19:25,659

 

3337
01:19:25,659 --> 01:19:29,070

it's taking away with I'm trying to

3338
01:19:29,070 --> 01:19:29,080
it's taking away with I'm trying to
 

3339
01:19:29,080 --> 01:19:37,340
it's taking away with I'm trying to
finish this yeah so to becomes a leader

3340
01:19:37,340 --> 01:19:37,350
finish this yeah so to becomes a leader
 

3341
01:19:37,350 --> 01:19:43,860
finish this yeah so to becomes a leader
to sends high bid but no one receive a

3342
01:19:43,860 --> 01:19:43,870
to sends high bid but no one receive a
 

3343
01:19:43,870 --> 01:19:54,709
to sends high bid but no one receive a
habit form - so if I go to the same

3344
01:19:54,709 --> 01:19:54,719
habit form - so if I go to the same
 

3345
01:19:54,719 --> 01:19:59,750
habit form - so if I go to the same
opinion tree I actually hold the law to

3346
01:19:59,750 --> 01:19:59,760
opinion tree I actually hold the law to
 

3347
01:19:59,760 --> 01:20:03,800
opinion tree I actually hold the law to
the RPC Hall which is the problem that

3348
01:20:03,800 --> 01:20:03,810
the RPC Hall which is the problem that
 

3349
01:20:03,810 --> 01:20:07,939
the RPC Hall which is the problem that
Fabian went to in the last section so

3350
01:20:07,939 --> 01:20:07,949
Fabian went to in the last section so
 

3351
01:20:07,949 --> 01:20:10,770
Fabian went to in the last section so
that's that's the problem that I need to

3352
01:20:10,770 --> 01:20:10,780
that's that's the problem that I need to
 

3353
01:20:10,780 --> 01:20:23,959
that's that's the problem that I need to
fix so what I should do is to a lot here

3354
01:20:23,959 --> 01:20:23,969

 

3355
01:20:23,969 --> 01:20:33,720

and then

3356
01:20:33,720 --> 01:20:33,730

 

3357
01:20:33,730 --> 01:20:47,180

lock again here and that should work

3358
01:20:47,180 --> 01:20:47,190

 

3359
01:20:47,190 --> 01:20:53,870

we pass and then there are couple things

3360
01:20:53,870 --> 01:20:53,880
we pass and then there are couple things
 

3361
01:20:53,880 --> 01:20:58,400
we pass and then there are couple things
that you might want to do when you test

3362
01:20:58,400 --> 01:20:58,410
that you might want to do when you test
 

3363
01:20:58,410 --> 01:21:03,350
that you might want to do when you test
your rough implementation so that's

3364
01:21:03,350 --> 01:21:03,360
your rough implementation so that's
 

3365
01:21:03,360 --> 01:21:09,550
your rough implementation so that's
actually script to run the test in

3366
01:21:09,550 --> 01:21:09,560
actually script to run the test in
 

3367
01:21:09,560 --> 01:21:14,000
actually script to run the test in
imperial and I can show you how I how we

3368
01:21:14,000 --> 01:21:14,010
imperial and I can show you how I how we
 

3369
01:21:14,010 --> 01:21:18,560
imperial and I can show you how I how we
can use how we can use it this creep is

3370
01:21:18,560 --> 01:21:18,570
can use how we can use it this creep is
 

3371
01:21:18,570 --> 01:21:21,350
can use how we can use it this creep is
in the inner peer support some someone

3372
01:21:21,350 --> 01:21:21,360
in the inner peer support some someone
 

3373
01:21:21,360 --> 01:21:27,170
in the inner peer support some someone
make a point about it and here's how we

3374
01:21:27,170 --> 01:21:27,180
make a point about it and here's how we
 

3375
01:21:27,180 --> 01:21:33,760
make a point about it and here's how we
can use the script so you run the script

3376
01:21:33,760 --> 01:21:33,770
can use the script so you run the script
 

3377
01:21:33,770 --> 01:21:36,370
can use the script so you run the script
specify the number of the test

3378
01:21:36,370 --> 01:21:36,380
specify the number of the test
 

3379
01:21:36,380 --> 01:21:40,220
specify the number of the test
personally I do like a 1000 but that

3380
01:21:40,220 --> 01:21:40,230
personally I do like a 1000 but that
 

3381
01:21:40,230 --> 01:21:44,180
personally I do like a 1000 but that
depends on your preference this is the

3382
01:21:44,180 --> 01:21:44,190
depends on your preference this is the
 

3383
01:21:44,190 --> 01:21:47,240
depends on your preference this is the
number of course that you wanna run the

3384
01:21:47,240 --> 01:21:47,250
number of course that you wanna run the
 

3385
01:21:47,250 --> 01:21:49,280
number of course that you wanna run the
test at the same time and then here's

3386
01:21:49,280 --> 01:21:49,290
test at the same time and then here's
 

3387
01:21:49,290 --> 01:21:59,470
test at the same time and then here's
the test and if you run the script then

3388
01:21:59,470 --> 01:21:59,480

 

3389
01:21:59,480 --> 01:22:04,610

if you show you that's like we have run

3390
01:22:04,610 --> 01:22:04,620
if you show you that's like we have run
 

3391
01:22:04,620 --> 01:22:09,320
if you show you that's like we have run
four tests so far all are working fine

3392
01:22:09,320 --> 01:22:09,330
four tests so far all are working fine
 

3393
01:22:09,330 --> 01:22:13,939
four tests so far all are working fine
and it's gonna keep going like that so

3394
01:22:13,939 --> 01:22:13,949
and it's gonna keep going like that so
 

3395
01:22:13,949 --> 01:22:17,229
and it's gonna keep going like that so
that's how I would go about debugging

3396
01:22:17,229 --> 01:22:17,239
that's how I would go about debugging
 

3397
01:22:17,239 --> 01:22:19,729
that's how I would go about debugging
rough implementation and you are all

3398
01:22:19,729 --> 01:22:19,739
rough implementation and you are all
 

3399
01:22:19,739 --> 01:22:22,250
rough implementation and you are all
welcome to come to office hours when you

3400
01:22:22,250 --> 01:22:22,260
welcome to come to office hours when you
 

3401
01:22:22,260 --> 01:22:24,650
welcome to come to office hours when you
need help

